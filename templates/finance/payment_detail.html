{% extends 'management/base.html' %}
{% load static %}

{% block title %}Payment Details - MIU Portal{% endblock %}
{% block meta_description %}View detailed payment information{% endblock %}
{% block meta_keywords %}payment, details, transaction, finance{% endblock %}

{% block content %}
<!-- Page Header -->
<header class="bg-white border-b border-gray-200 sticky top-0 z-10">
    <div class="max-w-12xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
            <div>
                <nav class="flex items-center space-x-2 text-sm text-gray-600 mb-2" aria-label="Breadcrumb">
                    <a href="{% url 'finance:dashboard' %}" class="hover:text-primary-600 transition-colors">Finance</a>
                    <i class="fas fa-chevron-right text-xs" aria-hidden="true"></i>
                    <a href="{% url 'finance:payment_management' %}" class="hover:text-primary-600 transition-colors">Payments</a>
                    <i class="fas fa-chevron-right text-xs" aria-hidden="true"></i>
                    <span class="text-gray-900">{{ payment.payment_reference }}</span>
                </nav>
                <h1 class="text-2xl sm:text-3xl font-bold text-gray-900 font-display">
                    <i class="fas fa-file-invoice-dollar text-primary-600 mr-2" aria-hidden="true"></i>
                    Payment Details
                </h1>
            </div>
            
            <!-- Action Buttons -->
            <div class="flex items-center gap-3">
                <a href="{% url 'finance:payment_management' %}" class="px-4 py-2 bg-white border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors focus:ring-2 focus:ring-gray-400 focus:ring-offset-2">
                    <i class="fas fa-arrow-left mr-2" aria-hidden="true"></i>Back
                </a>
                {% if payment.status == 'success' %}
                <button id="refundBtn" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors focus:ring-2 focus:ring-red-500 focus:ring-offset-2">
                    <i class="fas fa-undo mr-2" aria-hidden="true"></i>Process Refund
                </button>
                {% endif %}
            </div>
        </div>
    </div>
</header>

<!-- Main Content -->
<main class="max-w-12xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    
    <!-- Payment Status Banner -->
    <section class="mb-8">
        {% if payment.status == 'success' %}
        <div class="bg-green-50 border-l-4 border-green-500 rounded-lg p-6">
            <div class="flex items-center">
                <div class="flex-shrink-0">
                    <i class="fas fa-check-circle text-green-600 text-3xl" aria-hidden="true"></i>
                </div>
                <div class="ml-4">
                    <h2 class="text-lg font-semibold text-green-900">Payment Successful</h2>
                    <p class="text-sm text-green-700 mt-1">This payment has been successfully processed and completed.</p>
                </div>
            </div>
        </div>
        {% elif payment.status == 'pending' %}
        <div class="bg-yellow-50 border-l-4 border-yellow-500 rounded-lg p-6">
            <div class="flex items-center">
                <div class="flex-shrink-0">
                    <i class="fas fa-clock text-yellow-600 text-3xl" aria-hidden="true"></i>
                </div>
                <div class="ml-4">
                    <h2 class="text-lg font-semibold text-yellow-900">Payment Pending</h2>
                    <p class="text-sm text-yellow-700 mt-1">This payment is awaiting confirmation or processing.</p>
                </div>
            </div>
        </div>
        {% elif payment.status == 'failed' %}
        <div class="bg-red-50 border-l-4 border-red-500 rounded-lg p-6">
            <div class="flex items-center">
                <div class="flex-shrink-0">
                    <i class="fas fa-times-circle text-red-600 text-3xl" aria-hidden="true"></i>
                </div>
                <div class="ml-4">
                    <h2 class="text-lg font-semibold text-red-900">Payment Failed</h2>
                    <p class="text-sm text-red-700 mt-1">This payment failed to process. {% if payment.failure_reason %}Reason: {{ payment.failure_reason }}{% endif %}</p>
                </div>
            </div>
        </div>
        {% elif payment.status == 'refunded' %}
        <div class="bg-gray-50 border-l-4 border-gray-500 rounded-lg p-6">
            <div class="flex items-center">
                <div class="flex-shrink-0">
                    <i class="fas fa-undo text-gray-600 text-3xl" aria-hidden="true"></i>
                </div>
                <div class="ml-4">
                    <h2 class="text-lg font-semibold text-gray-900">Payment Refunded</h2>
                    <p class="text-sm text-gray-700 mt-1">This payment has been refunded to the customer. {% if payment.failure_reason %}Details: {{ payment.failure_reason }}{% endif %}</p>
                </div>
            </div>
        </div>
        {% endif %}
    </section>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        
        <!-- Main Payment Information -->
        <div class="lg:col-span-2 space-y-8">
            
            <!-- Payment Details Card -->
            <section aria-labelledby="payment-info-heading" class="bg-white rounded-xl shadow-lg overflow-hidden">
                <div class="bg-gradient-to-r from-primary-600 to-primary-700 px-6 py-4">
                    <h2 id="payment-info-heading" class="text-lg font-semibold text-white">
                        <i class="fas fa-info-circle mr-2" aria-hidden="true"></i>Payment Information
                    </h2>
                </div>
                <div class="p-6">
                    <dl class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <dt class="text-sm font-medium text-gray-500">Payment Reference</dt>
                            <dd class="mt-1 text-sm font-mono text-gray-900">{{ payment.payment_reference }}</dd>
                        </div>
                        <div>
                            <dt class="text-sm font-medium text-gray-500">Amount</dt>
                            <dd class="mt-1 text-2xl font-bold text-gray-900">${{ payment.amount|floatformat:2 }} {{ payment.currency }}</dd>
                        </div>
                        <div>
                            <dt class="text-sm font-medium text-gray-500">Payment Method</dt>
                            <dd class="mt-1 text-sm text-gray-900">
                                {% if payment.payment_method == 'card' %}
                                    <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                        <i class="fas fa-credit-card mr-1" aria-hidden="true"></i> Credit/Debit Card
                                    </span>
                                {% elif payment.payment_method == 'paypal' %}
                                    <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-indigo-100 text-indigo-800">
                                        <i class="fab fa-paypal mr-1" aria-hidden="true"></i> PayPal
                                    </span>
                                {% elif payment.payment_method == 'bank_transfer' %}
                                    <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-purple-100 text-purple-800">
                                        <i class="fas fa-university mr-1" aria-hidden="true"></i> Bank Transfer
                                    </span>
                                {% else %}
                                    {{ payment.get_payment_method_display }}
                                {% endif %}
                            </dd>
                        </div>
                        <div>
                            <dt class="text-sm font-medium text-gray-500">Status</dt>
                            <dd class="mt-1 text-sm text-gray-900">
                                {% if payment.status == 'success' %}
                                    <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                        <i class="fas fa-check-circle mr-1" aria-hidden="true"></i> Success
                                    </span>
                                {% elif payment.status == 'pending' %}
                                    <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">
                                        <i class="fas fa-clock mr-1" aria-hidden="true"></i> Pending
                                    </span>
                                {% elif payment.status == 'processing' %}
                                    <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                        <i class="fas fa-spinner mr-1" aria-hidden="true"></i> Processing
                                    </span>
                                {% elif payment.status == 'failed' %}
                                    <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-red-100 text-red-800">
                                        <i class="fas fa-times-circle mr-1" aria-hidden="true"></i> Failed
                                    </span>
                                {% elif payment.status == 'refunded' %}
                                    <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                                        <i class="fas fa-undo mr-1" aria-hidden="true"></i> Refunded
                                    </span>
                                {% endif %}
                            </dd>
                        </div>
                        <div>
                            <dt class="text-sm font-medium text-gray-500">Transaction Date</dt>
                            <dd class="mt-1 text-sm text-gray-900">{{ payment.created_at|date:"F d, Y" }} at {{ payment.created_at|date:"g:i A" }}</dd>
                        </div>
                        <div>
                            <dt class="text-sm font-medium text-gray-500">Last Updated</dt>
                            <dd class="mt-1 text-sm text-gray-900">{{ payment.updated_at|date:"F d, Y" }} at {{ payment.updated_at|date:"g:i A" }}</dd>
                        </div>
                        {% if payment.failure_reason %}
                        <div class="md:col-span-2">
                            <dt class="text-sm font-medium text-gray-500">Failure/Refund Reason</dt>
                            <dd class="mt-1 text-sm text-gray-900 bg-gray-50 p-3 rounded-lg">{{ payment.failure_reason }}</dd>
                        </div>
                        {% endif %}
                    </dl>
                </div>
            </section>

            <!-- Application Details Card -->
            {% if payment.application %}
            <section aria-labelledby="application-info-heading" class="bg-white rounded-xl shadow-lg overflow-hidden">
                <div class="bg-gradient-to-r from-blue-600 to-blue-700 px-6 py-4">
                    <h2 id="application-info-heading" class="text-lg font-semibold text-white">
                        <i class="fas fa-graduation-cap mr-2" aria-hidden="true"></i>Application Details
                    </h2>
                </div>
                <div class="p-6">
                    <dl class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <dt class="text-sm font-medium text-gray-500">Application ID</dt>
                            <dd class="mt-1 text-sm font-mono text-gray-900">#{{ payment.application.id }}</dd>
                        </div>
                        <div>
                            <dt class="text-sm font-medium text-gray-500">Application Status</dt>
                            <dd class="mt-1 text-sm text-gray-900">
                                <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                    {{ payment.application.get_status_display }}
                                </span>
                            </dd>
                        </div>
                        {% if payment.application.course %}
                        <div class="md:col-span-2">
                            <dt class="text-sm font-medium text-gray-500">Course</dt>
                            <dd class="mt-1 text-sm font-semibold text-gray-900">{{ payment.application.course.name }}</dd>
                        </div>
                        {% endif %}
                        <div>
                            <dt class="text-sm font-medium text-gray-500">Application Date</dt>
                            <dd class="mt-1 text-sm text-gray-900">{{ payment.application.created_at|date:"F d, Y" }}</dd>
                        </div>
                    </dl>
                </div>
            </section>
            {% endif %}

        </div>

        <!-- Sidebar -->
        <div class="lg:col-span-1 space-y-8">
            
            <!-- User Information Card -->
            {% if payment.application and payment.application.user %}
            <section aria-labelledby="user-info-heading" class="bg-white rounded-xl shadow-lg overflow-hidden">
                <div class="bg-gradient-to-r from-purple-600 to-purple-700 px-6 py-4">
                    <h2 id="user-info-heading" class="text-lg font-semibold text-white">
                        <i class="fas fa-user mr-2" aria-hidden="true"></i>User Information
                    </h2>
                </div>
                <div class="p-6">
                    <div class="flex flex-col items-center text-center mb-6">
                        <div class="h-20 w-20 bg-gradient-to-br from-primary-500 to-primary-600 rounded-full flex items-center justify-center mb-3">
                            <span class="text-white text-2xl font-bold">
                                {{ payment.application.user.first_name.0|default:'U' }}{{ payment.application.user.last_name.0|default:'' }}
                            </span>
                        </div>
                        <h3 class="text-lg font-semibold text-gray-900">{{ payment.application.user.get_full_name|default:payment.application.user.username }}</h3>
                        <p class="text-sm text-gray-600">@{{ payment.application.user.username }}</p>
                    </div>
                    <dl class="space-y-4">
                        <div>
                            <dt class="text-sm font-medium text-gray-500">Email</dt>
                            <dd class="mt-1 text-sm text-gray-900">
                                <a href="mailto:{{ payment.application.user.email }}" class="text-primary-600 hover:text-primary-700 transition-colors">
                                    {{ payment.application.user.email }}
                                </a>
                            </dd>
                        </div>
                        {% if payment.application.user.profile.phone_number %}
                        <div>
                            <dt class="text-sm font-medium text-gray-500">Phone</dt>
                            <dd class="mt-1 text-sm text-gray-900">{{ payment.application.user.profile.phone_number }}</dd>
                        </div>
                        {% endif %}
                        <div>
                            <dt class="text-sm font-medium text-gray-500">User Since</dt>
                            <dd class="mt-1 text-sm text-gray-900">{{ payment.application.user.date_joined|date:"F Y" }}</dd>
                        </div>
                    </dl>
                </div>
            </section>
            {% endif %}

            <!-- Quick Actions Card -->
            <section aria-labelledby="actions-heading" class="bg-white rounded-xl shadow-lg overflow-hidden">
                <div class="bg-gradient-to-r from-gray-600 to-gray-700 px-6 py-4">
                    <h2 id="actions-heading" class="text-lg font-semibold text-white">
                        <i class="fas fa-bolt mr-2" aria-hidden="true"></i>Quick Actions
                    </h2>
                </div>
                <div class="p-6 space-y-3">
                    <a href="{% url 'finance:payment_management' %}" class="block w-full px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-800 rounded-lg text-center transition-colors">
                        <i class="fas fa-list mr-2" aria-hidden="true"></i>View All Payments
                    </a>
                    {% if payment.application and payment.application.user %}
                    <button class="block w-full px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-800 rounded-lg text-center transition-colors">
                        <i class="fas fa-envelope mr-2" aria-hidden="true"></i>Email User
                    </button>
                    {% endif %}
                    <button class="block w-full px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-800 rounded-lg text-center transition-colors">
                        <i class="fas fa-print mr-2" aria-hidden="true"></i>Print Receipt
                    </button>
                </div>
            </section>

        </div>

    </div>

</main>

<!-- Refund Modal -->
<div id="refundModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-xl shadow-2xl max-w-md w-full overflow-hidden">
        <div class="bg-gradient-to-r from-red-600 to-red-700 px-6 py-4">
            <div class="flex items-center justify-between">
                <h3 class="text-lg font-semibold text-white">
                    <i class="fas fa-undo mr-2" aria-hidden="true"></i>Process Refund
                </h3>
                <button id="closeRefundModal" class="text-white hover:text-gray-200 transition-colors">
                    <i class="fas fa-times" aria-hidden="true"></i>
                </button>
            </div>
        </div>
        <form method="post" class="p-6">
            {% csrf_token %}
            
            <div class="mb-6">
                <p class="text-gray-700 mb-4">Are you sure you want to refund this payment of <strong>${{ payment.amount|floatformat:2 }}</strong>?</p>
                
                <div class="mb-4">
                    <label for="{{ refund_form.reason.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">Refund Reason *</label>
                    {{ refund_form.reason }}
                </div>
                
                <div class="mb-4">
                    <label for="{{ refund_form.notes.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">Additional Notes</label>
                    {{ refund_form.notes }}
                </div>
            </div>

            <div class="flex gap-3">
                <button type="button" id="cancelRefund" class="flex-1 px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition-colors">
                    Cancel
                </button>
                <button type="submit" class="flex-1 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors">
                    <i class="fas fa-undo mr-2" aria-hidden="true"></i>Confirm Refund
                </button>
            </div>
        </form>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
// Refund Modal Functionality
const refundBtn = document.getElementById('refundBtn');
const refundModal = document.getElementById('refundModal');
const closeRefundModal = document.getElementById('closeRefundModal');
const cancelRefund = document.getElementById('cancelRefund');

if (refundBtn) {
    refundBtn.addEventListener('click', () => {
        refundModal.classList.remove('hidden');
    });
}

if (closeRefundModal) {
    closeRefundModal.addEventListener('click', () => {
        refundModal.classList.add('hidden');
    });
}

if (cancelRefund) {
    cancelRefund.addEventListener('click', () => {
        refundModal.classList.add('hidden');
    });
}

// Close modal on outside click
refundModal?.addEventListener('click', (e) => {
    if (e.target === refundModal) {
        refundModal.classList.add('hidden');
    }
});

// Print functionality
document.querySelectorAll('[class*="fa-print"]').forEach(btn => {
    btn.closest('button')?.addEventListener('click', () => {
        window.print();
    });
});
</script>
{% endblock %}