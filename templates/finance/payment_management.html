{% extends 'management/base.html' %}
{% load static %}

{% block title %}Payment Management - Finance Portal{% endblock %}
{% block meta_description %}
Manage and track all payment transactions in the finance portal
{% endblock %}
{% block meta_keywords %}
payments, transactions, finance, management, revenue, billing
{% endblock %}

{% block content %}
<!-- Page Header -->
<header class="bg-white border-b border-gray-200 sticky top-0 z-10 shadow-sm">
    <div class="max-w-full mx-auto px-4 sm:px-6 lg:px-8 py-4">
        <div class="flex flex-col sm:flex-row sm:items-center 
                    sm:justify-between gap-4">
            <div>
                <h1 class="text-2xl sm:text-3xl font-bold text-gray-900 
                           font-display flex items-center">
                    <i class="fas fa-credit-card text-primary-600 mr-3" 
                       aria-hidden="true"></i>
                    Payment Management
                </h1>
                <p class="mt-1 text-sm text-gray-600">
                    Track and manage all payment transactions
                </p>
            </div>
            
            <!-- Action Buttons -->
            <div class="flex items-center gap-3">
                <a href="{% url 'finance:dashboard' %}" 
                   class="px-4 py-2 bg-white border border-gray-300 
                          text-gray-700 rounded-lg hover:bg-gray-50 
                          transition-colors focus:ring-2 
                          focus:ring-primary-500 focus:ring-offset-2
                          inline-flex items-center font-medium" 
                   aria-label="Back to dashboard">
                    <i class="fas fa-arrow-left mr-2" 
                       aria-hidden="true"></i>
                    Dashboard
                </a>
            </div>
        </div>
    </div>
</header>

<!-- Main Content -->
<main class="max-w-full mx-auto px-4 sm:px-6 lg:px-8 py-8 space-y-8">
    
    <!-- Stats Cards -->
    <section aria-labelledby="payment-stats-heading">
        <h2 id="payment-stats-heading" class="sr-only">
            Payment Statistics
        </h2>
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-6">
            
            <!-- Total Payments -->
            <article class="bg-white rounded-xl shadow-lg p-6 
                           border-l-4 border-blue-500 
                           hover:shadow-xl transition-shadow duration-200">
                <div class="flex items-center justify-between">
                    <div class="flex-1">
                        <p class="text-gray-600 text-xs font-medium 
                                  uppercase tracking-wide mb-1">
                            Total Payments
                        </p>
                        <p class="text-2xl font-bold text-gray-900 mt-1">
                            {{ total_payments|default:0 }}
                        </p>
                        <p class="text-xs text-gray-500 mt-1">
                            All transactions
                        </p>
                    </div>
                    <div class="bg-blue-100 rounded-lg p-3 flex-shrink-0">
                        <i class="fas fa-receipt text-blue-600 text-xl" 
                           aria-hidden="true"></i>
                    </div>
                </div>
            </article>

            <!-- Completed -->
            <article class="bg-white rounded-xl shadow-lg p-6 
                           border-l-4 border-green-500 
                           hover:shadow-xl transition-shadow duration-200">
                <div class="flex items-center justify-between">
                    <div class="flex-1">
                        <p class="text-gray-600 text-xs font-medium 
                                  uppercase tracking-wide mb-1">
                            Completed
                        </p>
                        <p class="text-2xl font-bold text-green-600 mt-1">
                            {{ completed_payments|default:0 }}
                        </p>
                        <p class="text-xs text-gray-500 mt-1">
                            Successful payments
                        </p>
                    </div>
                    <div class="bg-green-100 rounded-lg p-3 flex-shrink-0">
                        <i class="fas fa-check-circle text-green-600 text-xl" 
                           aria-hidden="true"></i>
                    </div>
                </div>
            </article>

            <!-- Pending -->
            <article class="bg-white rounded-xl shadow-lg p-6 
                           border-l-4 border-yellow-500 
                           hover:shadow-xl transition-shadow duration-200">
                <div class="flex items-center justify-between">
                    <div class="flex-1">
                        <p class="text-gray-600 text-xs font-medium 
                                  uppercase tracking-wide mb-1">
                            Pending
                        </p>
                        <p class="text-2xl font-bold text-yellow-600 mt-1">
                            {{ pending_payments|default:0 }}
                        </p>
                        <p class="text-xs text-gray-500 mt-1">
                            Awaiting confirmation
                        </p>
                    </div>
                    <div class="bg-yellow-100 rounded-lg p-3 flex-shrink-0">
                        <i class="fas fa-clock text-yellow-600 text-xl" 
                           aria-hidden="true"></i>
                    </div>
                </div>
            </article>

            <!-- Failed -->
            <article class="bg-white rounded-xl shadow-lg p-6 
                           border-l-4 border-red-500 
                           hover:shadow-xl transition-shadow duration-200">
                <div class="flex items-center justify-between">
                    <div class="flex-1">
                        <p class="text-gray-600 text-xs font-medium 
                                  uppercase tracking-wide mb-1">
                            Failed
                        </p>
                        <p class="text-2xl font-bold text-red-600 mt-1">
                            {{ failed_payments|default:0 }}
                        </p>
                        <p class="text-xs text-gray-500 mt-1">
                            Unsuccessful attempts
                        </p>
                    </div>
                    <div class="bg-red-100 rounded-lg p-3 flex-shrink-0">
                        <i class="fas fa-times-circle text-red-600 text-xl" 
                           aria-hidden="true"></i>
                    </div>
                </div>
            </article>

            <!-- Total Amount -->
            <article class="bg-gradient-to-br from-purple-500 
                           to-purple-600 rounded-xl shadow-lg p-6 
                           text-white hover:shadow-xl 
                           transition-shadow duration-200">
                <div class="flex items-center justify-between">
                    <div class="flex-1">
                        <p class="text-purple-100 text-xs font-medium 
                                  uppercase tracking-wide mb-1">
                            Total Revenue
                        </p>
                        <p class="text-2xl font-bold mt-1">
                            ${{ total_amount|floatformat:2|default:"0.00" }}
                        </p>
                        <p class="text-xs text-purple-100 mt-1">
                            Completed only
                        </p>
                    </div>
                    <div class="bg-white/20 rounded-lg p-3 flex-shrink-0">
                        <i class="fas fa-dollar-sign text-xl" 
                           aria-hidden="true"></i>
                    </div>
                </div>
            </article>

        </div>
    </section>

    <!-- Filters Section -->
    <section aria-labelledby="filters-heading" 
             class="bg-white rounded-xl shadow-sm 
                    border border-gray-100 p-6">
        <h2 id="filters-heading" 
            class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
            <i class="fas fa-filter text-primary-600 mr-2" 
               aria-hidden="true"></i>
            Filter Payments
        </h2>
        <form method="get" 
              id="filterForm" 
              action="{% url 'finance:payment_management' %}" 
              class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4">
            
            <!-- Status Filter -->
            <div>
                <label for="{{ filter_form.status.id_for_label }}" 
                       class="block text-sm font-medium text-gray-700 mb-2">
                    Status
                </label>
                {{ filter_form.status }}
            </div>

            <!-- Payment Method Filter -->
            <div>
                <label for="{{ filter_form.payment_method.id_for_label }}" 
                       class="block text-sm font-medium text-gray-700 mb-2">
                    Payment Method
                </label>
                {{ filter_form.payment_method }}
            </div>

            <!-- Date From -->
            <div>
                <label for="{{ filter_form.date_from.id_for_label }}" 
                       class="block text-sm font-medium text-gray-700 mb-2">
                    Date From
                </label>
                {{ filter_form.date_from }}
            </div>

            <!-- Date To -->
            <div>
                <label for="{{ filter_form.date_to.id_for_label }}" 
                       class="block text-sm font-medium text-gray-700 mb-2">
                    Date To
                </label>
                {{ filter_form.date_to }}
            </div>

            <!-- Search -->
            <div>
                <label for="{{ filter_form.search.id_for_label }}" 
                       class="block text-sm font-medium text-gray-700 mb-2">
                    Search
                </label>
                {{ filter_form.search }}
            </div>

            <!-- Filter Buttons -->
            <div class="md:col-span-2 lg:col-span-5 
                        flex flex-wrap gap-3 pt-2">
                <button type="submit" 
                        class="px-6 py-2.5 bg-primary-600 text-white 
                               rounded-lg hover:bg-primary-700 
                               transition-colors focus:ring-2 
                               focus:ring-primary-500 focus:ring-offset-2
                               font-medium inline-flex items-center">
                    <i class="fas fa-search mr-2" 
                       aria-hidden="true"></i>
                    Apply Filters
                </button>
                <a href="{% url 'finance:payment_management' %}" 
                   class="px-6 py-2.5 bg-gray-200 text-gray-700 
                          rounded-lg hover:bg-gray-300 transition-colors 
                          focus:ring-2 focus:ring-gray-400 
                          focus:ring-offset-2 font-medium 
                          inline-flex items-center">
                    <i class="fas fa-redo mr-2" 
                       aria-hidden="true"></i>
                    Reset Filters
                </a>
            </div>
        </form>
    </section>

    <!-- Payments Table -->
    <section aria-labelledby="payments-table-heading" 
             class="bg-white rounded-xl shadow-sm 
                    border border-gray-100 overflow-hidden">
        <div class="p-6 border-b border-gray-200">
            <h2 id="payments-table-heading" 
                class="text-lg font-semibold text-gray-900 flex items-center">
                <i class="fas fa-list text-primary-600 mr-2" 
                   aria-hidden="true"></i>
                Payment Transactions
            </h2>
        </div>
        <div class="overflow-x-auto p-6">
            <table id="paymentsTable" 
                   class="min-w-full divide-y divide-gray-200" 
                   style="width:100%"
                   role="table"
                   aria-label="Payment transactions table">
                <thead class="bg-gray-50">
                    <tr>
                        <th scope="col" 
                            class="px-6 py-3 text-left text-xs font-medium 
                                   text-gray-500 uppercase tracking-wider">
                            Reference
                        </th>
                        <th scope="col" 
                            class="px-6 py-3 text-left text-xs font-medium 
                                   text-gray-500 uppercase tracking-wider">
                            User
                        </th>
                        <th scope="col" 
                            class="px-6 py-3 text-left text-xs font-medium 
                                   text-gray-500 uppercase tracking-wider">
                            Course
                        </th>
                        <th scope="col" 
                            class="px-6 py-3 text-left text-xs font-medium 
                                   text-gray-500 uppercase tracking-wider">
                            Amount
                        </th>
                        <th scope="col" 
                            class="px-6 py-3 text-left text-xs font-medium 
                                   text-gray-500 uppercase tracking-wider">
                            Method
                        </th>
                        <th scope="col" 
                            class="px-6 py-3 text-left text-xs font-medium 
                                   text-gray-500 uppercase tracking-wider">
                            Status
                        </th>
                        <th scope="col" 
                            class="px-6 py-3 text-left text-xs font-medium 
                                   text-gray-500 uppercase tracking-wider">
                            Date
                        </th>
                        <th scope="col" 
                            class="px-6 py-3 text-left text-xs font-medium 
                                   text-gray-500 uppercase tracking-wider">
                            Actions
                        </th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    {% for payment in payments %}
                    <tr class="hover:bg-gray-50 transition-colors duration-150">
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm font-mono font-medium 
                                       text-primary-600">
                                {{ payment.payment_reference }}
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            {% if payment.application and payment.application.user %}
                            <div class="flex items-center">
                                <div class="flex-shrink-0 h-10 w-10">
                                    <div class="h-10 w-10 rounded-full 
                                               bg-primary-100 flex 
                                               items-center justify-center">
                                        <span class="text-primary-600 
                                                    font-semibold text-sm">
                                            {% if payment.application.user.first_name %}
                                                {{ payment.application.user.first_name.0 }}{{ payment.application.user.last_name.0|default:'' }}
                                            {% else %}
                                                {{ payment.application.user.username.0 }}
                                            {% endif %}
                                        </span>
                                    </div>
                                </div>
                                <div class="ml-4">
                                    <div class="text-sm font-medium 
                                               text-gray-900">
                                        {{ payment.application.user.get_full_name|default:payment.application.user.username }}
                                    </div>
                                    <div class="text-sm text-gray-500">
                                        {{ payment.application.user.email }}
                                    </div>
                                </div>
                            </div>
                            {% else %}
                            <div class="text-sm text-gray-500 italic">
                                No user data
                            </div>
                            {% endif %}
                        </td>
                        <td class="px-6 py-4">
                            {% if payment.application and payment.application.course %}
                            <div class="text-sm text-gray-900 max-w-xs 
                                       truncate" 
                                 title="{{ payment.application.course.name }}">
                                {{ payment.application.course.name }}
                            </div>
                            <div class="text-xs text-gray-500">
                                App ID: {{ payment.application.application_id }}
                            </div>
                            {% else %}
                            <div class="text-sm text-gray-500 italic">
                                No course data
                            </div>
                            {% endif %}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm font-semibold text-gray-900">
                                ${{ payment.amount|floatformat:2 }}
                            </div>
                            <div class="text-xs text-gray-500">
                                {{ payment.currency|default:"USD" }}
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            {% if payment.payment_method == 'card' %}
                                <span class="inline-flex items-center 
                                           px-2.5 py-0.5 rounded-full 
                                           text-xs font-medium 
                                           bg-blue-100 text-blue-800">
                                    <i class="fas fa-credit-card mr-1" 
                                       aria-hidden="true"></i>
                                    Card
                                </span>
                            {% elif payment.payment_method == 'paypal' %}
                                <span class="inline-flex items-center 
                                           px-2.5 py-0.5 rounded-full 
                                           text-xs font-medium 
                                           bg-indigo-100 text-indigo-800">
                                    <i class="fab fa-paypal mr-1" 
                                       aria-hidden="true"></i>
                                    PayPal
                                </span>
                            {% elif payment.payment_method == 'bank_transfer' %}
                                <span class="inline-flex items-center 
                                           px-2.5 py-0.5 rounded-full 
                                           text-xs font-medium 
                                           bg-purple-100 text-purple-800">
                                    <i class="fas fa-university mr-1" 
                                       aria-hidden="true"></i>
                                    Bank
                                </span>
                            {% else %}
                                <span class="inline-flex items-center 
                                           px-2.5 py-0.5 rounded-full 
                                           text-xs font-medium 
                                           bg-gray-100 text-gray-800">
                                    {{ payment.get_payment_method_display }}
                                </span>
                            {% endif %}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            {% if payment.status == 'success' %}
                                <span class="inline-flex items-center 
                                           px-2.5 py-0.5 rounded-full 
                                           text-xs font-medium 
                                           bg-green-100 text-green-800">
                                    <i class="fas fa-check-circle mr-1" 
                                       aria-hidden="true"></i>
                                    Success
                                </span>
                            {% elif payment.status == 'pending' %}
                                <span class="inline-flex items-center 
                                           px-2.5 py-0.5 rounded-full 
                                           text-xs font-medium 
                                           bg-yellow-100 text-yellow-800">
                                    <i class="fas fa-clock mr-1" 
                                       aria-hidden="true"></i>
                                    Pending
                                </span>
                            {% elif payment.status == 'processing' %}
                                <span class="inline-flex items-center 
                                           px-2.5 py-0.5 rounded-full 
                                           text-xs font-medium 
                                           bg-blue-100 text-blue-800">
                                    <i class="fas fa-spinner mr-1" 
                                       aria-hidden="true"></i>
                                    Processing
                                </span>
                            {% elif payment.status == 'failed' %}
                                <span class="inline-flex items-center 
                                           px-2.5 py-0.5 rounded-full 
                                           text-xs font-medium 
                                           bg-red-100 text-red-800">
                                    <i class="fas fa-times-circle mr-1" 
                                       aria-hidden="true"></i>
                                    Failed
                                </span>
                            {% elif payment.status == 'refunded' %}
                                <span class="inline-flex items-center 
                                           px-2.5 py-0.5 rounded-full 
                                           text-xs font-medium 
                                           bg-gray-100 text-gray-800">
                                    <i class="fas fa-undo mr-1" 
                                       aria-hidden="true"></i>
                                    Refunded
                                </span>
                            {% else %}
                                <span class="inline-flex items-center 
                                           px-2.5 py-0.5 rounded-full 
                                           text-xs font-medium 
                                           bg-gray-100 text-gray-800">
                                    {{ payment.get_status_display }}
                                </span>
                            {% endif %}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm text-gray-900">
                                {{ payment.created_at|date:"M d, Y" }}
                            </div>
                            <div class="text-xs text-gray-500">
                                {{ payment.created_at|date:"g:i A" }}
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm">
                            <a href="{% url 'finance:payment_detail' payment.payment_reference %}" 
                               class="text-primary-600 hover:text-primary-900 
                                      font-medium transition-colors 
                                      inline-flex items-center"
                               aria-label="View details for payment {{ payment.payment_reference }}">
                                <i class="fas fa-eye mr-1" 
                                   aria-hidden="true"></i>
                                View
                            </a>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="8" class="px-6 py-12 text-center">
                            <div class="text-gray-400">
                                <i class="fas fa-inbox text-4xl mb-3 block" 
                                   aria-hidden="true"></i>
                                <p class="text-lg font-medium">
                                    No payments found
                                </p>
                                <p class="text-sm mt-1">
                                    Try adjusting your filters or search criteria
                                </p>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </section>

</main>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // Initialize DataTable
    const table = $('#paymentsTable').DataTable({
        dom: 'Bfrtip',
        buttons: [
            {
                extend: 'excel',
                text: '<i class="fas fa-file-excel mr-2"></i>Excel',
                className: 'dt-button-excel',
                exportOptions: {
                    columns: ':not(:last-child)'
                },
                title: 'Payment Transactions - ' + 
                       new Date().toLocaleDateString()
            },
            {
                extend: 'csv',
                text: '<i class="fas fa-file-csv mr-2"></i>CSV',
                className: 'dt-button-csv',
                exportOptions: {
                    columns: ':not(:last-child)'
                },
                title: 'Payment Transactions - ' + 
                       new Date().toLocaleDateString()
            },
            {
                extend: 'pdf',
                text: '<i class="fas fa-file-pdf mr-2"></i>PDF',
                className: 'dt-button-pdf',
                exportOptions: {
                    columns: ':not(:last-child)'
                },
                title: 'Payment Transactions',
                orientation: 'landscape',
                pageSize: 'A4'
            },
            {
                extend: 'print',
                text: '<i class="fas fa-print mr-2"></i>Print',
                className: 'dt-button-print',
                exportOptions: {
                    columns: ':not(:last-child)'
                },
                title: 'Payment Transactions'
            }
        ],
        responsive: true,
        pageLength: 25,
        order: [[6, 'desc']],
        language: {
            search: "_INPUT_",
            searchPlaceholder: "Search payments...",
            lengthMenu: "Show _MENU_ entries per page",
            info: "Showing _START_ to _END_ of _TOTAL_ payments",
            infoEmpty: "No payments to display",
            infoFiltered: "(filtered from _MAX_ total payments)",
            emptyTable: "No payment data available",
            zeroRecords: "No matching payments found",
            paginate: {
                first: "First",
                last: "Last",
                next: "Next",
                previous: "Previous"
            }
        },
        columnDefs: [
            { orderable: false, targets: 7 }
        ]
    });

    // Export button

    // Button styling
    $('.dt-buttons').addClass('flex flex-wrap gap-2 mb-4');
    $('.dt-button').addClass(
        'px-4 py-2 bg-white border border-gray-300 text-gray-700 ' +
        'rounded-lg hover:bg-gray-50 transition-colors text-sm ' +
        'font-medium focus:ring-2 focus:ring-primary-500 ' +
        'focus:ring-offset-1'
    );
});
</script>

<style>
/* DataTables Styling */
.dataTables_wrapper .dataTables_length,
.dataTables_wrapper .dataTables_filter,
.dataTables_wrapper .dataTables_info,
.dataTables_wrapper .dataTables_paginate {
    padding: 0.5rem 0;
}

.dataTables_wrapper .dataTables_length select {
    @apply form-select rounded-lg border-gray-300 
           focus:ring-2 focus:ring-primary-500 
           focus:border-primary-500 text-sm px-3 py-2;
}

.dataTables_wrapper .dataTables_filter input {
    @apply form-input rounded-lg border-gray-300 
           focus:ring-2 focus:ring-primary-500 
           focus:border-primary-500 ml-2 text-sm px-3 py-2;
}

.dataTables_wrapper .dataTables_info {
    @apply text-sm text-gray-700;
}

.dataTables_wrapper .dataTables_paginate {
    @apply flex items-center gap-1;
}

.dataTables_wrapper .dataTables_paginate .paginate_button {
    @apply px-3 py-2 border border-gray-300 bg-white 
           text-gray-700 hover:bg-gray-50 rounded-md 
           transition-colors text-sm font-medium;
}

.dataTables_wrapper .dataTables_paginate .paginate_button.current {
    @apply bg-primary-600 text-white border-primary-600 
           hover:bg-primary-700;
}

.dataTables_wrapper .dataTables_paginate .paginate_button.disabled {
    @apply opacity-50 cursor-not-allowed hover:bg-white;
}

.dt-buttons {
    margin-bottom: 1rem !important;
}

@media (max-width: 640px) {
    .dataTables_wrapper .dataTables_length,
    .dataTables_wrapper .dataTables_filter {
        padding: 0.5rem 0;
    }
    
    .dt-buttons {
        flex-direction: column;
        width: 100%;
    }
    
    .dt-button {
        width: 100%;
        justify-content: center;
    }
}
</style>
{% endblock %}