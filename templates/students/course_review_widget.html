{% if enrollment %}
<div class="mt-8 bg-white rounded-xl shadow-sm border border-gray-200 p-6">
    <h2 class="text-lg font-bold text-gray-900 mb-1">
        {% if existing_review %}Update Your Review{% else %}Rate This Course{% endif %}
    </h2>
    <p class="text-sm text-gray-500 mb-5">
        Share your experience to help other students.
    </p>

    <form method="post" action="{% url 'students:submit_review' course.slug %}" novalidate>
        {% csrf_token %}

        <!-- Star rating -->
        <div class="mb-5">
            <p class="text-sm font-medium text-gray-700 mb-2">Rating <span class="text-red-500">*</span></p>
            <div class="flex items-center gap-1" id="starRating">
                {% for i in "12345" %}
                <button type="button"
                        data-value="{{ i }}"
                        onclick="setRating({{ i }})"
                        class="star-btn text-3xl text-gray-300 hover:text-yellow-400 transition-colors
                               focus:outline-none"
                        aria-label="{{ i }} star{% if i != '1' %}s{% endif %}">
                    <i class="fas fa-star"></i>
                </button>
                {% endfor %}
            </div>
            <input type="hidden" name="rating" id="ratingInput"
                   value="{% if existing_review %}{{ existing_review.rating }}{% else %}0{% endif %}">
            <p class="text-xs text-gray-400 mt-1" id="ratingLabel">
                {% if existing_review %}
                    Your current rating: {{ existing_review.rating }}/5
                {% else %}
                    Click a star to rate
                {% endif %}
            </p>
        </div>

        <!-- Review text -->
        <div class="mb-5">
            <label for="review_text" class="block text-sm font-medium text-gray-700 mb-1.5">
                Review <span class="text-gray-400 font-normal">(optional)</span>
            </label>
            <textarea name="review_text" id="review_text" rows="4"
                      placeholder="What did you like or dislike? What could be improved?"
                      class="w-full px-4 py-3 border border-gray-300 rounded-lg text-sm
                             focus:ring-2 focus:ring-primary-500 focus:border-transparent resize-none"
            >{% if existing_review %}{{ existing_review.review_text }}{% endif %}</textarea>
        </div>

        <button type="submit"
                class="px-6 py-2.5 bg-primary-600 text-white rounded-lg hover:bg-primary-700
                       font-semibold text-sm transition-all focus:outline-none
                       focus:ring-2 focus:ring-offset-2 focus:ring-primary-500">
            {% if existing_review %}
            <i class="fas fa-sync mr-2"></i>Update Review
            {% else %}
            <i class="fas fa-star mr-2"></i>Submit Review
            {% endif %}
        </button>
    </form>
</div>

<script>
(function() {
    var labels = ['', 'Poor', 'Fair', 'Good', 'Very Good', 'Excellent'];
    var current = parseInt(document.getElementById('ratingInput').value) || 0;

    function renderStars(value) {
        document.querySelectorAll('.star-btn').forEach(function(btn) {
            var v = parseInt(btn.dataset.value);
            var icon = btn.querySelector('i');
            if (v <= value) {
                icon.classList.remove('text-gray-300');
                icon.classList.add('text-yellow-400');
            } else {
                icon.classList.remove('text-yellow-400');
                icon.classList.add('text-gray-300');
            }
        });
        var lbl = document.getElementById('ratingLabel');
        if (value > 0) {
            lbl.textContent = value + '/5 â€“ ' + labels[value];
        } else {
            lbl.textContent = 'Click a star to rate';
        }
    }

    window.setRating = function(value) {
        current = value;
        document.getElementById('ratingInput').value = value;
        renderStars(value);
    };

    // Hover preview
    document.querySelectorAll('.star-btn').forEach(function(btn) {
        btn.addEventListener('mouseenter', function() {
            renderStars(parseInt(btn.dataset.value));
        });
        btn.addEventListener('mouseleave', function() {
            renderStars(current);
        });
    });

    renderStars(current);
})();
</script>
{% endif %}