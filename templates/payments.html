<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Complete Your Application Payment</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Stripe.js -->
    <script src="https://js.stripe.com/v3/"></script>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-6xl">
        <!-- Header -->
        <header class="mb-8">
            <h1 class="text-3xl font-bold text-gray-800">Complete Your Application</h1>
            <p class="text-gray-600">Final step: Secure payment processing</p>
        </header>

        <div class="flex flex-col lg:flex-row gap-8">
            <!-- Left Column: Payment Form -->
            <div class="lg:w-2/3">
                <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                    <div class="flex items-center mb-6">
                        <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center mr-4">
                            <i class="fas fa-lock text-blue-600"></i>
                        </div>
                        <div>
                            <h2 class="text-xl font-semibold text-gray-800">Secure Payment Details</h2>
                            <p class="text-gray-600 text-sm">All transactions are encrypted and secure</p>
                        </div>
                    </div>

                    <!-- Payment Form -->
                    <form id="payment-form" class="space-y-6">
                        <!-- Card Number -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Card Number
                            </label>
                            <div class="relative">
                                <input type="text"
                                       id="card-number"
                                       name="card-number"
                                       maxlength="19"
                                       placeholder="1234 5678 9012 3456"
                                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
                                       autocomplete="cc-number" />
                                <div class="absolute right-3 top-3">
                                    <div class="flex space-x-2">
                                        <i class="fab fa-cc-visa text-blue-600"></i>
                                        <i class="fab fa-cc-mastercard text-red-600"></i>
                                        <i class="fab fa-cc-amex text-blue-500"></i>
                                        <i class="fab fa-cc-discover text-orange-600"></i>
                                    </div>
                                </div>
                            </div>
                            <div id="card-number-error" class="text-red-500 text-sm mt-1 hidden"></div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <!-- Expiry Date -->
                            <div class="md:col-span-2">
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    Expiry Date
                                </label>
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <select id="expiry-month"
                                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors">
                                            <option value="">Month</option>
                                            <option value="01">01 - January</option>
                                            <option value="02">02 - February</option>
                                            <option value="03">03 - March</option>
                                            <option value="04">04 - April</option>
                                            <option value="05">05 - May</option>
                                            <option value="06">06 - June</option>
                                            <option value="07">07 - July</option>
                                            <option value="08">08 - August</option>
                                            <option value="09">09 - September</option>
                                            <option value="10">10 - October</option>
                                            <option value="11">11 - November</option>
                                            <option value="12">12 - December</option>
                                        </select>
                                    </div>
                                    <div>
                                        <select id="expiry-year"
                                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors">
                                            <option value="">Year</option>
                                        </select>
                                    </div>
                                </div>
                                <div id="expiry-error" class="text-red-500 text-sm mt-1 hidden"></div>
                            </div>

                            <!-- CVC -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    CVC
                                    <span class="text-gray-400 text-xs">(3 or 4 digits)</span>
                                </label>
                                <div class="relative">
                                    <input type="text"
                                           id="cvc"
                                           name="cvc"
                                           maxlength="4"
                                           placeholder="123"
                                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
                                           autocomplete="cc-csc" />
                                    <div class="absolute right-3 top-3">
                                        <i class="fas fa-question-circle text-gray-400"
                                           title="3-digit code on back of card, 4-digit on front for Amex"></i>
                                    </div>
                                </div>
                                <div id="cvc-error" class="text-red-500 text-sm mt-1 hidden"></div>
                            </div>
                        </div>

                        <!-- Cardholder Name -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Cardholder Name
                            </label>
                            <input type="text"
                                   id="cardholder-name"
                                   name="cardholder-name"
                                   placeholder="John Doe"
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
                                   autocomplete="cc-name" />
                            <div id="cardholder-error" class="text-red-500 text-sm mt-1 hidden"></div>
                        </div>

                        <!-- Terms and Conditions -->
                        <div class="flex items-start">
                            <input type="checkbox"
                                   id="terms"
                                   name="terms"
                                   class="mt-1 mr-3 h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded" />
                            <label for="terms" class="text-sm text-gray-600">
                                I authorize this charge and agree to the
                                <a href="#" class="text-blue-600 hover:text-blue-800">Terms of Service</a>
                                and
                                <a href="#" class="text-blue-600 hover:text-blue-800">Privacy Policy</a>.
                                I understand this payment is non-refundable.
                            </label>
                        </div>
                        <div id="terms-error" class="text-red-500 text-sm hidden"></div>

                        <!-- Payment Button -->
                        <button type="submit"
                                id="submit-payment"
                                class="w-full bg-blue-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                                disabled>
                            <span id="button-text">Pay Now</span>
                            <span id="button-spinner" class="hidden">
                                <i class="fas fa-spinner fa-spin ml-2"></i> Processing...
                            </span>
                        </button>

                        <!-- Security Notice -->
                        <div class="text-center pt-4 border-t border-gray-200">
                            <div class="flex items-center justify-center text-sm text-gray-500">
                                <i class="fas fa-shield-alt text-green-500 mr-2"></i>
                                <span>Your payment is secured with 256-bit SSL encryption</span>
                            </div>
                        </div>
                    </form>
                </div>

                <!-- Payment Status Messages -->
                <div id="payment-success" class="hidden bg-green-50 border border-green-200 rounded-xl p-6 mb-6">
                    <div class="flex items-center">
                        <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center mr-4">
                            <i class="fas fa-check text-green-600 text-xl"></i>
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold text-green-800">Payment Successful!</h3>
                            <p class="text-green-600">Your application has been submitted successfully.</p>
                        </div>
                    </div>
                    <div class="mt-4">
                        <a href="/application/confirmation/" class="inline-block bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 transition-colors">
                            View Application Status
                        </a>
                    </div>
                </div>

                <div id="payment-error" class="hidden bg-red-50 border border-red-200 rounded-xl p-6">
                    <div class="flex items-center">
                        <div class="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center mr-4">
                            <i class="fas fa-exclamation-triangle text-red-600 text-xl"></i>
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold text-red-800">Payment Failed</h3>
                            <p id="error-message" class="text-red-600"></p>
                        </div>
                    </div>
                    <button onclick="resetPaymentForm()" class="mt-4 text-blue-600 hover:text-blue-800 font-medium">
                        Try Again
                    </button>
                </div>
            </div>

            <!-- Right Column: Payment Summary -->
            <div class="lg:w-1/3">
                <div class="bg-white rounded-xl shadow-lg p-6 sticky top-8">
                    <h2 class="text-xl font-semibold text-gray-800 mb-6">Payment Summary</h2>

                    <!-- Loading State -->
                    <div id="summary-loading" class="text-center py-8">
                        <i class="fas fa-spinner fa-spin text-blue-600 text-2xl mb-4"></i>
                        <p class="text-gray-600">Loading payment details...</p>
                    </div>

                    <!-- Summary Content -->
                    <div id="summary-content" class="hidden">
                        <!-- Application Details -->
                        <div class="mb-6">
                            <h3 class="font-medium text-gray-700 mb-2">Application Details</h3>
                            <div class="space-y-2">
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Applicant</span>
                                    <span id="summary-name" class="font-medium"></span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Application ID</span>
                                    <span id="summary-id" class="font-mono text-sm"></span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Service</span>
                                    <span>Processing Fee</span>
                                </div>
                            </div>
                        </div>

                        <!-- Amount Breakdown -->
                        <div class="border-t border-b border-gray-200 py-6 my-6">
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-gray-600">Subtotal</span>
                                <span id="summary-amount" class="text-lg font-semibold"></span>
                            </div>
                            <div class="flex justify-between text-sm text-gray-600">
                                <span>Tax</span>
                                <span>$0.00</span>
                            </div>
                        </div>

                        <!-- Total -->
                        <div class="mb-6">
                            <div class="flex justify-between items-center">
                                <span class="text-lg font-semibold text-gray-800">Total</span>
                                <span id="summary-total" class="text-2xl font-bold text-blue-600"></span>
                            </div>
                            <p class="text-sm text-gray-500 mt-1">USD â€¢ Payment processed by Stripe</p>
                        </div>

                        <!-- Security Features -->
                        <div class="bg-gray-50 rounded-lg p-4">
                            <h4 class="font-medium text-gray-700 mb-3">Security Features</h4>
                            <ul class="space-y-3">
                                <li class="flex items-center text-sm">
                                    <i class="fas fa-check text-green-500 mr-3"></i>
                                    <span>PCI DSS compliant</span>
                                </li>
                                <li class="flex items-center text-sm">
                                    <i class="fas fa-check text-green-500 mr-3"></i>
                                    <span>256-bit SSL encryption</span>
                                </li>
                                <li class="flex items-center text-sm">
                                    <i class="fas fa-check text-green-500 mr-3"></i>
                                    <span>No card data stored on our servers</span>
                                </li>
                                <li class="flex items-center text-sm">
                                    <i class="fas fa-check text-green-500 mr-3"></i>
                                    <span>3D Secure authentication</span>
                                </li>
                            </ul>
                        </div>

                        <!-- Help Section -->
                        <div class="mt-6 pt-6 border-t border-gray-200">
                            <div class="flex items-center text-gray-600">
                                <i class="fas fa-question-circle mr-3"></i>
                                <div>
                                    <p class="text-sm font-medium">Need help?</p>
                                    <p class="text-xs">Contact support@yourapp.com</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
// Configuration
const config = {
            applicationId: new URLSearchParams(window.location.search).get('application_id'),
            apiBaseUrl: '/api/payment',
            stripe: null
};

// State
let state = {
            paymentIntentClientSecret: null,
            paymentId: null,
            isLoading: false
};

// Initialize on page load
document.addEventListener('DOMContentLoaded', function () {
            initializePaymentPage();
});

async function initializePaymentPage() {
            try {
                // Load payment summary
                await loadPaymentSummary();

                // Initialize Stripe
                await initializeStripe();

                // Initialize form validation
                initializeFormValidation();

                // Initialize year dropdown
                initializeYearDropdown();

                // Format card number input
                initializeCardNumberFormatting();

            } catch (error) {
                console.error('Initialization error:', error);
                showError('Failed to initialize payment page. Please refresh.');
            }
}

async function loadPaymentSummary() {
            if (!config.applicationId) {
                showError('Application ID is missing');
                return;
            }

            try {
                const response = await fetch(`${config.apiBaseUrl}/summary/${config.applicationId}/`, {
                    headers: {
                        'Accept': 'application/json',
                        'X-CSRFToken': getCsrfToken()
                    }
                });

                const data = await response.json();

                if (data.success) {
                    displaySummary(data.data);
                } else {
                    throw new Error(data.error || 'Failed to load summary');
                }
            } catch (error) {
                console.error('Error loading summary:', error);
                showError('Could not load payment details. Please try again.');
            }
}

function displaySummary(summary) {
            document.getElementById('summary-loading').classList.add('hidden');
            document.getElementById('summary-content').classList.remove('hidden');

            document.getElementById('summary-name').textContent = summary.full_name;
            document.getElementById('summary-id').textContent = summary.application_id.slice(0, 8);
            document.getElementById('summary-amount').textContent = formatCurrency(summary.amount);
            document.getElementById('summary-total').textContent = formatCurrency(summary.amount);

            // Store Stripe key for later use
            config.stripePublishableKey = summary.stripe_public_key;
}

async function initializeStripe() {
            if (!config.stripePublishableKey) {
                throw new Error('Stripe publishable key not available');
            }

            config.stripe = Stripe(config.stripePublishableKey);
}

function initializeFormValidation() {
            const form = document.getElementById('payment-form');
            const submitButton = document.getElementById('submit-payment');
            const termsCheckbox = document.getElementById('terms');

            // Enable/disable submit button based on terms
            termsCheckbox.addEventListener('change', function () {
                submitButton.disabled = !this.checked || state.isLoading;
            });

            // Form submission
            form.addEventListener('submit', handleFormSubmit);

            // Real-time validation
            document.getElementById('card-number').addEventListener('input', validateCardNumber);
            document.getElementById('expiry-month').addEventListener('change', validateExpiryDate);
            document.getElementById('expiry-year').addEventListener('change', validateExpiryDate);
            document.getElementById('cvc').addEventListener('input', validateCVC);
            document.getElementById('cardholder-name').addEventListener('input', validateCardholderName);
}

function initializeYearDropdown() {
            const yearSelect = document.getElementById('expiry-year');
            const currentYear = new Date().getFullYear();

            for (let i = 0; i < 10; i++) {
                const year = currentYear + i;
                const option = document.createElement('option');
                option.value = year.toString().slice(2);
                option.textContent = year;
                yearSelect.appendChild(option);
            }
}

function initializeCardNumberFormatting() {
            const cardNumberInput = document.getElementById('card-number');

            cardNumberInput.addEventListener('input', function (e) {
                let value = e.target.value.replace(/\s+/g, '').replace(/[^0-9]/gi, '');
                let formatted = '';

                for (let i = 0; i < value.length; i++) {
                    if (i > 0 && i % 4 === 0) {
                        formatted += ' ';
                    }
                    formatted += value[i];
                }

                e.target.value = formatted;
            });
}

function validateCardNumber() {
            const input = document.getElementById('card-number');
            const errorElement = document.getElementById('card-number-error');
            const value = input.value.replace(/\s+/g, '');

            // Basic validation
            if (!value) {
                showErrorField(errorElement, 'Card number is required');
                return false;
            }

            if (!/^\d{13,19}$/.test(value)) {
                showErrorField(errorElement, 'Card number must be 13-19 digits');
                return false;
            }

            // Luhn algorithm validation
            if (!validateLuhn(value)) {
                showErrorField(errorElement, 'Invalid card number');
                return false;
            }

            hideErrorField(errorElement);
            return true;
}

function validateExpiryDate() {
            const month = document.getElementById('expiry-month').value;
            const year = document.getElementById('expiry-year').value;
            const errorElement = document.getElementById('expiry-error');

            if (!month || !year) {
                showErrorField(errorElement, 'Expiry date is required');
                return false;
            }

            const currentDate = new Date();
            const currentYear = currentDate.getFullYear() % 100;
            const currentMonth = currentDate.getMonth() + 1;

            const expiryYear = parseInt(year);
            const expiryMonth = parseInt(month);

            if (expiryYear < currentYear ||
                (expiryYear === currentYear && expiryMonth < currentMonth)) {
                showErrorField(errorElement, 'Card has expired');
                return false;
            }

            hideErrorField(errorElement);
            return true;
}

function validateCVC() {
            const input = document.getElementById('cvc');
            const errorElement = document.getElementById('cvc-error');
            const value = input.value;

            if (!value) {
                showErrorField(errorElement, 'CVC is required');
                return false;
            }

            if (!/^\d{3,4}$/.test(value)) {
                showErrorField(errorElement, 'CVC must be 3 or 4 digits');
                return false;
            }

            hideErrorField(errorElement);
            return true;
}

function validateCardholderName() {
            const input = document.getElementById('cardholder-name');
            const errorElement = document.getElementById('cardholder-error');
            const value = input.value.trim();

            if (!value) {
                showErrorField(errorElement, 'Cardholder name is required');
                return false;
            }

            if (value.length < 2) {
                showErrorField(errorElement, 'Enter full name');
                return false;
            }

            hideErrorField(errorElement);
            return true;
}

function validateLuhn(cardNumber) {
            let sum = 0;
            let isEven = false;

            for (let i = cardNumber.length - 1; i >= 0; i--) {
                let digit = parseInt(cardNumber.charAt(i), 10);

                if (isEven) {
                    digit *= 2;
                    if (digit > 9) {
                        digit -= 9;
                    }
                }

                sum += digit;
                isEven = !isEven;
            }

            return sum % 10 === 0;
}

async function handleFormSubmit(e) {
            e.preventDefault();

            if (!validateAllFields()) {
                return;
            }

            setLoading(true);

            try {
                // Create payment intent
                const { clientSecret, paymentId } = await createPaymentIntent();
                state.paymentIntentClientSecret = clientSecret;
                state.paymentId = paymentId;

                // Create payment method
                const cardElement = createCardElement();
                const { error: paymentMethodError, paymentMethod } = await config.stripe.createPaymentMethod({
                    type: 'card',
                    card: cardElement,
                    billing_details: {
                        name: document.getElementById('cardholder-name').value.trim()
                    }
                });

                if (paymentMethodError) {
                    throw new Error(paymentMethodError.message);
                }

                // Confirm payment
                const { error: confirmError, paymentIntent } = await config.stripe.confirmCardPayment(
                    clientSecret,
                    {
                        payment_method: paymentMethod.id
                    }
                );

                if (confirmError) {
                    throw new Error(confirmError.message);
                }

                // Handle successful payment
                await handleSuccessfulPayment(paymentIntent.id);

            } catch (error) {
                console.error('Payment error:', error);
                showPaymentError(error.message);
            } finally {
                setLoading(false);
            }
}

function createCardElement() {
            return {
                number: document.getElementById('card-number').value.replace(/\s+/g, ''),
                exp_month: document.getElementById('expiry-month').value,
                exp_year: document.getElementById('expiry-year').value,
                cvc: document.getElementById('cvc').value
            };
}

async function createPaymentIntent() {
            const response = await fetch(`${config.apiBaseUrl}/create-intent/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCsrfToken()
                },
                body: JSON.stringify({
                    application_id: config.applicationId
                })
            });

            const data = await response.json();

            if (!data.success) {
                throw new Error(data.error || 'Failed to create payment');
            }

            return {
                clientSecret: data.clientSecret,
                paymentId: data.payment_id
            };
}

async function handleSuccessfulPayment(paymentIntentId) {
            // Confirm with backend
            const response = await fetch(`${config.apiBaseUrl}/confirm/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCsrfToken()
                },
                body: JSON.stringify({
                    payment_intent_id: paymentIntentId
                })
            });

            const data = await response.json();

            if (data.success) {
                showPaymentSuccess();
            } else {
                throw new Error(data.error || 'Payment confirmation failed');
            }
}

function validateAllFields() {
            return validateCardNumber() &&
                validateExpiryDate() &&
                validateCVC() &&
                validateCardholderName();
}

function setLoading(isLoading) {
            state.isLoading = isLoading;

            const submitButton = document.getElementById('submit-payment');
            const buttonText = document.getElementById('button-text');
            const buttonSpinner = document.getElementById('button-spinner');

            submitButton.disabled = isLoading || !document.getElementById('terms').checked;

            if (isLoading) {
                buttonText.classList.add('hidden');
                buttonSpinner.classList.remove('hidden');
            } else {
                buttonText.classList.remove('hidden');
                buttonSpinner.classList.add('hidden');
            }
}

function showPaymentSuccess() {
            document.getElementById('payment-form').classList.add('hidden');
            document.getElementById('payment-success').classList.remove('hidden');
}

function showPaymentError(message) {
            document.getElementById('error-message').textContent = message;
            document.getElementById('payment-error').classList.remove('hidden');
}

function resetPaymentForm() {
            document.getElementById('payment-error').classList.add('hidden');
            document.getElementById('payment-form').classList.remove('hidden');
}

function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg mb-6';
            errorDiv.innerHTML = `
                        <div class="flex items-center">
                            <i class="fas fa-exclamation-circle mr-3"></i>
                            <span>${message}</span>
                        </div>
                    `;

            document.querySelector('.container').prepend(errorDiv);
}

function showErrorField(element, message) {
            element.textContent = message;
            element.classList.remove('hidden');
}

function hideErrorField(element) {
            element.textContent = '';
            element.classList.add('hidden');
}

function formatCurrency(amount) {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 2
            }).format(amount);
}

function getCsrfToken() {
            return document.querySelector('[name=csrfmiddlewaretoken]')?.value || '';
}

// Add CSRF token to fetch headers globally
const originalFetch = window.fetch;
window.fetch = function (resource, options = {}) {
            options.headers = {
                ...options.headers,
                'X-CSRFToken': getCsrfToken()
            };
            return originalFetch(resource, options);
};
    </script>
</body>
</html>