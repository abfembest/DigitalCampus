{% extends 'management/base.html' %}
{% load static %}

{% block title %}Transaction Reports - Finance Portal{% endblock %}

{% block meta_description %}
Comprehensive transaction reports with advanced filtering and export options
{% endblock %}

{% block meta_keywords %}
transaction reports, financial analytics, payment reports, export data
{% endblock %}

{% block extra_css %}
<style>
    /* DataTables Custom Styling */
    .dataTables_wrapper {
        padding: 0;
    }
    
    .dataTables_wrapper .dataTables_length,
    .dataTables_wrapper .dataTables_filter,
    .dataTables_wrapper .dataTables_info,
    .dataTables_wrapper .dataTables_paginate {
        padding: 1rem;
    }
    
    .dataTables_wrapper .dataTables_filter input {
        border: 1px solid #d1d5db;
        border-radius: 0.5rem;
        padding: 0.5rem 1rem;
        margin-left: 0.5rem;
    }
    
    .dataTables_wrapper .dataTables_length select {
        border: 1px solid #d1d5db;
        border-radius: 0.5rem;
        padding: 0.5rem;
        margin: 0 0.5rem;
    }
    
    div.dt-buttons {
        margin-bottom: 1rem;
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
    }
    
    .dt-button {
        background: #4a6bff !important;
        color: white !important;
        border: none !important;
        padding: 0.625rem 1.25rem !important;
        border-radius: 0.5rem !important;
        font-weight: 500 !important;
        font-size: 0.875rem !important;
        cursor: pointer !important;
        transition: all 0.3s ease !important;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1) !important;
    }
    
    .dt-button:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.2) !important;
        background: #3a56d4 !important;
    }
    
    .dt-button.buttons-csv {
        background: #10b981 !important;
    }
    
    .dt-button.buttons-csv:hover {
        background: #059669 !important;
    }
    
    .dt-button.buttons-excel {
        background: #3b82f6 !important;
    }
    
    .dt-button.buttons-excel:hover {
        background: #2563eb !important;
    }
    
    .dt-button.buttons-pdf {
        background: #ef4444 !important;
    }
    
    .dt-button.buttons-pdf:hover {
        background: #dc2626 !important;
    }
    
    .dt-button.buttons-print {
        background: #8b5cf6 !important;
    }
    
    .dt-button.buttons-print:hover {
        background: #7c3aed !important;
    }
    
    .dt-button.buttons-copy {
        background: #f59e0b !important;
    }
    
    .dt-button.buttons-copy:hover {
        background: #d97706 !important;
    }
    
    table.dataTable tbody tr {
        transition: background-color 0.2s ease;
    }
    
    table.dataTable tbody tr:hover {
        background-color: #f9fafb !important;
    }
    
    table.dataTable thead th {
        background: #1e40af;
        color: white !important;
        font-weight: 600;
        padding: 1rem !important;
        border-bottom: none !important;
    }
    
    table.dataTable tbody td {
        padding: 0.75rem 1rem !important;
        vertical-align: middle;
    }
    
    .stat-card {
        transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    
    .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
    }
</style>
{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-slate-50 to-blue-50 py-8">
    <div class="max-w-12xl mx-auto px-4 sm:px-6 lg:px-8">
        
        <!-- Page Header -->
        <div class="mb-8">
            <div class="flex flex-col md:flex-row md:items-center 
                        md:justify-between">
                <div>
                    <h1 class="text-3xl font-bold text-gray-900 mb-2">
                        <i class="fas fa-chart-line mr-3 text-blue-600" 
                           aria-hidden="true"></i>
                        Transaction Reports
                    </h1>
                    <p class="text-gray-600">
                        Comprehensive financial analytics with 
                        advanced filtering and export
                    </p>
                </div>
                <div class="flex gap-3 mt-4 md:mt-0">
                    <a href="{% url 'finance:dashboard' %}" 
                       class="inline-flex items-center px-4 py-2 
                              bg-white text-gray-700 
                              border border-gray-300 rounded-lg 
                              hover:bg-gray-50 transition font-medium 
                              shadow-sm"
                       aria-label="Back to Dashboard">
                        <i class="fas fa-arrow-left mr-2" 
                           aria-hidden="true"></i>
                        Back to Dashboard
                    </a>
                </div>
            </div>
        </div>

        <!-- Statistics Cards -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 
                    gap-6 mb-8">
            
            <!-- Total Transactions Card -->
            <div class="stat-card bg-gradient-to-br from-blue-500 
                        to-blue-600 rounded-xl shadow-lg p-6 
                        text-white"
                 role="region" 
                 aria-label="Total Transactions">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-blue-100 mb-1 text-sm font-medium">
                            Total Transactions
                        </p>
                        <p class="text-3xl font-bold" 
                           id="total-transactions">
                            {{ total_count|default:"0" }}
                        </p>
                    </div>
                    <div class="bg-white/20 rounded-lg p-3">
                        <i class="fas fa-receipt text-2xl" 
                           aria-hidden="true"></i>
                    </div>
                </div>
            </div>
            
            <!-- Successful Payments Card -->
            <div class="stat-card bg-gradient-to-br from-green-500 
                        to-green-600 rounded-xl shadow-lg p-6 
                        text-white"
                 role="region" 
                 aria-label="Successful Transactions">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-green-100 mb-1 text-sm 
                           font-medium">
                            Successful
                        </p>
                        <p class="text-3xl font-bold" 
                           id="successful-count">
                            {{ successful_count|default:"0" }}
                        </p>
                    </div>
                    <div class="bg-white/20 rounded-lg p-3">
                        <i class="fas fa-check-circle text-2xl" 
                           aria-hidden="true"></i>
                    </div>
                </div>
            </div>
            
            <!-- Total Revenue Card -->
            <div class="stat-card bg-gradient-to-br from-purple-500 
                        to-purple-600 rounded-xl shadow-lg p-6 
                        text-white"
                 role="region" 
                 aria-label="Total Revenue">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-purple-100 mb-1 text-sm 
                           font-medium">
                            Total Revenue
                        </p>
                        <p class="text-3xl font-bold" 
                           id="total-revenue">
                            ₦{{ total_revenue|floatformat:2|default:"0.00" }}
                        </p>
                    </div>
                    <div class="bg-white/20 rounded-lg p-3">
                        <i class="fas fa-money-bill-wave text-2xl" 
                           aria-hidden="true"></i>
                    </div>
                </div>
            </div>
            
            <!-- Success Rate Card -->
            <div class="stat-card bg-gradient-to-br from-orange-500 
                        to-orange-600 rounded-xl shadow-lg p-6 
                        text-white"
                 role="region" 
                 aria-label="Success Rate">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-orange-100 mb-1 text-sm 
                           font-medium">
                            Success Rate
                        </p>
                        <p class="text-3xl font-bold" 
                           id="success-rate">
                            {{ success_rate|floatformat:1|default:"0.0" }}%
                        </p>
                    </div>
                    <div class="bg-white/20 rounded-lg p-3">
                        <i class="fas fa-percentage text-2xl" 
                           aria-hidden="true"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Advanced Filters -->
        <div class="bg-white rounded-xl shadow-sm p-6 mb-8 
                    border border-gray-100">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-lg font-semibold text-gray-900">
                    <i class="fas fa-filter mr-2 text-blue-600" 
                       aria-hidden="true"></i>
                    Advanced Filters
                </h2>
                <button onclick="resetFilters()" 
                        class="text-sm text-blue-600 hover:text-blue-700 
                               font-medium transition"
                        aria-label="Reset all filters">
                    <i class="fas fa-redo mr-1" aria-hidden="true"></i>
                    Reset Filters
                </button>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 
                        gap-4">
                <!-- Date From -->
                <div>
                    <label for="filter-date-from" 
                           class="block text-sm font-medium text-gray-700 
                                  mb-2">
                        Date From
                    </label>
                    <input type="date" 
                           id="filter-date-from" 
                           class="w-full px-4 py-2.5 border 
                                  border-gray-300 rounded-lg 
                                  focus:ring-2 focus:ring-primary-500 
                                  focus:border-primary-500 bg-white 
                                  text-gray-900 transition-colors 
                                  text-sm"
                           aria-label="Filter by start date">
                </div>
                
                <!-- Date To -->
                <div>
                    <label for="filter-date-to" 
                           class="block text-sm font-medium 
                                  text-gray-700 mb-2">
                        Date To
                    </label>
                    <input type="date" 
                           id="filter-date-to" 
                           class="w-full px-4 py-2.5 border 
                                  border-gray-300 rounded-lg 
                                  focus:ring-2 focus:ring-primary-500 
                                  focus:border-primary-500 bg-white 
                                  text-gray-900 transition-colors 
                                  text-sm"
                           aria-label="Filter by end date">
                </div>
                
                <!-- Status Filter -->
                <div>
                    <label for="filter-status" 
                           class="block text-sm font-medium 
                                  text-gray-700 mb-2">
                        Status
                    </label>
                    <select id="filter-status" 
                            class="w-full px-4 py-2.5 border 
                                   border-gray-300 rounded-lg 
                                   focus:ring-2 focus:ring-primary-500 
                                   focus:border-primary-500 bg-white 
                                   text-gray-900 transition-colors 
                                   text-sm"
                            aria-label="Filter by payment status">
                        <option value="">All Statuses</option>
                        <option value="pending">Pending</option>
                        <option value="processing">Processing</option>
                        <option value="success">Success</option>
                        <option value="completed">Completed</option>
                        <option value="failed">Failed</option>
                        <option value="refunded">Refunded</option>
                    </select>
                </div>
                
                <!-- Payment Method Filter -->
                <div>
                    <label for="filter-method" 
                           class="block text-sm font-medium 
                                  text-gray-700 mb-2">
                        Payment Method
                    </label>
                    <select id="filter-method" 
                            class="w-full px-4 py-2.5 border 
                                   border-gray-300 rounded-lg 
                                   focus:ring-2 focus:ring-primary-500 
                                   focus:border-primary-500 bg-white 
                                   text-gray-900 transition-colors 
                                   text-sm"
                            aria-label="Filter by payment method">
                        <option value="">All Methods</option>
                        <option value="Card">Card</option>
                        <option value="PayPal">PayPal</option>
                        <option value="Bank Transfer">Bank Transfer</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Transactions Table -->
        <div class="bg-white rounded-xl shadow-sm border 
                    border-gray-100 overflow-hidden p-5">
            <div class="p-6 border-b border-gray-100">
                <h2 class="text-lg font-semibold text-gray-900">
                    <i class="fas fa-table mr-2 text-blue-600" 
                       aria-hidden="true"></i>
                    Transaction Details
                </h2>
                <p class="text-sm text-gray-600 mt-1">
                    View, filter, and export all transactions
                </p>
            </div>
            
            <div class="overflow-x-auto">
                <table id="transactionsTable" 
                       class="w-full display nowrap" 
                       style="width:100%"
                       role="table"
                       aria-label="Transactions table">
                    <thead>
                        <tr>
                            <th>Reference</th>
                            <th>Date</th>
                            <th>User</th>
                            <th>Email</th>
                            <th>Course</th>
                            <th>Method</th>
                            <th>Amount</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for payment in payments %}
                        <tr>
                            <td>
                                <a href="{% url 'finance:payment_detail' 
                                           payment.payment_reference %}" 
                                   class="text-blue-600 hover:text-blue-700 
                                          font-medium"
                                   aria-label="View payment {{ payment.payment_reference }}">
                                    {{ payment.payment_reference }}
                                </a>
                            </td>
                            <td>
                                <div class="font-medium text-gray-900">
                                    {{ payment.created_at|date:"M d, Y" }}
                                </div>
                                <div class="text-sm text-gray-500">
                                    {{ payment.created_at|date:"H:i" }}
                                </div>
                            </td>
                            <td>
                                {% if payment.application and payment.application.user %}
                                    <div class="font-medium text-gray-900">
                                        {{ payment.application.user.get_full_name|default:payment.application.user.username }}
                                    </div>
                                {% else %}
                                    <span class="text-gray-400">N/A</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if payment.application and payment.application.user %}
                                    <span class="text-sm text-gray-600">
                                        {{ payment.application.user.email }}
                                    </span>
                                {% else %}
                                    <span class="text-gray-400">N/A</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if payment.application and payment.application.course %}
                                    {{ payment.application.course.name }}
                                {% else %}
                                    <span class="text-gray-400">N/A</span>
                                {% endif %}
                            </td>
                            <td>
                                {{ payment.get_payment_method_display }}
                            </td>
                            <td>
                                <span class="font-semibold text-gray-900">
                                    ₦{{ payment.amount|floatformat:2 }}
                                </span>
                            </td>
                            <td>
                                {% if payment.status == 'success' or payment.status == 'completed' %}
                                    <span class="px-3 py-1 bg-green-100 
                                                 text-green-700 rounded-full 
                                                 text-xs font-semibold">
                                        {{ payment.get_status_display }}
                                    </span>
                                {% elif payment.status == 'pending' %}
                                    <span class="px-3 py-1 bg-yellow-100 
                                                 text-yellow-700 rounded-full 
                                                 text-xs font-semibold">
                                        {{ payment.get_status_display }}
                                    </span>
                                {% elif payment.status == 'processing' %}
                                    <span class="px-3 py-1 bg-blue-100 
                                                 text-blue-700 rounded-full 
                                                 text-xs font-semibold">
                                        {{ payment.get_status_display }}
                                    </span>
                                {% elif payment.status == 'failed' %}
                                    <span class="px-3 py-1 bg-red-100 
                                                 text-red-700 rounded-full 
                                                 text-xs font-semibold">
                                        {{ payment.get_status_display }}
                                    </span>
                                {% elif payment.status == 'refunded' %}
                                    <span class="px-3 py-1 bg-purple-100 
                                                 text-purple-700 rounded-full 
                                                 text-xs font-semibold">
                                        {{ payment.get_status_display }}
                                    </span>
                                {% else %}
                                    <span class="px-3 py-1 bg-gray-100 
                                                 text-gray-700 rounded-full 
                                                 text-xs font-semibold">
                                        {{ payment.get_status_display }}
                                    </span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // Initialize DataTable with export buttons
    var table = $('#transactionsTable').DataTable({
        responsive: true,
        pageLength: 25,
        order: [[1, 'desc']], // Sort by date descending
        dom: 'Bfrtip',
        buttons: [
            {
                extend: 'copy',
                text: '<i class="fas fa-copy mr-2"></i>Copy',
                className: 'buttons-copy',
                exportOptions: {
                    columns: [0, 1, 2, 3, 4, 5, 6, 7]
                }
            },
            {
                extend: 'csv',
                text: '<i class="fas fa-file-csv mr-2"></i>CSV',
                className: 'buttons-csv',
                filename: 'transaction_report_' + 
                          new Date().toISOString().slice(0,10),
                exportOptions: {
                    columns: [0, 1, 2, 3, 4, 5, 6, 7]
                }
            },
            {
                extend: 'excel',
                text: '<i class="fas fa-file-excel mr-2"></i>Excel',
                className: 'buttons-excel',
                filename: 'transaction_report_' + 
                          new Date().toISOString().slice(0,10),
                title: 'Transaction Report',
                exportOptions: {
                    columns: [0, 1, 2, 3, 4, 5, 6, 7]
                }
            },
            {
                extend: 'pdf',
                text: '<i class="fas fa-file-pdf mr-2"></i>PDF',
                className: 'buttons-pdf',
                filename: 'transaction_report_' + 
                          new Date().toISOString().slice(0,10),
                title: 'Transaction Report',
                orientation: 'landscape',
                pageSize: 'A4',
                exportOptions: {
                    columns: [0, 1, 2, 3, 4, 5, 6, 7]
                },
                customize: function(doc) {
                    doc.styles.title = {
                        color: '#1e40af',
                        fontSize: 20,
                        alignment: 'center',
                        margin: [0, 0, 0, 20]
                    };
                    doc.styles.tableHeader = {
                        bold: true,
                        fontSize: 11,
                        color: 'white',
                        fillColor: '#1e40af',
                        alignment: 'left'
                    };
                }
            },
            {
                extend: 'print',
                text: '<i class="fas fa-print mr-2"></i>Print',
                className: 'buttons-print',
                title: 'Transaction Report',
                exportOptions: {
                    columns: [0, 1, 2, 3, 4, 5, 6, 7]
                }
            }
        ],
        language: {
            search: "Search transactions:",
            lengthMenu: "Show _MENU_ transactions",
            info: "Showing _START_ to _END_ of _TOTAL_ transactions",
            infoEmpty: "No transactions found",
            infoFiltered: "(filtered from _MAX_ total transactions)",
            zeroRecords: "No matching transactions found",
            paginate: {
                first: "First",
                last: "Last",
                next: "Next",
                previous: "Previous"
            }
        }
    });

    // Custom column filters
    $('#filter-date-from, #filter-date-to').on('change', function() {
        filterByDateRange();
    });

    $('#filter-status').on('change', function() {
        var status = $(this).val();
        if (status) {
            table.column(7).search(status).draw();
        } else {
            table.column(7).search('').draw();
        }
        updateStats();
    });

    $('#filter-method').on('change', function() {
        var method = $(this).val();
        if (method) {
            table.column(5).search(method, true, false).draw();
        } else {
            table.column(5).search('').draw();
        }
        updateStats();
    });

    // Date range filter
    function filterByDateRange() {
        var fromDate = $('#filter-date-from').val();
        var toDate = $('#filter-date-to').val();
        
        $.fn.dataTable.ext.search.push(
            function(settings, data, dataIndex) {
                var dateCol = data[1]; 
                var dateText = $(dateCol).find('.font-medium').text() || 
                               dateCol;
                var rowDate = new Date(dateText);
                
                var from = fromDate ? new Date(fromDate) : null;
                var to = toDate ? new Date(toDate) : null;
                
                if (!from && !to) return true;
                if (!from && rowDate <= to) return true;
                if (!to && rowDate >= from) return true;
                if (rowDate >= from && rowDate <= to) return true;
                
                return false;
            }
        );
        
        table.draw();
        $.fn.dataTable.ext.search.pop();
        updateStats();
    }

    // Reset filters
    window.resetFilters = function() {
        $('#filter-date-from').val('');
        $('#filter-date-to').val('');
        $('#filter-status').val('');
        $('#filter-method').val('');
        table.search('').columns().search('').draw();
        updateStats();
    };

    // Update statistics based on filtered data
    function updateStats() {
        var filteredData = table.rows({search: 'applied'}).data();
        var total = filteredData.length;
        var successful = 0;
        var revenue = 0;
        
        for (var i = 0; i < filteredData.length; i++) {
            var row = filteredData[i];
            var status = $(row[7]).text().trim().toLowerCase();
            var amountText = row[6].replace(/[₦,]/g, '').trim();
            var amount = parseFloat(amountText);
            
            if (status.includes('success') || 
                status.includes('completed')) {
                successful++;
                if (!isNaN(amount)) {
                    revenue += amount;
                }
            }
        }
        
        var successRate = total > 0 ? 
                          (successful / total * 100).toFixed(1) : 0;
        
        // Update UI
        $('#total-transactions').text(total.toLocaleString());
        $('#successful-count').text(successful.toLocaleString());
        $('#total-revenue').text('₦' + 
            revenue.toLocaleString('en-US', {
                minimumFractionDigits: 2, 
                maximumFractionDigits: 2
            })
        );
        $('#success-rate').text(successRate + '%');
    }

    // Initial stats update
    updateStats();
});
</script>
{% endblock %}