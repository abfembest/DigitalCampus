{% extends 'base.html' %}
{% load static %}

{% block title %}Sign In | Sign Up - MIU{% endblock %}

{% block extra_css %}
<style>
    .auth-container {
        min-height: 100vh;
        background: linear-gradient(135deg, #f5f3ff 0%, #faf5ff 50%, #fef3c7 100%);
        display: flex;
        align-items: center;
        padding: 1rem;
    }
    
    .auth-card {
        background: rgba(255, 255, 255, 0.98);
        backdrop-filter: blur(20px);
        box-shadow: 0 20px 60px rgba(132, 3, 132, 0.15);
        max-width: 1400px;
        width: 100%;
        margin: 0 auto;
    }
    
    .auth-tab {
        position: relative;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .auth-tab.active {
        color: #840384;
    }
    
    .auth-tab::after {
        content: '';
        position: absolute;
        bottom: -2px;
        left: 0;
        width: 0;
        height: 3px;
        background: linear-gradient(135deg, #840384 0%, #a855f7 100%);
        transition: width 0.3s ease;
    }
    
    .auth-tab.active::after {
        width: 100%;
    }
    
    .form-container {
        display: none;
        animation: fadeInUp 0.5s ease;
    }
    
    .form-container.active {
        display: block;
    }
    
    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    .input-group {
        position: relative;
    }
    
    .input-group .icon {
        position: absolute;
        left: 12px;
        top: 50%;
        transform: translateY(-50%);
        color: #9ca3af;
        pointer-events: none;
    }
    
    .input-group input {
        padding-left: 42px;
    }
    
    .password-toggle {
        position: absolute;
        right: 12px;
        top: 50%;
        transform: translateY(-50%);
        cursor: pointer;
        color: #9ca3af;
        transition: color 0.2s;
    }
    
    .password-toggle:hover {
        color: #840384;
    }
    
    .captcha-box {
        background: linear-gradient(135deg, #f3e8ff 0%, #fef3c7 100%);
        border: 2px dashed #a855f7;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        font-weight: bold;
        color: #840384;
        min-height: 60px;
        border-radius: 8px;
    }
    
    .error-message {
        animation: shake 0.5s ease;
    }
    
    @keyframes shake {
        0%, 100% { transform: translateX(0); }
        25% { transform: translateX(-10px); }
        75% { transform: translateX(10px); }
    }
    
    .success-message {
        animation: slideDown 0.5s ease;
    }
    
    @keyframes slideDown {
        from {
            opacity: 0;
            transform: translateY(-20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="auth-container">
    <div class="container mx-auto">
        
        <div class="auth-card rounded-2xl overflow-hidden">
            <div class="grid lg:grid-cols-5 gap-0">
                
                <!-- Left Side - Branding -->
                <div class="hidden lg:flex lg:col-span-2 flex-col justify-center p-8 bg-gradient-to-br from-primary-950 via-purple-900 to-purple-800 text-white">
                    <div class="mb-8 text-center">
                        <img src="{% static 'Miulogo.png' %}" alt="MIU Logo" class="h-16 w-auto mb-6 bg-white rounded-xl p-3 mx-auto">
                        <h2 class="text-4xl font-bold font-display mb-4">Welcome to MIU</h2>
                        <p class="text-purple-200 text-lg leading-relaxed">
                            Join thousands of students worldwide in pursuing excellence through our innovative online education platform.
                        </p>
                    </div>
                    
                    <div class="space-y-4">
                        <div class="flex items-start gap-3">
                            <div class="bg-purple-700 rounded-lg p-2 mt-1">
                                <i data-lucide="check" class="w-5 h-5"></i>
                            </div>
                            <div>
                                <h4 class="font-semibold mb-1">World-Class Education</h4>
                                <p class="text-purple-200 text-sm">Access top-tier programs and expert faculty</p>
                            </div>
                        </div>
                        
                        <div class="flex items-start gap-3">
                            <div class="bg-purple-700 rounded-lg p-2 mt-1">
                                <i data-lucide="check" class="w-5 h-5"></i>
                            </div>
                            <div>
                                <h4 class="font-semibold mb-1">Flexible Learning</h4>
                                <p class="text-purple-200 text-sm">Study at your own pace, anywhere in the world</p>
                            </div>
                        </div>
                        
                        <div class="flex items-start gap-3">
                            <div class="bg-purple-700 rounded-lg p-2 mt-1">
                                <i data-lucide="check" class="w-5 h-5"></i>
                            </div>
                            <div>
                                <h4 class="font-semibold mb-1">Global Recognition</h4>
                                <p class="text-purple-200 text-sm">Internationally accredited degrees and certifications</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Right Side - Forms -->
                <div class="lg:col-span-3 p-6 lg:p-8">
                    
                    <!-- Tabs -->
                    <div class="flex border-b-2 border-gray-200 mb-6">
                        <button class="auth-tab active flex-1 pb-3 text-lg font-semibold text-center" data-tab="login">
                            Sign In
                        </button>
                        <button class="auth-tab flex-1 pb-3 text-lg font-semibold text-gray-600 text-center" data-tab="signup">
                            Sign Up
                        </button>
                    </div>
                    
                    <!-- Login Form -->
                    <div class="form-container active" id="loginForm">
                        <h3 class="text-2xl font-bold font-display text-gray-900 mb-6 text-center">
                            Welcome Back!
                        </h3>
                        
                        <form id="loginFormElement" method="POST" class="space-y-4">
                            {% csrf_token %}
                            <input type="hidden" name="action" value="login">
                            
                            <!-- Username/Email -->
                            <div class="mb-4">
                                <label for="login_username" class="block text-sm font-semibold text-gray-700 mb-2">
                                    Username or Email
                                </label>
                                <div class="input-group">
                                    <i data-lucide="user" class="icon w-5 h-5"></i>
                                    {{ login_form.username }}
                                </div>
                                <div class="error-message text-red-600 text-sm mt-1" id="login_username_error"></div>
                            </div>
                            
                            <!-- Password -->
                            <div class="mb-4">
                                <label for="login_password" class="block text-sm font-semibold text-gray-700 mb-2">
                                    Password
                                </label>
                                <div class="input-group">
                                    <i data-lucide="lock" class="icon w-5 h-5"></i>
                                    {{ login_form.password }}
                                    <i data-lucide="eye" class="password-toggle w-5 h-5" data-target="id_password"></i>
                                </div>
                                <div class="error-message text-red-600 text-sm mt-1" id="login_password_error"></div>
                            </div>
                            
                            <!-- Captcha -->
                            <div class="mb-4">
                                <label class="block text-sm font-semibold text-gray-700 mb-2">
                                    Security Check
                                </label>
                                <div class="grid grid-cols-2 gap-3">
                                    <div class="captcha-box" id="loginCaptchaQuestion">
                                        {{ captcha_question }} = ?
                                    </div>
                                    <input type="number" 
                                           name="captcha" 
                                           id="login_captcha"
                                           required
                                           class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-primary-950 focus:ring-2 focus:ring-purple-200 transition-all"
                                           placeholder="Your answer">
                                </div>
                                <div class="error-message text-red-600 text-sm mt-1" id="login_captcha_error"></div>
                            </div>
                            
                            <!-- Remember Me & Forgot Password -->
                            <div class="flex items-center justify-between mb-4">
                                <label class="flex items-center gap-2 cursor-pointer">
                                    <input type="checkbox" name="remember" class="h-4 w-4 rounded border-gray-300 text-primary-950 focus:ring-primary-950">
                                    <span class="text-sm text-gray-700">Remember me</span>
                                </label>
                                <a href="#" class="text-sm text-primary-950 hover:text-purple-700 font-medium">
                                    Forgot password?
                                </a>
                            </div>
                            
                            <!-- Form Error Messages -->
                            <div class="error-message text-red-600 text-sm mb-4" id="login_form_error"></div>
                            
                            <!-- Submit Button -->
                            <button type="submit" 
                                    class="w-full py-3.5 bg-gradient-to-r from-primary-950 to-purple-700 text-white rounded-lg font-bold text-base hover:shadow-xl hover:shadow-purple-500/50 hover:scale-105 transition-all duration-300 flex items-center justify-center gap-2"
                                    id="loginSubmitBtn">
                                <span>Sign In</span>
                                <i data-lucide="arrow-right" class="w-5 h-5"></i>
                            </button>
                        </form>
                    </div>
                    
                    <!-- Signup Form -->
                    <div class="form-container" id="signupForm">
                        <h3 class="text-2xl font-bold font-display text-gray-900 mb-6 text-center">
                            Create Your Account
                        </h3>
                        
                        <form id="signupFormElement" method="POST" class="space-y-4">
                            {% csrf_token %}
                            <input type="hidden" name="action" value="signup">
                            
                            <!-- Name Fields -->
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label for="id_first_name" class="block text-sm font-semibold text-gray-700 mb-2">
                                        First Name
                                    </label>
                                    {{ signup_form.first_name }}
                                    <div class="error-message text-red-600 text-sm mt-1" id="first_name_error"></div>
                                </div>
                                <div>
                                    <label for="id_last_name" class="block text-sm font-semibold text-gray-700 mb-2">
                                        Last Name
                                    </label>
                                    {{ signup_form.last_name }}
                                    <div class="error-message text-red-600 text-sm mt-1" id="last_name_error"></div>
                                </div>
                            </div>
                            
                            <!-- Username -->
                             <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label for="id_username" class="block text-sm font-semibold text-gray-700 mb-2">
                                        Username
                                    </label>
                                    <div class="input-group">
                                        <i data-lucide="user" class="icon w-5 h-5"></i>
                                        {{ signup_form.username }}
                                    </div>
                                    <div class="error-message text-red-600 text-sm mt-1" id="username_error"></div>
                                </div>
                                
                                <!-- Email -->
                                <div>
                                    <label for="id_email" class="block text-sm font-semibold text-gray-700 mb-2">
                                        Email Address
                                    </label>
                                    <div class="input-group">
                                        <i data-lucide="mail" class="icon w-5 h-5"></i>
                                        {{ signup_form.email }}
                                    </div>
                                    <div class="error-message text-red-600 text-sm mt-1" id="email_error"></div>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-4">
                                <!-- Password -->
                                <div>
                                    <label for="id_password1" class="block text-sm font-semibold text-gray-700 mb-2">
                                        Password
                                    </label>
                                    <div class="input-group">
                                        <i data-lucide="lock" class="icon w-5 h-5"></i>
                                        {{ signup_form.password1 }}
                                        <i data-lucide="eye" class="password-toggle w-5 h-5" data-target="id_password1"></i>
                                    </div>
                                    <div class="error-message text-red-600 text-sm mt-1" id="password1_error"></div>
                                </div>
                                
                                <!-- Confirm Password -->
                                <div>
                                    <label for="id_password2" class="block text-sm font-semibold text-gray-700 mb-2">
                                        Confirm Password
                                    </label>
                                    <div class="input-group">
                                        <i data-lucide="lock" class="icon w-5 h-5"></i>
                                        {{ signup_form.password2 }}
                                        <i data-lucide="eye" class="password-toggle w-5 h-5" data-target="id_password2"></i>
                                    </div>
                                    <div class="error-message text-red-600 text-sm mt-1" id="password2_error"></div>
                                </div>
                            </div>
                            
                            <!-- Captcha -->
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">
                                    Security Check
                                </label>
                                <div class="grid grid-cols-2 gap-3">
                                    <div class="captcha-box" id="signupCaptchaQuestion">
                                        {{ captcha_question }} = ?
                                    </div>
                                    <input type="number" 
                                           name="captcha" 
                                           id="signup_captcha"
                                           required
                                           class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-primary-950 focus:ring-2 focus:ring-purple-200 transition-all"
                                           placeholder="Your answer">
                                </div>
                                <div class="error-message text-red-600 text-sm mt-1" id="captcha_error"></div>
                            </div>
                            
                            <!-- Terms -->
                            <div>
                                <label class="flex items-start gap-3 cursor-pointer">
                                    <input type="checkbox" required class="h-5 w-5 rounded border-gray-300 text-primary-950 focus:ring-primary-950 mt-0.5">
                                    <span class="text-sm text-gray-700">
                                        I agree to the <a href="#" class="text-primary-950 hover:text-purple-700 font-medium">Terms of Service</a> and <a href="#" class="text-primary-950 hover:text-purple-700 font-medium">Privacy Policy</a>
                                    </span>
                                </label>
                            </div>
                            
                            <!-- Form Error Messages -->
                            <div class="error-message text-red-600 text-sm" id="signup_form_error"></div>
                            
                            <!-- Submit Button -->
                            <button type="submit" 
                                    class="w-full py-3.5 bg-gradient-to-r from-primary-950 to-purple-700 text-white rounded-lg font-bold text-base hover:shadow-xl hover:shadow-purple-500/50 hover:scale-105 transition-all duration-300 flex items-center justify-center gap-2"
                                    id="signupSubmitBtn">
                                <span>Create Account</span>
                                <i data-lucide="user-plus" class="w-5 h-5"></i>
                            </button>
                        </form>
                    </div>
                    
                </div>
            </div>
        </div>
        
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    lucide.createIcons();
    
    // ========== TAB SWITCHING ==========
    const tabs = document.querySelectorAll('.auth-tab');
    const forms = document.querySelectorAll('.form-container');
    
    tabs.forEach(tab => {
        tab.addEventListener('click', () => {
            const targetTab = tab.dataset.tab;
            
            tabs.forEach(t => t.classList.remove('active'));
            tab.classList.add('active');
            
            forms.forEach(form => {
                if (form.id === targetTab + 'Form') {
                    form.classList.add('active');
                } else {
                    form.classList.remove('active');
                }
            });
            
            clearAllErrors();
            setTimeout(() => lucide.createIcons(), 50);
        });
    });
    
    // ========== PASSWORD TOGGLE (FIXED VERSION) ==========
    document.body.addEventListener('click', function(e) {
        // Check if clicked element IS the toggle or is inside it
        const toggle = e.target.classList.contains('password-toggle') ? e.target : e.target.closest('.password-toggle');
        
        if (toggle) {
            e.preventDefault();
            e.stopPropagation();
            
            const targetId = toggle.dataset.target;
            const input = document.getElementById(targetId);
            
            if (input) {
                const isPassword = input.type === 'password';
                input.type = isPassword ? 'text' : 'password';
                
                // Update the icon
                toggle.setAttribute('data-lucide', isPassword ? 'eye-off' : 'eye');
                lucide.createIcons();
            }
        }
    });
    
    // ========== LOGIN FORM ==========
    document.getElementById('loginFormElement').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        clearAllErrors();
        const submitBtn = document.getElementById('loginSubmitBtn');
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<span>Signing In...</span><i data-lucide="loader-2" class="w-5 h-5 animate-spin"></i>';
        submitBtn.disabled = true;
        lucide.createIcons();
        
        try {
            const formData = new FormData(this);
            const response = await fetch('{% url "eduweb:auth_page" %}', {
                method: 'POST',
                body: formData,
                headers: { 'X-Requested-With': 'XMLHttpRequest' }
            });
            
            const data = await response.json();
            
            if (data.success) {
                showMessage('success', data.message);
                setTimeout(() => window.location.href = data.redirect_url, 1500);
            } else {
                handleFormErrors('login', data.errors);
                if (data.captcha_question) {
                    document.getElementById('loginCaptchaQuestion').textContent = data.captcha_question + ' = ?';
                    document.getElementById('login_captcha').value = '';
                }
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
                lucide.createIcons();
            }
        } catch (error) {
            showMessage('error', 'An error occurred. Please try again.');
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
            lucide.createIcons();
        }
    });
    
    // ========== SIGNUP FORM ==========
    document.getElementById('signupFormElement').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        clearAllErrors();
        const submitBtn = document.getElementById('signupSubmitBtn');
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<span>Creating Account...</span><i data-lucide="loader-2" class="w-5 h-5 animate-spin"></i>';
        submitBtn.disabled = true;
        lucide.createIcons();
        
        try {
            const formData = new FormData(this);
            const response = await fetch('{% url "eduweb:auth_page" %}', {
                method: 'POST',
                body: formData,
                headers: { 'X-Requested-With': 'XMLHttpRequest' }
            });
            
            const data = await response.json();
            
            if (data.success) {
                showMessage('success', data.message);
                setTimeout(() => this.reset(), 2000);
            } else {
                handleFormErrors('signup', data.errors);
                if (data.captcha_question) {
                    document.getElementById('signupCaptchaQuestion').textContent = data.captcha_question + ' = ?';
                    document.getElementById('signup_captcha').value = '';
                }
            }
            
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
            lucide.createIcons();
        } catch (error) {
            showMessage('error', 'An error occurred. Please try again.');
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
            lucide.createIcons();
        }
    });
    
    // ========== HELPER FUNCTIONS ==========
    function handleFormErrors(formType, errors) {
        for (const [field, messages] of Object.entries(errors)) {
            const errorElement = document.getElementById(`${formType === 'login' ? 'login_' : ''}${field}_error`);
            if (errorElement) {
                errorElement.textContent = messages.join(' ');
            } else if (field === '__all__') {
                document.getElementById(`${formType}_form_error`).textContent = messages.join(' ');
            }
        }
    }
    
    function clearAllErrors() {
        document.querySelectorAll('.error-message').forEach(el => el.textContent = '');
    }
    
    function showMessage(type, message) {
        window.showToast(type, message);
    }
});
</script>
{% endblock %}