{% extends "management/base.html" %}
{% load static humanize %}

{% block title %}My Payments — MIU Student Portal{% endblock %}

{% block meta_description %}
View and pay all outstanding university fees assigned to your faculty and department.
{% endblock %}

{% block content %}
<div class="max-w-12xl mx-auto px-4 sm:px-6 lg:px-8">

    <!-- ============================================================ -->
    <!-- Page Header + Breadcrumb                                     -->
    <!-- ============================================================ -->
    <div class="mb-6 flex flex-col sm:flex-row sm:items-center 
                sm:justify-between gap-4">
        <!-- Left: breadcrumb + title -->
        <div>
            <nav class="text-xs text-gray-400 mb-1 flex items-center gap-1.5">
                <a href="{% url 'students:dashboard' %}" 
                   class="hover:text-primary-600 transition-colors">
                    <i class="fas fa-home"></i> Dashboard
                </a>
                <i class="fas fa-chevron-right text-[10px]"></i>
                <span class="text-gray-600 font-medium">My Payments</span>
            </nav>
            <h1 class="text-2xl sm:text-3xl font-bold text-gray-900 
                       flex items-center gap-2">
                <span class="w-9 h-9 bg-red-100 rounded-lg flex items-center 
                             justify-center flex-shrink-0">
                    <i class="fas fa-file-invoice-dollar text-red-600 text-base"></i>
                </span>
                My Outstanding Fees
            </h1>
            <p class="text-sm text-gray-500 mt-1">
                {{ request.user.profile.faculty.name|default:"—" }} &bull; 
                {{ request.user.profile.department.name|default:"—" }}
            </p>
        </div>

        <!-- Right: summary badge -->
        <div class="flex-shrink-0 text-right">
            {% if outstanding_payments %}
            <div class="inline-flex flex-col items-end bg-red-50 
                        border border-red-200 rounded-xl px-5 py-3">
                <span class="text-xs font-medium text-red-500 uppercase tracking-wide">
                    Total Outstanding
                </span>
                <span class="text-2xl font-bold text-red-700 mt-0.5">
                    ₦{{ total_outstanding|floatformat:2|intcomma }}
                </span>
                <span class="text-xs text-red-400 mt-0.5">
                    {{ outstanding_payments|length }} item{{ outstanding_payments|length|pluralize }}
                </span>
            </div>
            {% else %}
            <div class="inline-flex items-center gap-2 bg-green-50 
                        border border-green-200 rounded-xl px-5 py-3">
                <i class="fas fa-check-circle text-green-500 text-xl"></i>
                <div class="text-left">
                    <p class="text-sm font-semibold text-green-700">All Clear!</p>
                    <p class="text-xs text-green-500">No outstanding fees</p>
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- ============================================================ -->
    <!-- Django messages                                              -->
    <!-- ============================================================ -->
    {% if messages %}
    <div class="mb-5 space-y-2">
        {% for message in messages %}
        <div class="flex items-start gap-3 px-4 py-3 rounded-lg text-sm font-medium
            {% if message.tags == 'success' %}bg-green-50 border border-green-200 text-green-800
            {% elif message.tags == 'error' %}bg-red-50 border border-red-200 text-red-800
            {% else %}bg-blue-50 border border-blue-200 text-blue-800{% endif %}">
            <i class="fas 
                {% if message.tags == 'success' %}fa-check-circle text-green-500
                {% elif message.tags == 'error' %}fa-exclamation-circle text-red-500
                {% else %}fa-info-circle text-blue-500{% endif %} mt-0.5 flex-shrink-0"></i>
            {{ message }}
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <!-- ============================================================ -->
    <!-- Outstanding Payments Table                                   -->
    <!-- ============================================================ -->
    {% if outstanding_payments %}
    <div class="bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden">

        <!-- Table header bar -->
        <div class="px-5 py-4 border-b border-gray-100 
                    flex items-center justify-between bg-gray-50">
            <h2 class="text-sm font-semibold text-gray-700 flex items-center gap-2">
                <i class="fas fa-exclamation-triangle text-amber-500"></i>
                Outstanding Payments
            </h2>
            <span class="text-xs bg-red-100 text-red-700 font-semibold 
                         px-2.5 py-1 rounded-full">
                {{ outstanding_payments|length }} unpaid
            </span>
        </div>

        <!-- Desktop table -->
        <div class="hidden sm:block overflow-x-auto">
            <table class="w-full text-sm" id="paymentsTable">
                <thead>
                    <tr class="border-b border-gray-100 bg-gray-50/50">
                        <th class="text-left text-xs font-semibold text-gray-500 
                                   uppercase tracking-wider px-5 py-3.5">#</th>
                        <th class="text-left text-xs font-semibold text-gray-500 
                                   uppercase tracking-wider px-5 py-3.5">Purpose</th>
                        <th class="text-left text-xs font-semibold text-gray-500 
                                   uppercase tracking-wider px-5 py-3.5">Faculty</th>
                        <th class="text-left text-xs font-semibold text-gray-500 
                                   uppercase tracking-wider px-5 py-3.5">Department</th>
                        <th class="text-left text-xs font-semibold text-gray-500 
                                   uppercase tracking-wider px-5 py-3.5">Amount</th>
                        <th class="text-left text-xs font-semibold text-gray-500 
                                   uppercase tracking-wider px-5 py-3.5">Due Date</th>
                        <th class="text-left text-xs font-semibold text-gray-500 
                                   uppercase tracking-wider px-5 py-3.5">Status</th>
                        <th class="text-left text-xs font-semibold text-gray-500 
                                   uppercase tracking-wider px-5 py-3.5">Action</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-50">
                    {% for item in outstanding_payments %}
                    <tr class="hover:bg-gray-50/70 transition-colors group
                               {% if item.is_overdue %}bg-red-50/30{% endif %}">
                        <!-- # -->
                        <td class="px-5 py-4 text-gray-400 font-mono text-xs">
                            {{ forloop.counter }}
                        </td>

                        <!-- Purpose -->
                        <td class="px-5 py-4">
                            <div class="flex items-start gap-2.5">
                                <span class="w-8 h-8 flex-shrink-0 rounded-lg 
                                             bg-primary-50 flex items-center justify-center mt-0.5">
                                    <i class="fas fa-receipt text-primary-500 text-xs"></i>
                                </span>
                                <div>
                                    <p class="font-medium text-gray-900 leading-tight">
                                        {{ item.payment.purpose }}
                                    </p>
                                    {% if item.payment.academic_year %}
                                    <p class="text-xs text-gray-400 mt-0.5">
                                        {{ item.payment.get_semester_display }} 
                                        &bull; {{ item.payment.academic_year }}
                                    </p>
                                    {% endif %}
                                </div>
                            </div>
                        </td>

                        <!-- Faculty -->
                        <td class="px-5 py-4">
                            <span class="text-gray-700 font-medium">
                                {{ item.payment.faculty.code }}
                            </span>
                            <p class="text-xs text-gray-400 truncate max-w-[140px]">
                                {{ item.payment.faculty.name }}
                            </p>
                        </td>

                        <!-- Department -->
                        <td class="px-5 py-4">
                            <span class="text-gray-700 font-medium">
                                {{ item.payment.department.code }}
                            </span>
                            <p class="text-xs text-gray-400 truncate max-w-[140px]">
                                {{ item.payment.department.name }}
                            </p>
                        </td>

                        <!-- Amount -->
                        <td class="px-5 py-4">
                            <span class="text-base font-bold text-gray-900">
                                ₦{{ item.payment.amount|floatformat:2|intcomma }}
                            </span>
                        </td>

                        <!-- Due Date -->
                        <td class="px-5 py-4">
                            <div>
                                <p class="font-medium 
                                   {% if item.is_overdue %}text-red-600{% else %}text-gray-700{% endif %}">
                                    {{ item.payment.due_date|date:"M d, Y" }}
                                </p>
                                {% if item.is_overdue %}
                                <p class="text-xs text-red-500 font-medium mt-0.5">
                                    <i class="fas fa-clock mr-1"></i>Overdue
                                </p>
                                {% else %}
                                <p class="text-xs text-gray-400 mt-0.5">
                                    {{ item.payment.due_date|timeuntil }} left
                                </p>
                                {% endif %}
                            </div>
                        </td>

                        <!-- Status -->
                        <td class="px-5 py-4">
                            {% if item.is_overdue %}
                            <span class="inline-flex items-center gap-1.5 
                                         px-2.5 py-1 rounded-full text-xs font-semibold
                                         bg-red-100 text-red-700">
                                <span class="w-1.5 h-1.5 rounded-full bg-red-500"></span>
                                Overdue
                            </span>
                            {% else %}
                            <span class="inline-flex items-center gap-1.5 
                                         px-2.5 py-1 rounded-full text-xs font-semibold
                                         bg-amber-100 text-amber-700">
                                <span class="w-1.5 h-1.5 rounded-full bg-amber-500"></span>
                                Outstanding
                            </span>
                            {% endif %}
                        </td>

                        <!-- Action -->
                        <td class="px-5 py-4">
                            <a href="{ url 'students:payment_confirm' item.payment.pk %}"
                               class="inline-flex items-center gap-1.5 
                                      px-3.5 py-2 rounded-lg text-xs font-semibold
                                      bg-primary-600 hover:bg-primary-700 
                                      text-white transition-colors duration-150
                                      shadow-sm hover:shadow-md
                                      group-hover:scale-105 transform transition-transform">
                                <i class="fas fa-credit-card"></i>
                                Make Payment
                            </a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>

                <!-- Table footer: total -->
                <tfoot>
                    <tr class="border-t-2 border-gray-200 bg-gray-50">
                        <td colspan="4" class="px-5 py-4 text-sm font-semibold text-gray-600">
                            Total Outstanding
                        </td>
                        <td colspan="4" class="px-5 py-4">
                            <span class="text-xl font-bold text-red-700">
                                ₦{{ total_outstanding|floatformat:2|intcomma }}
                            </span>
                        </td>
                    </tr>
                </tfoot>
            </table>
        </div>

        <!-- ============================================================ -->
        <!-- Mobile card list (hidden on sm+)                             -->
        <!-- ============================================================ -->
        <div class="block sm:hidden divide-y divide-gray-100">
            {% for item in outstanding_payments %}
            <div class="p-4 {% if item.is_overdue %}bg-red-50/40{% endif %}">
                <div class="flex items-start justify-between gap-3 mb-3">
                    <div class="flex items-start gap-2.5 flex-1 min-w-0">
                        <span class="w-9 h-9 flex-shrink-0 rounded-lg 
                                     bg-primary-50 flex items-center justify-center">
                            <i class="fas fa-receipt text-primary-500"></i>
                        </span>
                        <div class="min-w-0">
                            <p class="font-semibold text-gray-900 text-sm leading-tight">
                                {{ item.payment.purpose }}
                            </p>
                            <p class="text-xs text-gray-400 mt-0.5 truncate">
                                {{ item.payment.faculty.code }} / {{ item.payment.department.code }}
                            </p>
                        </div>
                    </div>
                    {% if item.is_overdue %}
                    <span class="flex-shrink-0 text-xs bg-red-100 text-red-700 
                                 font-semibold px-2 py-0.5 rounded-full">Overdue</span>
                    {% else %}
                    <span class="flex-shrink-0 text-xs bg-amber-100 text-amber-700 
                                 font-semibold px-2 py-0.5 rounded-full">Outstanding</span>
                    {% endif %}
                </div>
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-xl font-bold text-gray-900">
                            ₦{{ item.payment.amount|floatformat:2|intcomma }}
                        </p>
                        <p class="text-xs {% if item.is_overdue %}text-red-500{% else %}text-gray-400{% endif %} mt-0.5">
                            Due: {{ item.payment.due_date|date:"M d, Y" }}
                        </p>
                    </div>
                    <a href="{ url 'students:payment_confirm' item.payment.pk %}"
                       class="inline-flex items-center gap-1.5 px-4 py-2 
                              bg-primary-600 hover:bg-primary-700 
                              text-white text-xs font-semibold 
                              rounded-lg transition-colors shadow-sm">
                        <i class="fas fa-credit-card"></i>
                        Pay Now
                    </a>
                </div>
            </div>
            {% endfor %}
            <!-- Mobile total -->
            <div class="px-4 py-4 bg-red-50 flex items-center justify-between">
                <span class="text-sm font-semibold text-gray-700">Total Outstanding</span>
                <span class="text-lg font-bold text-red-700">
                    ₦{{ total_outstanding|floatformat:2|intcomma }}
                </span>
            </div>
        </div>

    </div><!-- /card -->

    <!-- ============================================================ -->
    <!-- Already Paid Payments (collapsible info section)            -->
    <!-- ============================================================ -->
    {% if paid_payments %}
    <div class="mt-6 bg-white rounded-2xl border border-gray-200 shadow-sm overflow-hidden">
        <button onclick="togglePaid()"
                class="w-full px-5 py-4 flex items-center justify-between
                       text-left hover:bg-gray-50 transition-colors">
            <h3 class="text-sm font-semibold text-gray-700 flex items-center gap-2">
                <i class="fas fa-check-circle text-green-500"></i>
                Paid Fees
                <span class="text-xs bg-green-100 text-green-700 font-semibold 
                             px-2 py-0.5 rounded-full">
                    {{ paid_payments|length }}
                </span>
            </h3>
            <i id="paidChevron" class="fas fa-chevron-down text-gray-400 text-xs 
                                       transition-transform duration-200"></i>
        </button>
        <div id="paidSection" class="hidden border-t border-gray-100">
            {% for item in paid_payments %}
            <div class="px-5 py-3.5 flex items-center justify-between gap-4 
                        {% if not forloop.last %}border-b border-gray-50{% endif %}
                        hover:bg-gray-50/50 transition-colors">
                <div class="flex items-center gap-3 min-w-0">
                    <span class="w-7 h-7 flex-shrink-0 rounded-full bg-green-100 
                                 flex items-center justify-center">
                        <i class="fas fa-check text-green-600 text-[10px]"></i>
                    </span>
                    <div class="min-w-0">
                        <p class="text-sm font-medium text-gray-700 truncate">
                            {{ item.purpose }}
                        </p>
                        <p class="text-xs text-gray-400">
                            {{ item.faculty.code }} / {{ item.department.code }}
                        </p>
                    </div>
                </div>
                <div class="text-right flex-shrink-0">
                    <p class="text-sm font-bold text-gray-700">
                        ₦{{ item.amount|floatformat:2|intcomma }}
                    </p>
                    <span class="text-xs text-green-600 font-semibold">Paid</span>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    {% else %}
    <!-- ============================================================ -->
    <!-- Empty State: all fees paid                                   -->
    <!-- ============================================================ -->
    <div class="bg-white rounded-2xl border border-gray-200 shadow-sm 
                px-8 py-16 text-center">
        <div class="w-20 h-20 bg-green-100 rounded-full flex items-center 
                    justify-center mx-auto mb-5">
            <i class="fas fa-check-double text-green-500 text-3xl"></i>
        </div>
        <h2 class="text-xl font-bold text-gray-900 mb-2">
            You're all settled up!
        </h2>
        <p class="text-gray-500 text-sm max-w-sm mx-auto">
            You have no outstanding fees for your faculty and department. 
            Keep up the great work!
        </p>
        <a href="{% url 'students:dashboard' %}"
           class="inline-flex items-center gap-2 mt-6 px-5 py-2.5 
                  bg-primary-600 hover:bg-primary-700 text-white 
                  text-sm font-semibold rounded-lg transition-colors">
            <i class="fas fa-arrow-left"></i>
            Back to Dashboard
        </a>
    </div>
    {% endif %}

</div>

<script>
function togglePaid() {
    const section  = document.getElementById('paidSection');
    const chevron  = document.getElementById('paidChevron');
    const isHidden = section.classList.contains('hidden');
    section.classList.toggle('hidden', !isHidden);
    chevron.style.transform = isHidden ? 'rotate(180deg)' : 'rotate(0deg)';
}
</script>
{% endblock %}