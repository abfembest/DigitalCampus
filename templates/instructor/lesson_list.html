{% extends 'management/base.html' %}
{% load static %}

{% block title %}Manage Lessons - {{ course.title }}{% endblock %}

{% block content %}
<div class="max-w-12xl mx-auto">
    <!-- Breadcrumb -->
    <nav class="flex mb-6" aria-label="Breadcrumb">
        <ol class="inline-flex items-center space-x-1 md:space-x-3">
            <li class="inline-flex items-center">
                <a href="{% url 'instructor:course_list' %}" 
                   class="text-gray-600 hover:text-primary-600 inline-flex items-center">
                    <i class="fas fa-book mr-2"></i> Courses
                </a>
            </li>
            <li>
                <div class="flex items-center">
                    <i class="fas fa-chevron-right text-gray-400 mx-2"></i>
                    <a href="{% url 'instructor:course_edit' course.slug %}" 
                       class="text-gray-600 hover:text-primary-600">
                        {{ course.title|truncatewords:5 }}
                    </a>
                </div>
            </li>
            <li>
                <div class="flex items-center">
                    <i class="fas fa-chevron-right text-gray-400 mx-2"></i>
                    <span class="text-gray-500">Lessons</span>
                </div>
            </li>
        </ol>
    </nav>

    <!-- Page Header -->
    <div class="mb-8">
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
            <div>
                <h1 class="text-3xl font-bold text-gray-900 font-display">
                    Course Content
                </h1>
                <p class="text-gray-600 mt-2">
                    Organize your course into sections and lessons
                </p>
            </div>
            <div class="flex flex-col sm:flex-row gap-3">
                <button onclick="showTipsModal()" 
                   class="inline-flex items-center justify-center px-6 py-3 bg-blue-50 border-2 border-blue-600 text-blue-600 font-medium rounded-lg hover:bg-blue-100 transition-all">
                    <i class="fas fa-lightbulb mr-2"></i> 
                    Quick Tips
                </button>
                <a href="{% url 'instructor:section_create' course.slug %}" 
                   class="inline-flex items-center justify-center px-6 py-3 bg-white border-2 border-primary-600 text-primary-600 font-medium rounded-lg hover:bg-primary-50 transition-all">
                    <i class="fas fa-folder-plus mr-2"></i> 
                    Add Section
                </a>
                <a href="{% url 'instructor:lesson_create' course.slug %}" 
                   class="inline-flex items-center justify-center px-6 py-3 bg-primary-600 text-white font-medium rounded-lg hover:bg-primary-700 shadow-sm hover:shadow-md transition-all">
                    <i class="fas fa-plus-circle mr-2"></i> 
                    Add Lesson
                </a>
            </div>
        </div>
    </div>

    <!-- Course Stats Overview -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
            <div class="flex items-start justify-between">
                <div>
                    <p class="text-gray-600 text-sm font-medium">Total Sections</p>
                    <h3 class="text-3xl font-bold text-gray-900 mt-2">
                        {{ sections.count }}
                    </h3>
                </div>
                <div class="bg-blue-50 text-blue-600 p-3 rounded-lg">
                    <i class="fas fa-folder text-2xl"></i>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
            <div class="flex items-start justify-between">
                <div>
                    <p class="text-gray-600 text-sm font-medium">Total Lessons</p>
                    <h3 class="text-3xl font-bold text-gray-900 mt-2">
                        {{ course.lessons.count }}
                    </h3>
                </div>
                <div class="bg-green-50 text-green-600 p-3 rounded-lg">
                    <i class="fas fa-play-circle text-2xl"></i>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
            <div class="flex items-start justify-between">
                <div>
                    <p class="text-gray-600 text-sm font-medium">Video Lessons</p>
                    <h3 class="text-3xl font-bold text-gray-900 mt-2">
                        {{ video_count }}
                    </h3>
                </div>
                <div class="bg-purple-50 text-purple-600 p-3 rounded-lg">
                    <i class="fas fa-video text-2xl"></i>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
            <div class="flex items-start justify-between">
                <div>
                    <p class="text-gray-600 text-sm font-medium">Quizzes</p>
                    <h3 class="text-3xl font-bold text-gray-900 mt-2">
                        {{ quiz_count }}
                    </h3>
                </div>
                <div class="bg-orange-50 text-orange-600 p-3 rounded-lg">
                    <i class="fas fa-question-circle text-2xl"></i>
                </div>
            </div>
        </div>
    </div>

    {% if sections %}
    <!-- Sections with Lessons -->
    <div class="space-y-6">
        {% for section in sections %}
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
            <!-- Section Header -->
            <div class="bg-gradient-to-r from-primary-50 to-blue-50 border-b border-gray-200 p-6">
                <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
                    <div class="flex items-start gap-4">
                        <div class="bg-primary-600 text-white p-3 rounded-lg">
                            <i class="fas fa-folder text-xl"></i>
                        </div>
                        <div>
                            <h2 class="text-xl font-bold text-gray-900">
                                {{ section.title }}
                            </h2>
                            {% if section.description %}
                            <p class="text-gray-600 mt-1">
                                {{ section.description }}
                            </p>
                            {% endif %}
                            <p class="text-sm text-gray-500 mt-2">
                                <i class="fas fa-list-ul mr-1"></i>
                                {{ section.lessons.count }} lesson{{ section.lessons.count|pluralize }}
                            </p>
                        </div>
                    </div>
                    <div class="flex items-center gap-2">
                        <a href="{% url 'instructor:section_edit' course.slug section.id %}" 
                           class="inline-flex items-center px-4 py-2 bg-white text-gray-700 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors"
                           title="Edit Section">
                            <i class="fas fa-edit mr-2"></i> Edit
                        </a>
                        <a href="#" onclick="confirmDelete('section', {{ section.id }}, '{{ section.title|escapejs }}'); return false;" 
                           class="inline-flex items-center px-4 py-2 bg-white text-red-600 border border-red-300 rounded-lg hover:bg-red-50 transition-colors"
                           title="Delete Section">
                            <i class="fas fa-trash mr-2"></i> Delete
                        </a>
                    </div>
                </div>
            </div>

            <!-- Lessons in Section -->
            {% if section.lessons.all %}
            <div class="divide-y divide-gray-200">
                {% for lesson in section.lessons.all %}
                <div class="p-6 hover:bg-gray-50 transition-colors">
                    <div class="flex flex-col lg:flex-row lg:items-center justify-between gap-4">
                        <div class="flex items-start gap-4 flex-1">
                            <!-- Lesson Type Icon -->
                            <div class="flex-shrink-0">
                                {% if lesson.lesson_type == 'video' %}
                                <div class="w-12 h-12 bg-purple-100 text-purple-600 rounded-lg flex items-center justify-center">
                                    <i class="fas fa-video text-xl"></i>
                                </div>
                                {% elif lesson.lesson_type == 'text' %}
                                <div class="w-12 h-12 bg-blue-100 text-blue-600 rounded-lg flex items-center justify-center">
                                    <i class="fas fa-file-alt text-xl"></i>
                                </div>
                                {% elif lesson.lesson_type == 'quiz' %}
                                <div class="w-12 h-12 bg-green-100 text-green-600 rounded-lg flex items-center justify-center">
                                    <i class="fas fa-question-circle text-xl"></i>
                                </div>
                                {% elif lesson.lesson_type == 'assignment' %}
                                <div class="w-12 h-12 bg-orange-100 text-orange-600 rounded-lg flex items-center justify-center">
                                    <i class="fas fa-tasks text-xl"></i>
                                </div>
                                {% else %}
                                <div class="w-12 h-12 bg-gray-100 text-gray-600 rounded-lg flex items-center justify-center">
                                    <i class="fas fa-file text-xl"></i>
                                </div>
                                {% endif %}
                            </div>

                            <!-- Lesson Info -->
                            <div class="flex-1 min-w-0">
                                <h3 class="text-lg font-semibold text-gray-900 mb-1">
                                    {{ lesson.title }}
                                </h3>
                                {% if lesson.description %}
                                <p class="text-gray-600 text-sm mb-2 line-clamp-2">
                                    {{ lesson.description }}
                                </p>
                                {% endif %}
                                <div class="flex flex-wrap items-center gap-3 text-sm text-gray-500">
                                    <span class="inline-flex items-center">
                                        <i class="fas fa-tag mr-1"></i>
                                        {{ lesson.get_lesson_type_display }}
                                    </span>
                                    {% if lesson.video_duration_minutes %}
                                    <span class="inline-flex items-center">
                                        <i class="fas fa-clock mr-1"></i>
                                        {{ lesson.video_duration_minutes }} min
                                    </span>
                                    {% endif %}
                                    {% if lesson.is_preview %}
                                    <span class="inline-flex items-center px-2 py-1 bg-green-100 text-green-700 rounded-full text-xs font-medium">
                                        <i class="fas fa-eye mr-1"></i> Preview
                                    </span>
                                    {% endif %}
                                    {% if not lesson.is_active %}
                                    <span class="inline-flex items-center px-2 py-1 bg-gray-100 text-gray-700 rounded-full text-xs font-medium">
                                        <i class="fas fa-pause-circle mr-1"></i> Inactive
                                    </span>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- Actions -->
                        <div class="flex flex-wrap items-center gap-2">
                            <a href="{% url 'instructor:lesson_edit' course.slug lesson.id %}" 
                               class="inline-flex items-center px-3 py-2 bg-primary-50 text-primary-700 rounded-lg hover:bg-primary-100 transition-colors text-sm font-medium"
                               title="Edit Lesson">
                                <i class="fas fa-edit mr-2"></i> Edit
                            </a>
                            
                            {% if lesson.lesson_type == 'quiz' %}
                            <a href="{% url 'instructor:quiz_list' course.slug lesson.id %}" 
                               class="inline-flex items-center px-3 py-2 bg-green-50 text-green-700 rounded-lg hover:bg-green-100 transition-colors text-sm font-medium"
                               title="Manage Quizzes">
                                <i class="fas fa-question-circle mr-2"></i> Quizzes
                            </a>
                            {% endif %}
                            
                            {% if lesson.lesson_type == 'assignment' %}
                            <a href="{% url 'instructor:assignment_list' course.slug lesson.id %}" 
                               class="inline-flex items-center px-3 py-2 bg-orange-50 text-orange-700 rounded-lg hover:bg-orange-100 transition-colors text-sm font-medium"
                               title="Manage Assignments">
                                <i class="fas fa-tasks mr-2"></i> Assignments
                            </a>
                            {% endif %}
                            
                            <a href="#" onclick="confirmDelete('lesson', {{ lesson.id }}, '{{ lesson.title|escapejs }}'); return false;" 
                               class="inline-flex items-center px-3 py-2 bg-red-50 text-red-700 rounded-lg hover:bg-red-100 transition-colors text-sm font-medium"
                               title="Delete Lesson">
                                <i class="fas fa-trash mr-2"></i> Delete
                            </a>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <!-- Empty Section State -->
            <div class="p-12 text-center">
                <i class="fas fa-inbox text-5xl text-gray-300 mb-4"></i>
                <h3 class="text-lg font-semibold text-gray-900 mb-2">
                    No lessons in this section yet
                </h3>
                <p class="text-gray-600 mb-4">
                    Add your first lesson to this section
                </p>
                <a href="{% url 'instructor:lesson_create' course.slug %}" 
                   class="inline-flex items-center px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition-colors">
                    <i class="fas fa-plus-circle mr-2"></i> 
                    Add Lesson
                </a>
            </div>
            {% endif %}
        </div>
        {% endfor %}

        <!-- Lessons without Section -->
        {% if course.lessons.all %}
        {% for lesson in course.lessons.all %}
        {% if not lesson.section %}
        {% if forloop.first %}
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
            <div class="bg-gray-50 border-b border-gray-200 p-6">
                <div class="flex items-start gap-4">
                    <div class="bg-gray-400 text-white p-3 rounded-lg">
                        <i class="fas fa-stream text-xl"></i>
                    </div>
                    <div>
                        <h2 class="text-xl font-bold text-gray-900">
                            Unsectioned Lessons
                        </h2>
                        <p class="text-gray-600 mt-1">
                            Lessons not assigned to any section
                        </p>
                    </div>
                </div>
            </div>

            <div class="divide-y divide-gray-200">
        {% endif %}
                <div class="p-6 hover:bg-gray-50 transition-colors">
                    <div class="flex flex-col lg:flex-row lg:items-center justify-between gap-4">
                        <div class="flex items-start gap-4 flex-1">
                            <div class="flex-shrink-0">
                                {% if lesson.lesson_type == 'video' %}
                                <div class="w-12 h-12 bg-purple-100 text-purple-600 rounded-lg flex items-center justify-center">
                                    <i class="fas fa-video text-xl"></i>
                                </div>
                                {% elif lesson.lesson_type == 'text' %}
                                <div class="w-12 h-12 bg-blue-100 text-blue-600 rounded-lg flex items-center justify-center">
                                    <i class="fas fa-file-alt text-xl"></i>
                                </div>
                                {% elif lesson.lesson_type == 'quiz' %}
                                <div class="w-12 h-12 bg-green-100 text-green-600 rounded-lg flex items-center justify-center">
                                    <i class="fas fa-question-circle text-xl"></i>
                                </div>
                                {% elif lesson.lesson_type == 'assignment' %}
                                <div class="w-12 h-12 bg-orange-100 text-orange-600 rounded-lg flex items-center justify-center">
                                    <i class="fas fa-tasks text-xl"></i>
                                </div>
                                {% else %}
                                <div class="w-12 h-12 bg-gray-100 text-gray-600 rounded-lg flex items-center justify-center">
                                    <i class="fas fa-file text-xl"></i>
                                </div>
                                {% endif %}
                            </div>

                            <div class="flex-1 min-w-0">
                                <h3 class="text-lg font-semibold text-gray-900 mb-1">
                                    {{ lesson.title }}
                                </h3>
                                {% if lesson.description %}
                                <p class="text-gray-600 text-sm mb-2 line-clamp-2">
                                    {{ lesson.description }}
                                </p>
                                {% endif %}
                                <div class="flex flex-wrap items-center gap-3 text-sm text-gray-500">
                                    <span class="inline-flex items-center">
                                        <i class="fas fa-tag mr-1"></i>
                                        {{ lesson.get_lesson_type_display }}
                                    </span>
                                    {% if lesson.video_duration_minutes %}
                                    <span class="inline-flex items-center">
                                        <i class="fas fa-clock mr-1"></i>
                                        {{ lesson.video_duration_minutes }} min
                                    </span>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <div class="flex flex-wrap items-center gap-2">
                            <a href="{% url 'instructor:lesson_edit' course.slug lesson.id %}" 
                               class="inline-flex items-center px-3 py-2 bg-primary-50 text-primary-700 rounded-lg hover:bg-primary-100 transition-colors text-sm font-medium">
                                <i class="fas fa-edit mr-2"></i> Edit
                            </a>
                            <a href="#" onclick="confirmDelete('lesson', {{ lesson.id }}, '{{ lesson.title|escapejs }}'); return false;" 
                               class="inline-flex items-center px-3 py-2 bg-red-50 text-red-700 rounded-lg hover:bg-red-100 transition-colors text-sm font-medium">
                                <i class="fas fa-trash mr-2"></i> Delete
                            </a>
                        </div>
                    </div>
                </div>
                {% if forloop.last %}
            </div>
        </div>
                {% endif %}
        {% endif %}
        {% endfor %}
        {% endif %}
    </div>

    {% else %}
    <!-- Empty State - No Sections -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-12 text-center">
        <div class="max-w-md mx-auto">
            <div class="w-24 h-24 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-6">
                <i class="fas fa-folder-open text-5xl text-gray-400"></i>
            </div>
            <h3 class="text-2xl font-bold text-gray-900 mb-2">
                No Course Content Yet
            </h3>
            <p class="text-gray-600 mb-6">
                Start building your course by creating sections to organize your lessons, or add lessons directly.
            </p>
            <div class="flex flex-col sm:flex-row gap-3 justify-center">
                <a href="{% url 'instructor:section_create' course.slug %}" 
                   class="inline-flex items-center px-6 py-3 bg-white border-2 border-primary-600 text-primary-600 font-medium rounded-lg hover:bg-primary-50 transition-all">
                    <i class="fas fa-folder-plus mr-2"></i> 
                    Create First Section
                </a>
                <a href="{% url 'instructor:lesson_create' course.slug %}" 
                   class="inline-flex items-center px-6 py-3 bg-primary-600 text-white font-medium rounded-lg hover:bg-primary-700 shadow-sm hover:shadow-md transition-all">
                    <i class="fas fa-plus-circle mr-2"></i> 
                    Add First Lesson
                </a>
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}


{% block extra_js %}
<script>
// Show tips modal
function showTipsModal() {
    Swal.fire({
        title: '<i class="fas fa-lightbulb text-blue-600"></i> Tips for Organizing Course Content',
        html: `
            <div class="text-left space-y-4 px-4">
                <div class="flex items-start gap-3">
                    <i class="fas fa-check-circle text-blue-600 mt-1"></i>
                    <p class="text-gray-700">
                        <strong>Use sections wisely:</strong> Group related lessons together (e.g., "Week 1", "Introduction", "Advanced Topics") to create a logical learning path.
                    </p>
                </div>
                <div class="flex items-start gap-3">
                    <i class="fas fa-check-circle text-blue-600 mt-1"></i>
                    <p class="text-gray-700">
                        <strong>Mix content types:</strong> Combine videos, text, quizzes, and assignments to keep learners engaged and cater to different learning styles.
                    </p>
                </div>
                <div class="flex items-start gap-3">
                    <i class="fas fa-check-circle text-blue-600 mt-1"></i>
                    <p class="text-gray-700">
                        <strong>Enable previews:</strong> Allow students to preview introductory lessons to attract potential enrollments and showcase your teaching style.
                    </p>
                </div>
                <div class="flex items-start gap-3">
                    <i class="fas fa-check-circle text-blue-600 mt-1"></i>
                    <p class="text-gray-700">
                        <strong>Control the sequence:</strong> Use display order to ensure lessons appear in the right sequence within sections.
                    </p>
                </div>
                <div class="flex items-start gap-3">
                    <i class="fas fa-check-circle text-blue-600 mt-1"></i>
                    <p class="text-gray-700">
                        <strong>Start simple:</strong> Don't overwhelm students. Begin with foundational content and gradually increase complexity.
                    </p>
                </div>
            </div>
        `,
        icon: null,
        confirmButtonText: 'Got it!',
        confirmButtonColor: '#3b82f6',
        width: '600px',
        customClass: {
            confirmButton: 'px-6 py-2 rounded-lg font-medium',
            htmlContainer: 'text-left'
        }
    });
}

function confirmDelete(type, id, title) {
    const typeText = type === 'section' ? 'Section' : 'Lesson';
    const deleteUrl = type === 'section' 
        ? "{% url 'instructor:section_delete' course.slug 0 %}".replace('/0/', `/${id}/`)
        : "{% url 'instructor:lesson_delete' course.slug 0 %}".replace('/0/', `/${id}/`);
    
    Swal.fire({
        title: `Delete ${typeText}?`,
        html: `Are you sure you want to delete <strong>"${title}"</strong>?<br><span class="text-sm text-gray-600">This action cannot be undone.</span>`,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#dc3545',
        cancelButtonColor: '#6c757d',
        confirmButtonText: 'Yes, delete it!',
        cancelButtonText: 'Cancel',
        reverseButtons: true,
        customClass: {
            confirmButton: 'px-4 py-2 rounded-lg font-medium',
            cancelButton: 'px-4 py-2 rounded-lg font-medium'
        }
    }).then((result) => {
        if (result.isConfirmed) {
            // Create a form and submit it
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = deleteUrl;
            
            // Add CSRF token
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || '{{ csrf_token }}';
            const csrfInput = document.createElement('input');
            csrfInput.type = 'hidden';
            csrfInput.name = 'csrfmiddlewaretoken';
            csrfInput.value = csrfToken;
            form.appendChild(csrfInput);
            
            document.body.appendChild(form);
            form.submit();
        }
    });
}
</script>
{% endblock %}