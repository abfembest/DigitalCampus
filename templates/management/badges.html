{% extends 'management/base.html' %}
{% block title %}Badges - Admin{% endblock %}

{% block content %}
<div class="max-w-full">

  <div class="mb-6">
    <h1 class="text-2xl font-bold text-gray-800">Achievement Badges</h1>
    <p class="text-sm text-gray-500 mt-0.5">Create and manage badges awarded to students</p>
  </div>

  <div class="flex flex-col lg:flex-row gap-6 items-start">

    {% comment %} TABLE COLUMN {% endcomment %}
    <div class="w-full min-w-0 lg:flex-1">

      <form method="get" class="mb-4">
        <div class="flex gap-2 max-w-md">
          <label for="search" class="sr-only">Search badges</label>
          <input id="search" name="search" type="search"
                 value="{{ request.GET.search|default:'' }}"
                 placeholder="Search badgesâ€¦"
                 class="flex-1 px-4 py-2.5 border border-gray-300 rounded-lg text-sm
                        focus:ring-2 focus:ring-primary-500 focus:outline-none">
          <button type="submit"
                  class="px-4 py-2.5 bg-gray-100 hover:bg-gray-200 border border-gray-300
                         rounded-lg text-sm font-medium transition-colors">
            Search
          </button>
          {% if request.GET.search %}
            <a href="{% url 'management:badges_list' %}"
               class="px-4 py-2.5 border border-gray-300 rounded-lg text-sm
                      text-gray-500 hover:bg-gray-50 transition-colors">
              Clear
            </a>
          {% endif %}
        </div>
      </form>

      <div class="bg-white rounded-xl shadow border border-gray-200 overflow-x-auto">
        <table class="min-w-full text-sm">
          <thead class="bg-gray-50 border-b border-gray-200">
            <tr>
              <th scope="col" class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wide">Badge</th>
              <th scope="col" class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wide hidden sm:table-cell">Criteria</th>
              <th scope="col" class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wide hidden md:table-cell">Points</th>
              <th scope="col" class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wide">Status</th>
              <th scope="col" class="px-4 py-3 text-right text-xs font-semibold text-gray-600 uppercase tracking-wide">Actions</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-gray-100">
            {% for badge in badges %}
            <tr class="hover:bg-gray-50 transition-colors">

              <td class="px-4 py-3">
                <div class="flex items-center gap-2.5">
                  <div class="w-8 h-8 rounded-full bg-primary-100 flex items-center justify-center shrink-0">
                    <i class="fas fa-{{ badge.icon }} text-primary-600 text-xs" aria-hidden="true"></i>
                  </div>
                  <div class="min-w-0">
                    <p class="font-medium text-gray-900 whitespace-nowrap">{{ badge.name }}</p>
                    <p class="text-xs text-gray-400 truncate max-w-[160px]">{{ badge.description|truncatewords:6 }}</p>
                  </div>
                </div>
              </td>

              <td class="px-4 py-3 text-xs text-gray-500 hidden sm:table-cell max-w-[200px]">
                <span class="line-clamp-2">{{ badge.criteria|truncatewords:12 }}</span>
              </td>

              <td class="px-4 py-3 hidden md:table-cell whitespace-nowrap">
                <span class="font-semibold text-gray-700">{{ badge.points }}</span>
                <span class="text-xs text-gray-400 ml-1">pts</span>
              </td>

              <td class="px-4 py-3 whitespace-nowrap">
                {% if badge.is_active %}
                  <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full bg-green-50 text-green-700 border border-green-200 text-xs font-medium">
                    <i class="fas fa-circle-check" aria-hidden="true"></i>
                    <span class="hidden sm:inline">Active</span>
                  </span>
                {% else %}
                  <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full bg-gray-100 text-gray-500 border border-gray-200 text-xs font-medium">
                    <i class="fas fa-circle-xmark" aria-hidden="true"></i>
                    <span class="hidden sm:inline">Inactive</span>
                  </span>
                {% endif %}
              </td>

              <td class="px-4 py-3 text-right whitespace-nowrap">
                <button type="button"
                        class="btn-edit inline-flex items-center gap-1 px-2.5 py-1.5 text-xs
                               font-medium text-primary-600 hover:bg-primary-50 rounded-lg
                               transition-colors focus:outline-none focus:ring-2 focus:ring-primary-400"
                        data-slug="{{ badge.slug }}"
                        data-name="{{ badge.name }}"
                        data-description="{{ badge.description }}"
                        data-icon="{{ badge.icon }}"
                        data-color="{{ badge.color }}"
                        data-criteria="{{ badge.criteria }}"
                        data-points="{{ badge.points }}"
                        data-active="{{ badge.is_active|yesno:'true,false' }}"
                        aria-label="Edit {{ badge.name }}">
                  <i class="fas fa-pen-to-square" aria-hidden="true"></i>
                  <span class="hidden sm:inline">Edit</span>
                </button>
                <form method="post"
                      action="{% url 'management:badge_delete' badge.slug %}"
                      class="inline"
                      onsubmit="return confirm('Delete badge {{ badge.name|escapejs }}? This cannot be undone.');">
                  {% csrf_token %}
                  <button type="submit"
                          class="inline-flex items-center gap-1 px-2.5 py-1.5 text-xs
                                 font-medium text-red-500 hover:bg-red-50 rounded-lg
                                 transition-colors focus:outline-none focus:ring-2 focus:ring-red-400"
                          aria-label="Delete {{ badge.name }}">
                    <i class="fas fa-trash" aria-hidden="true"></i>
                    <span class="hidden sm:inline">Delete</span>
                  </button>
                </form>
              </td>

            </tr>
            {% empty %}
            <tr>
              <td colspan="5" class="px-6 py-14 text-center text-gray-400">
                <i class="fas fa-award text-4xl mb-3 block opacity-30" aria-hidden="true"></i>
                {% if request.GET.search %}No badges match your search.
                {% else %}No badges created yet.{% endif %}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      {% if badges.has_other_pages %}
      <nav aria-label="Pagination" class="mt-4 flex flex-wrap justify-center gap-1">
        {% if badges.has_previous %}
          <a href="?page={{ badges.previous_page_number }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}"
             class="px-3 py-2 rounded-lg border border-gray-300 text-sm hover:bg-gray-50 transition-colors">
            &laquo; Prev
          </a>
        {% endif %}
        {% for num in badges.paginator.page_range %}
          {% if badges.number == num %}
            <span class="px-3 py-2 rounded-lg bg-primary-600 text-white text-sm font-medium">{{ num }}</span>
          {% elif num > badges.number|add:"-3" and num < badges.number|add:"3" %}
            <a href="?page={{ num }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}"
               class="px-3 py-2 rounded-lg border border-gray-300 text-sm hover:bg-gray-50 transition-colors">
              {{ num }}
            </a>
          {% endif %}
        {% endfor %}
        {% if badges.has_next %}
          <a href="?page={{ badges.next_page_number }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}"
             class="px-3 py-2 rounded-lg border border-gray-300 text-sm hover:bg-gray-50 transition-colors">
            Next &raquo;
          </a>
        {% endif %}
      </nav>
      {% endif %}

    </div>

    {% comment %} FORM COLUMN {% endcomment %}
    <div class="w-full lg:w-80 xl:w-96 shrink-0 lg:sticky lg:top-4">
      <div class="bg-white rounded-xl shadow border border-gray-200 overflow-hidden">

        <div class="px-5 py-4 bg-gray-50 border-b border-gray-100 flex items-center justify-between">
          <h2 id="form-heading" class="text-base font-semibold text-gray-800">New Badge</h2>
          <span id="form-mode-badge"
                class="hidden text-xs font-medium px-2 py-0.5 rounded-full bg-primary-100 text-primary-700">
            Editing
          </span>
        </div>

        <form id="badge-form"
              method="post"
              action="{% url 'management:badge_create' %}"
              class="p-5 space-y-4"
              novalidate>
          {% csrf_token %}
          <input type="hidden" id="badge-slug-field" name="_badge_slug" value="">

          {% if form.non_field_errors %}
            <div role="alert" class="px-3 py-2.5 bg-red-50 border border-red-200 rounded-lg text-red-700 text-xs">
              {{ form.non_field_errors }}
            </div>
          {% endif %}

          <div>
            <label for="{{ form.name.id_for_label }}"
                   class="block text-xs font-semibold text-gray-600 uppercase tracking-wide mb-1.5">
              Name <span class="text-red-500">*</span>
            </label>
            {{ form.name }}
            {% if form.name.errors %}
              <p class="mt-1 text-xs text-red-600" role="alert">{{ form.name.errors.0 }}</p>
            {% endif %}
          </div>

          <div>
            <label for="{{ form.description.id_for_label }}"
                   class="block text-xs font-semibold text-gray-600 uppercase tracking-wide mb-1.5">
              Description <span class="text-red-500">*</span>
            </label>
            {{ form.description }}
            {% if form.description.errors %}
              <p class="mt-1 text-xs text-red-600" role="alert">{{ form.description.errors.0 }}</p>
            {% endif %}
          </div>

          <div class="grid grid-cols-2 gap-3">
            <div>
              <label for="{{ form.icon.id_for_label }}"
                     class="block text-xs font-semibold text-gray-600 uppercase tracking-wide mb-1.5">
                Icon
              </label>
              {{ form.icon }}
              {% if form.icon.errors %}
                <p class="mt-1 text-xs text-red-600" role="alert">{{ form.icon.errors.0 }}</p>
              {% endif %}
            </div>
            <div>
              <label for="{{ form.color.id_for_label }}"
                     class="block text-xs font-semibold text-gray-600 uppercase tracking-wide mb-1.5">
                Color
              </label>
              {{ form.color }}
              {% if form.color.errors %}
                <p class="mt-1 text-xs text-red-600" role="alert">{{ form.color.errors.0 }}</p>
              {% endif %}
            </div>
          </div>

          <div>
            <label for="{{ form.criteria.id_for_label }}"
                   class="block text-xs font-semibold text-gray-600 uppercase tracking-wide mb-1.5">
              Criteria <span class="text-red-500">*</span>
            </label>
            {{ form.criteria }}
            {% if form.criteria.errors %}
              <p class="mt-1 text-xs text-red-600" role="alert">{{ form.criteria.errors.0 }}</p>
            {% endif %}
          </div>

          <div>
            <label for="{{ form.points.id_for_label }}"
                   class="block text-xs font-semibold text-gray-600 uppercase tracking-wide mb-1.5">
              Points
            </label>
            {{ form.points }}
            {% if form.points.errors %}
              <p class="mt-1 text-xs text-red-600" role="alert">{{ form.points.errors.0 }}</p>
            {% endif %}
          </div>

          <div class="flex items-center gap-2.5 px-3 py-2.5 bg-gray-50 rounded-lg border border-gray-200">
            {{ form.is_active }}
            <label for="{{ form.is_active.id_for_label }}"
                   class="text-sm text-gray-700 font-medium cursor-pointer select-none">
              Active
            </label>
          </div>

          <div class="flex gap-2 pt-2 border-t border-gray-100">
            <button type="submit"
                    id="submit-btn"
                    class="flex-1 px-4 py-2.5 bg-primary-600 hover:bg-primary-700
                           text-white text-sm font-semibold rounded-lg transition-colors
                           focus:outline-none focus:ring-2 focus:ring-primary-500">
              Create Badge
            </button>
            <button type="button"
                    id="btn-reset"
                    class="px-4 py-2.5 border border-gray-300 rounded-lg text-sm
                           font-medium text-gray-600 hover:bg-gray-50 transition-colors
                           focus:outline-none focus:ring-2 focus:ring-gray-400"
                    title="Clear form">
              <i class="fas fa-rotate-left" aria-hidden="true"></i>
            </button>
          </div>

        </form>
      </div>
    </div>

  </div>
</div>

<script>
(function () {
  'use strict';

  var CREATE_URL = '{% url "management:badge_create" %}';
  var EDIT_BASE  = '/management/badges/';

  var form      = document.getElementById('badge-form');
  var heading   = document.getElementById('form-heading');
  var modeBadge = document.getElementById('form-mode-badge');
  var submitBtn = document.getElementById('submit-btn');
  var slugField = document.getElementById('badge-slug-field');

  function resetForm() {
    form.action           = CREATE_URL;
    form.reset();
    slugField.value       = '';
    heading.textContent   = 'New Badge';
    submitBtn.textContent = 'Create Badge';
    modeBadge.classList.add('hidden');
  }

  document.querySelectorAll('.btn-edit').forEach(function (btn) {
    btn.addEventListener('click', function () {
      var d = this.dataset;

      form.action           = EDIT_BASE + d.slug + '/edit/';
      slugField.value       = d.slug;
      heading.textContent   = 'Edit Badge';
      submitBtn.textContent = 'Update Badge';
      modeBadge.classList.remove('hidden');

      form.querySelector('[name="name"]').value        = d.name        || '';
      form.querySelector('[name="description"]').value = d.description || '';
      form.querySelector('[name="icon"]').value        = d.icon        || '';
      form.querySelector('[name="color"]').value       = d.color       || '';
      form.querySelector('[name="criteria"]').value    = d.criteria    || '';
      form.querySelector('[name="points"]').value      = d.points      || '';
      form.querySelector('[name="is_active"]').checked = (d.active === 'true');

      form.closest('.bg-white').scrollIntoView({ behavior: 'smooth', block: 'start' });
    });
  });

  document.getElementById('btn-reset').addEventListener('click', resetForm);

}());
</script>
{% endblock %}