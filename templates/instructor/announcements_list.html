{% extends 'management/base.html' %}
{% load static %}

{% block title %}Announcements — {{ course.title }}{% endblock %}
{% block breadcrumb %}Announcements{% endblock %}

{% block content %}

<!-- Page Header -->
<div class="flex items-center justify-between flex-wrap gap-4 mb-8">
    <div>
        <nav class="flex items-center space-x-2 text-sm text-gray-500 mb-2">
            <a href="{% url 'instructor:course_list' %}" class="hover:text-primary-600 transition-colors">Courses</a>
            <i class="fas fa-chevron-right text-xs"></i>
            <a href="{% url 'instructor:course_edit' course.slug %}" class="hover:text-primary-600 transition-colors">{{ course.title }}</a>
            <i class="fas fa-chevron-right text-xs"></i>
            <span class="text-gray-800 font-medium">Announcements</span>
        </nav>
        <h1 class="text-2xl font-bold text-gray-900">Announcements</h1>
        <p class="text-gray-500 mt-1 text-sm">Manage course announcements for <span class="font-medium text-gray-700">{{ course.title }}</span></p>
    </div>
    <a href="{% url 'instructor:announcement_create' course.slug %}"
       class="inline-flex items-center px-5 py-2.5 bg-primary-600 text-white text-sm font-semibold rounded-lg hover:bg-primary-700 shadow-sm hover:shadow-md transition-all">
        <i class="fas fa-plus mr-2"></i>New Announcement
    </a>
</div>

{% if announcements %}

<!-- Announcement Cards -->
<div class="space-y-4">
    {% for a in announcements %}
    <div class="bg-white rounded-xl border border-gray-200 shadow-sm hover:shadow-md transition-shadow overflow-hidden">

        <!-- Priority stripe -->
        <div class="h-1 w-full
            {% if a.priority == 'urgent' %}bg-red-500
            {% elif a.priority == 'high' %}bg-orange-400
            {% elif a.priority == 'normal' %}bg-primary-500
            {% else %}bg-gray-300{% endif %}"></div>

        <div class="p-5 md:p-6">
            <div class="flex items-start gap-4 flex-wrap">

                <!-- Icon -->
                <div class="flex-shrink-0 w-11 h-11 rounded-xl flex items-center justify-center
                    {% if a.priority == 'urgent' %}bg-red-100
                    {% elif a.priority == 'high' %}bg-orange-100
                    {% elif a.priority == 'normal' %}bg-blue-100
                    {% else %}bg-gray-100{% endif %}">
                    <i class="fas fa-bullhorn
                        {% if a.priority == 'urgent' %}text-red-600
                        {% elif a.priority == 'high' %}text-orange-500
                        {% elif a.priority == 'normal' %}text-blue-600
                        {% else %}text-gray-500{% endif %}"></i>
                </div>

                <!-- Body -->
                <div class="flex-1 min-w-0">
                    <div class="flex flex-wrap items-center gap-2 mb-1">
                        <h3 class="font-bold text-gray-900 text-base">{{ a.title }}</h3>

                        <!-- Priority badge -->
                        {% if a.priority == 'urgent' %}
                        <span class="px-2 py-0.5 rounded-full text-xs font-semibold bg-red-100 text-red-700">
                            <i class="fas fa-exclamation-circle mr-1"></i>Urgent
                        </span>
                        {% elif a.priority == 'high' %}
                        <span class="px-2 py-0.5 rounded-full text-xs font-semibold bg-orange-100 text-orange-700">
                            <i class="fas fa-arrow-up mr-1"></i>High
                        </span>
                        {% elif a.priority == 'normal' %}
                        <span class="px-2 py-0.5 rounded-full text-xs font-semibold bg-blue-100 text-blue-700">Normal</span>
                        {% else %}
                        <span class="px-2 py-0.5 rounded-full text-xs font-semibold bg-gray-100 text-gray-600">Low</span>
                        {% endif %}

                        <!-- Active / Expired -->
                        {% if a.is_expired %}
                        <span class="px-2 py-0.5 rounded-full text-xs font-semibold bg-gray-100 text-gray-500">
                            <i class="fas fa-clock mr-1"></i>Expired
                        </span>
                        {% elif a.is_active %}
                        <span class="px-2 py-0.5 rounded-full text-xs font-semibold bg-green-100 text-green-700">
                            <span class="inline-block w-1.5 h-1.5 rounded-full bg-green-500 mr-1"></span>Active
                        </span>
                        {% else %}
                        <span class="px-2 py-0.5 rounded-full text-xs font-semibold bg-gray-100 text-gray-500">Inactive</span>
                        {% endif %}
                    </div>

                    <p class="text-gray-600 text-sm mb-3 line-clamp-2">{{ a.content|truncatewords:35 }}</p>

                    <div class="flex flex-wrap gap-x-5 gap-y-1 text-xs text-gray-400">
                        <span><i class="fas fa-calendar mr-1"></i>Published: {{ a.publish_date|date:"M d, Y • H:i" }}</span>
                        {% if a.expiry_date %}
                        <span><i class="fas fa-hourglass-end mr-1"></i>Expires: {{ a.expiry_date|date:"M d, Y • H:i" }}</span>
                        {% else %}
                        <span class="text-green-600"><i class="fas fa-infinity mr-1"></i>No expiry</span>
                        {% endif %}
                    </div>
                </div>

                <!-- Actions -->
                <div class="flex items-center gap-2 flex-shrink-0 mt-1">
                    <a href="{% url 'instructor:announcement_edit' course.slug a.slug %}"
                       class="px-3.5 py-2 text-sm font-medium bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors">
                        <i class="fas fa-pen mr-1.5"></i>Edit
                    </a>
                    <button onclick="confirmDelete('{% url 'instructor:announcement_delete' course.slug a.slug %}', '{{ a.title|escapejs }}')"
                            class="px-3.5 py-2 text-sm font-medium bg-red-50 text-red-600 rounded-lg hover:bg-red-100 transition-colors">
                        <i class="fas fa-trash mr-1.5"></i>Delete
                    </button>
                </div>

            </div>
        </div>
    </div>
    {% endfor %}
</div>

<!-- Pagination -->
{% if announcements.has_other_pages %}
<div class="flex items-center justify-center gap-2 mt-8">
    {% if announcements.has_previous %}
    <a href="?page={{ announcements.previous_page_number }}"
       class="px-4 py-2 bg-white border border-gray-300 text-sm font-medium text-gray-700 rounded-lg hover:bg-gray-50 transition-colors">
        <i class="fas fa-chevron-left mr-1"></i>Previous
    </a>
    {% endif %}
    <span class="px-4 py-2 text-sm text-gray-500">
        Page {{ announcements.number }} of {{ announcements.paginator.num_pages }}
    </span>
    {% if announcements.has_next %}
    <a href="?page={{ announcements.next_page_number }}"
       class="px-4 py-2 bg-white border border-gray-300 text-sm font-medium text-gray-700 rounded-lg hover:bg-gray-50 transition-colors">
        Next<i class="fas fa-chevron-right ml-1"></i>
    </a>
    {% endif %}
</div>
{% endif %}

{% else %}

<!-- Empty state -->
<div class="bg-white rounded-xl border border-gray-200 shadow-sm p-16 text-center">
    <div class="w-20 h-20 bg-primary-100 rounded-full flex items-center justify-center mx-auto mb-5">
        <i class="fas fa-bullhorn text-4xl text-primary-500"></i>
    </div>
    <h3 class="text-xl font-bold text-gray-900 mb-2">No Announcements Yet</h3>
    <p class="text-gray-500 text-sm mb-6 max-w-sm mx-auto">Keep your students informed. Create your first announcement to get started.</p>
    <a href="{% url 'instructor:announcement_create' course.slug %}"
       class="inline-flex items-center px-5 py-2.5 bg-primary-600 text-white text-sm font-semibold rounded-lg hover:bg-primary-700 shadow-sm transition-all">
        <i class="fas fa-plus mr-2"></i>Create First Announcement
    </a>
</div>

{% endif %}

<!-- Hidden delete form -->
<form id="deleteForm" method="POST" class="hidden">{% csrf_token %}</form>

{% endblock %}

{% block extra_js %}
<script>
function confirmDelete(url, title) {
    Swal.fire({
        title: 'Delete Announcement?',
        html: `<p class="text-gray-600 text-sm">You are about to permanently delete <strong>"${title}"</strong>. Students will no longer see it.</p>`,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#dc2626',
        cancelButtonColor: '#6b7280',
        confirmButtonText: 'Yes, delete it',
        cancelButtonText: 'Cancel',
        customClass: { popup: 'rounded-xl' },
    }).then(result => {
        if (result.isConfirmed) {
            const form = document.getElementById('deleteForm');
            form.action = url;
            form.classList.remove('hidden');
            form.submit();
        }
    });
}
</script>
{% endblock %}