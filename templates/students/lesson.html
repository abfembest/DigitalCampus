{% extends "management/base.html" %}
{% load static %}

{% block title %}{{ page_title }} - MIU Student Portal{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto">
    <!-- Breadcrumb -->
    <div class="mb-4 flex items-center text-sm text-gray-600">
        <a href="{% url 'students:my_courses' %}" class="hover:text-primary-600">My Courses</a>
        <i class="fas fa-chevron-right mx-2 text-xs"></i>
        <a href="{% url 'students:course_detail' lesson.course.id %}" class="hover:text-primary-600">
            {{ lesson.course.title }}
        </a>
        <i class="fas fa-chevron-right mx-2 text-xs"></i>
        <span class="text-gray-900">{{ lesson.title }}</span>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
        <!-- Main Content -->
        <div class="lg:col-span-3 space-y-6">
            <!-- Lesson Content -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                <!-- Video Content -->
                {% if lesson.lesson_type == 'video' %}
                <div class="bg-black aspect-video">
                    {% if lesson.video_url %}
                        {% if 'youtube.com' in lesson.video_url or 'youtu.be' in lesson.video_url %}
                        <iframe class="w-full h-full" 
                                src="{{ lesson.video_url }}" 
                                frameborder="0" 
                                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                                allowfullscreen></iframe>
                        {% elif 'vimeo.com' in lesson.video_url %}
                        <iframe class="w-full h-full" 
                                src="{{ lesson.video_url }}" 
                                frameborder="0" 
                                allow="autoplay; fullscreen; picture-in-picture" 
                                allowfullscreen></iframe>
                        {% else %}
                        <video class="w-full h-full" controls>
                            <source src="{{ lesson.video_url }}" type="video/mp4">
                            Your browser does not support the video tag.
                        </video>
                        {% endif %}
                    {% else %}
                    <div class="w-full h-full flex items-center justify-center">
                        <div class="text-center text-white">
                            <i class="fas fa-video text-6xl mb-4 opacity-50"></i>
                            <p>Video content coming soon</p>
                        </div>
                    </div>
                    {% endif %}
                </div>
                {% endif %}

                <!-- Lesson Header -->
                <div class="p-6 border-b border-gray-200">
                    <div class="flex items-start justify-between">
                        <div class="flex-1">
                            <h1 class="text-2xl font-bold text-gray-900 mb-2">{{ lesson.title }}</h1>
                            {% if lesson.section %}
                            <p class="text-gray-600">{{ lesson.section.title }}</p>
                            {% endif %}
                        </div>
                        
                        <!-- Mark Complete Button -->
                        <button id="markCompleteBtn" 
                                data-lesson-id="{{ lesson.id }}"
                                class="px-6 py-3 {% if progress.is_completed %}bg-green-500 hover:bg-green-600{% else %}bg-primary-600 hover:bg-primary-700{% endif %} text-white rounded-lg transition-all font-medium">
                            <i class="fas {% if progress.is_completed %}fa-check-circle{% else %}fa-circle{% endif %} mr-2"></i>
                            <span>{% if progress.is_completed %}Completed{% else %}Mark as Complete{% endif %}</span>
                        </button>
                    </div>
                </div>

                <!-- Lesson Description -->
                {% if lesson.description %}
                <div class="p-6 border-b border-gray-200">
                    <h2 class="text-lg font-semibold text-gray-900 mb-3">Description</h2>
                    <div class="prose max-w-none text-gray-700">
                        {{ lesson.description|linebreaks }}
                    </div>
                </div>
                {% endif %}

                <!-- Text Content -->
                {% if lesson.lesson_type == 'text' and lesson.content %}
                <div class="p-6 border-b border-gray-200">
                    <div class="prose max-w-none">
                        {{ lesson.content|safe }}
                    </div>
                </div>
                {% endif %}

                <!-- File Download -->
                {% if lesson.file %}
                <div class="p-6">
                    <a href="{{ lesson.file.url }}" 
                       download
                       class="inline-flex items-center px-6 py-3 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-all font-medium">
                        <i class="fas fa-download mr-2"></i>
                        Download Course Material
                    </a>
                </div>
                {% endif %}
            </div>

            <!-- Navigation -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                <div class="flex items-center justify-between">
                    {% if prev_lesson %}
                    <a href="{% url 'students:lesson_view' prev_lesson.id %}" 
                       class="flex items-center px-6 py-3 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-all">
                        <i class="fas fa-chevron-left mr-2"></i>
                        Previous Lesson
                    </a>
                    {% else %}
                    <div></div>
                    {% endif %}

                    {% if next_lesson %}
                    <a href="{% url 'students:lesson_view' next_lesson.id %}" 
                       class="flex items-center px-6 py-3 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition-all">
                        Next Lesson
                        <i class="fas fa-chevron-right ml-2"></i>
                    </a>
                    {% else %}
                    <a href="{% url 'students:course_detail' lesson.course.id %}" 
                       class="flex items-center px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-all">
                        <i class="fas fa-check-circle mr-2"></i>
                        Course Complete
                    </a>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="space-y-6">
            <!-- Course Progress -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                <h3 class="font-semibold text-gray-900 mb-4">Course Progress</h3>
                <div class="mb-4">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-sm text-gray-600">Overall</span>
                        <span class="font-semibold text-gray-900">{{ enrollment.progress_percentage|floatformat:0 }}%</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-3">
                        <div class="bg-primary-600 h-3 rounded-full" 
                             style="width: {{ enrollment.progress_percentage }}%"></div>
                    </div>
                </div>
                <p class="text-sm text-gray-600">
                    {{ enrollment.completed_lessons }} of {{ lesson.course.lessons.count }} lessons completed
                </p>
            </div>

            <!-- Course Navigation -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                <div class="p-4 bg-gray-50 border-b border-gray-200">
                    <h3 class="font-semibold text-gray-900">Course Content</h3>
                </div>
                <div class="max-h-96 overflow-y-auto">
                    {% for section in lesson.course.sections.all %}
                    <div class="border-b border-gray-200">
                        <div class="p-3 bg-gray-50">
                            <p class="font-medium text-gray-900 text-sm">{{ section.title }}</p>
                        </div>
                        {% for course_lesson in section.lessons.all %}
                        <a href="{% url 'students:lesson_view' course_lesson.id %}" 
                           class="block p-3 hover:bg-gray-50 transition-all {% if course_lesson.id == lesson.id %}bg-blue-50 border-l-4 border-primary-600{% endif %}">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center flex-1">
                                    <i class="fas {% if course_lesson.lesson_type == 'video' %}fa-play-circle{% elif course_lesson.lesson_type == 'text' %}fa-file-alt{% else %}fa-file{% endif %} text-gray-400 mr-2 text-sm"></i>
                                    <span class="text-sm text-gray-700">{{ course_lesson.title }}</span>
                                </div>
                                <i class="fas fa-check-circle text-green-500 text-sm"></i>
                            </div>
                        </a>
                        {% endfor %}
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                <h3 class="font-semibold text-gray-900 mb-4">Quick Actions</h3>
                <div class="space-y-2">
                    <a href="{% url 'students:course_detail' lesson.course.id %}" 
                       class="block text-sm text-primary-600 hover:text-primary-700">
                        <i class="fas fa-book mr-2"></i> Course Overview
                    </a>
                    <a href="#" 
                       class="block text-sm text-primary-600 hover:text-primary-700">
                        <i class="fas fa-comment mr-2"></i> Ask a Question
                    </a>
                    <a href="#" 
                       class="block text-sm text-primary-600 hover:text-primary-700">
                        <i class="fas fa-bookmark mr-2"></i> Take Notes
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.getElementById('markCompleteBtn')?.addEventListener('click', async function() {
    const btn = this;
    const lessonId = btn.dataset.lessonId;
    
    try {
        const response = await fetch(`/students/lessons/${lessonId}/complete/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json'
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            btn.classList.remove('bg-primary-600', 'hover:bg-primary-700');
            btn.classList.add('bg-green-500', 'hover:bg-green-600');
            btn.querySelector('i').classList.remove('fa-circle');
            btn.querySelector('i').classList.add('fa-check-circle');
            btn.querySelector('span').textContent = 'Completed';
            
            // Show success message
            const message = document.createElement('div');
            message.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50';
            message.textContent = 'Lesson marked as complete!';
            document.body.appendChild(message);
            
            setTimeout(() => message.remove(), 3000);
        }
    } catch (error) {
        console.error('Error:', error);
    }
});
</script>
{% endblock %}