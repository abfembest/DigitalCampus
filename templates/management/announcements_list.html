{% extends 'management/base.html' %}
{% load static %}

{% block title %}Announcements - MIU Admin Portal{% endblock %}

{% block content %}
<div class="max-w-full">

  <!-- Header -->
  <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4 mb-8">
    <div>
      <h1 class="text-2xl md:text-3xl font-bold text-gray-800 font-display">Announcements</h1>
      <p class="text-gray-500 mt-1">System-wide, course, or category announcements</p>
    </div>
    <a href="{% url 'management:announcement_create' %}"
       class="inline-flex items-center gap-2 px-5 py-2.5 bg-primary-600 text-white rounded-lg hover:bg-primary-700 font-medium shadow-sm">
      <i class="fas fa-plus" aria-hidden="true"></i>New Announcement
    </a>
  </div>

  <!-- Filters -->
  <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-5 mb-6">
    <form method="get" class="flex flex-col sm:flex-row gap-3">
      <div class="flex-1">
        <input type="search" name="search" value="{{ request.GET.search }}"
               placeholder="Search announcementsâ€¦"
               class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 text-sm">
      </div>
      <div class="sm:w-44">
        <select name="type" class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 text-sm">
          <option value="">All Types</option>
          <option value="system" {% if request.GET.type == 'system' %}selected{% endif %}>System-wide</option>
          <option value="course" {% if request.GET.type == 'course' %}selected{% endif %}>Course-specific</option>
          <option value="category" {% if request.GET.type == 'category' %}selected{% endif %}>Category-specific</option>
        </select>
      </div>
      <div class="sm:w-40">
        <select name="priority" class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 text-sm">
          <option value="">All Priorities</option>
          <option value="urgent" {% if request.GET.priority == 'urgent' %}selected{% endif %}>Urgent</option>
          <option value="high" {% if request.GET.priority == 'high' %}selected{% endif %}>High</option>
          <option value="normal" {% if request.GET.priority == 'normal' %}selected{% endif %}>Normal</option>
          <option value="low" {% if request.GET.priority == 'low' %}selected{% endif %}>Low</option>
        </select>
      </div>
      <div class="flex gap-2">
        <button type="submit" class="px-4 py-2.5 bg-primary-600 text-white rounded-lg hover:bg-primary-700 text-sm font-medium">
          <i class="fas fa-search mr-1" aria-hidden="true"></i>Filter
        </button>
        <a href="{% url 'management:announcements_list' %}" class="px-3 py-2.5 border border-gray-300 text-gray-600 rounded-lg hover:bg-gray-50 text-sm">
          <i class="fas fa-redo" aria-hidden="true"></i>
        </a>
      </div>
    </form>
  </div>

  <!-- Announcements List -->
  <div class="space-y-4">
    {% for ann in announcements %}
    <div class="bg-white rounded-xl shadow-sm border border-gray-200 hover:shadow-md transition-shadow overflow-hidden">
      <div class="flex flex-col sm:flex-row">
        <!-- Priority Stripe -->
        <div class="sm:w-1.5 w-full h-1.5 sm:h-auto
          {% if ann.priority == 'urgent' %}bg-red-500
          {% elif ann.priority == 'high' %}bg-orange-500
          {% elif ann.priority == 'normal' %}bg-blue-500
          {% else %}bg-gray-300{% endif %}
          flex-shrink-0 rounded-l-xl"></div>

        <div class="p-5 flex-1 flex flex-col sm:flex-row sm:items-center gap-4">
          <div class="flex-1">
            <div class="flex flex-wrap items-center gap-2 mb-1.5">
              <h3 class="font-semibold text-gray-800">{{ ann.title }}</h3>
              <!-- Type badge -->
              {% if ann.announcement_type == 'system' %}
              <span class="px-2 py-0.5 bg-gray-100 text-gray-600 rounded text-xs">System</span>
              {% elif ann.announcement_type == 'course' %}
              <span class="px-2 py-0.5 bg-blue-100 text-blue-700 rounded text-xs">Course</span>
              {% else %}
              <span class="px-2 py-0.5 bg-purple-100 text-purple-700 rounded text-xs">Category</span>
              {% endif %}
              <!-- Priority badge -->
              {% if ann.priority == 'urgent' %}
              <span class="px-2 py-0.5 bg-red-100 text-red-700 rounded-full text-xs font-semibold">ðŸ”´ Urgent</span>
              {% elif ann.priority == 'high' %}
              <span class="px-2 py-0.5 bg-orange-100 text-orange-700 rounded-full text-xs font-medium">High</span>
              {% endif %}
              {% if ann.is_expired %}
              <span class="px-2 py-0.5 bg-red-50 text-red-500 border border-red-200 rounded text-xs">Expired</span>
              {% elif not ann.is_active %}
              <span class="px-2 py-0.5 bg-gray-50 text-gray-500 border border-gray-200 rounded text-xs">Inactive</span>
              {% endif %}
            </div>
            <p class="text-sm text-gray-500 line-clamp-2">{{ ann.content|truncatechars:140 }}</p>
            <div class="mt-2 text-xs text-gray-400">
              Published: {{ ann.publish_date|date:"M d, Y" }}
              {% if ann.expiry_date %} &nbsp;Â·&nbsp; Expires: {{ ann.expiry_date|date:"M d, Y" }}{% endif %}
              &nbsp;Â·&nbsp; By {{ ann.created_by.get_full_name|default:ann.created_by.username|default:"System" }}
            </div>
          </div>
          <div class="flex items-center gap-2 flex-shrink-0">
            <a href="{% url 'management:announcement_edit' ann.pk %}"
               class="p-2 text-blue-600 hover:bg-blue-50 rounded-lg transition-colors" title="Edit">
              <i class="fas fa-edit" aria-hidden="true"></i>
            </a>
            <button type="button"
                    onclick="confirmDelete('{% url 'management:announcement_delete' ann.pk %}', '{{ ann.title|escapejs }}')"
                    class="p-2 text-red-500 hover:bg-red-50 rounded-lg transition-colors" title="Delete">
              <i class="fas fa-trash-alt" aria-hidden="true"></i>
            </button>
          </div>
        </div>
      </div>
    </div>
    {% empty %}
    <div class="bg-white rounded-xl p-16 text-center shadow-sm border border-gray-200">
      <i class="fas fa-bullhorn text-5xl text-gray-300 mb-3 block" aria-hidden="true"></i>
      <p class="font-medium text-gray-600">No announcements yet</p>
      <a href="{% url 'management:announcement_create' %}" class="text-primary-600 text-sm hover:underline mt-1 inline-block">Create the first announcement</a>
    </div>
    {% endfor %}
  </div>

  <!-- Pagination -->
  {% if announcements.has_other_pages %}
  <div class="mt-6 flex flex-col sm:flex-row justify-between items-center gap-3 bg-white rounded-xl p-5 shadow-sm border border-gray-200">
    <p class="text-sm text-gray-500">Showing {{ announcements.start_index }}â€“{{ announcements.end_index }} of {{ announcements.paginator.count }}</p>
    <nav class="flex gap-1" aria-label="Pagination">
      {% if announcements.has_previous %}
      <a href="?page={{ announcements.previous_page_number }}{% for k,v in request.GET.items %}{% if k != 'page' %}&{{ k }}={{ v }}{% endif %}{% endfor %}"
         class="px-3 py-1.5 border border-gray-300 rounded-lg hover:bg-gray-50 text-sm">
        <i class="fas fa-chevron-left" aria-hidden="true"></i>
      </a>
      {% endif %}
      {% for num in announcements.paginator.page_range %}
        {% if announcements.number == num %}
        <span class="px-3 py-1.5 bg-primary-600 text-white rounded-lg text-sm font-medium">{{ num }}</span>
        {% elif num > announcements.number|add:"-3" and num < announcements.number|add:"3" %}
        <a href="?page={{ num }}{% for k,v in request.GET.items %}{% if k != 'page' %}&{{ k }}={{ v }}{% endif %}{% endfor %}"
           class="px-3 py-1.5 border border-gray-300 rounded-lg hover:bg-gray-50 text-sm">{{ num }}</a>
        {% endif %}
      {% endfor %}
      {% if announcements.has_next %}
      <a href="?page={{ announcements.next_page_number }}{% for k,v in request.GET.items %}{% if k != 'page' %}&{{ k }}={{ v }}{% endif %}{% endfor %}"
         class="px-3 py-1.5 border border-gray-300 rounded-lg hover:bg-gray-50 text-sm">
        <i class="fas fa-chevron-right" aria-hidden="true"></i>
      </a>
      {% endif %}
    </nav>
  </div>
  {% endif %}

</div>

<form id="deleteForm" method="post" action="" style="display:none;">{% csrf_token %}</form>
{% endblock %}

{% block extra_js %}
<script>
function confirmDelete(url, name) {
  Swal.fire({
    title: 'Delete Announcement?',
    html: `Delete <strong>${name}</strong>?`,
    icon: 'warning', showCancelButton: true,
    confirmButtonColor: '#ef4444', cancelButtonColor: '#6b7280',
    confirmButtonText: 'Delete',
  }).then(r => {
    if (r.isConfirmed) {
      document.getElementById('deleteForm').action = url;
      document.getElementById('deleteForm').submit();
    }
  });
}
</script>
{% endblock %}