{% extends "management/base.html" %}
{% load static humanize %}

{% block title %}My Payments — MIU Student Portal{% endblock %}

{% block meta_description %}
View and pay all outstanding university fees assigned to your faculty and department.
{% endblock %}

{% block content %}
<div class="max-w-12xl mx-auto px-4 sm:px-6 lg:px-8">

    <!-- ================================================================ -->
    <!-- Page Header                                                        -->
    <!-- ================================================================ -->
    <header class="mb-6 lg:mb-8">
        <div class="flex flex-col sm:flex-row sm:items-start sm:justify-between gap-3">
            <div>
                <!-- Breadcrumb -->
                <nav class="flex items-center gap-1.5 text-xs text-gray-400 mb-2">
                    <a href="{% url 'students:dashboard' %}"
                       class="hover:text-primary-600 transition-colors">
                        <i class="fas fa-home" aria-hidden="true"></i>
                        Dashboard
                    </a>
                    <i class="fas fa-chevron-right text-[10px]" aria-hidden="true"></i>
                    <span class="text-gray-600 font-medium">My Payments</span>
                </nav>
                <h1 class="text-2xl sm:text-3xl font-bold text-gray-900">
                    My Outstanding Fees
                </h1>
                <p class="text-sm sm:text-base text-gray-600 mt-1">
                    {{ request.user.profile.faculty.name|default:"—" }}
                    <span class="mx-1 text-gray-300">&bull;</span>
                    {{ request.user.profile.department.name|default:"—" }}
                </p>
            </div>

            <!-- Summary Badge -->
            <div class="flex-shrink-0 self-start sm:self-center">
                {% if outstanding_payments %}
                <div class="bg-red-50 border border-red-200 rounded-xl px-5 py-3 text-right">
                    <p class="text-xs font-medium text-red-500 uppercase tracking-wide">
                        Total Outstanding
                    </p>
                    <p class="text-2xl font-bold text-red-700 mt-0.5">
                        &#8358;{{ total_outstanding|floatformat:2|intcomma }}
                    </p>
                    <p class="text-xs text-red-400 mt-0.5">
                        {{ outstanding_payments|length }} item{{ outstanding_payments|length|pluralize }}
                    </p>
                </div>
                {% else %}
                <div class="inline-flex items-center gap-2 bg-green-50
                            border border-green-200 rounded-xl px-5 py-3">
                    <i class="fas fa-check-circle text-green-500 text-xl" aria-hidden="true"></i>
                    <div>
                        <p class="text-sm font-semibold text-green-700">All Clear!</p>
                        <p class="text-xs text-green-500">No outstanding fees</p>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </header>

    <!-- ================================================================ -->
    <!-- Summary Stat Cards                                                 -->
    <!-- ================================================================ -->
    <section class="grid grid-cols-2 lg:grid-cols-4 gap-4 sm:gap-6 mb-6 lg:mb-8"
             aria-label="Payment statistics">

        <!-- Outstanding Count -->
        <div class="bg-white rounded-xl shadow-sm p-4 sm:p-6 border border-gray-200">
            <div class="flex items-center justify-between">
                <div class="flex-1 min-w-0">
                    <p class="text-gray-500 text-xs sm:text-sm font-medium truncate">Outstanding</p>
                    <p class="text-2xl sm:text-3xl font-bold text-gray-900 mt-1 sm:mt-2">
                        {{ outstanding_payments|length }}
                    </p>
                </div>
                <div class="w-10 h-10 sm:w-12 sm:h-12 bg-red-100 rounded-lg
                            flex items-center justify-center flex-shrink-0 ml-2"
                     aria-hidden="true">
                    <i class="fas fa-file-invoice-dollar text-red-600 text-lg sm:text-xl"></i>
                </div>
            </div>
        </div>

        <!-- Total Amount Due -->
        <div class="bg-white rounded-xl shadow-sm p-4 sm:p-6 border border-gray-200">
            <div class="flex items-center justify-between">
                <div class="flex-1 min-w-0">
                    <p class="text-gray-500 text-xs sm:text-sm font-medium truncate">Amount Due</p>
                    <p class="text-xl sm:text-2xl font-bold text-red-600 mt-1 sm:mt-2">
                        &#8358;{{ total_outstanding|floatformat:0|intcomma }}
                    </p>
                </div>
                <div class="w-10 h-10 sm:w-12 sm:h-12 bg-orange-100 rounded-lg
                            flex items-center justify-center flex-shrink-0 ml-2"
                     aria-hidden="true">
                    <i class="fas fa-coins text-orange-600 text-lg sm:text-xl"></i>
                </div>
            </div>
        </div>

        <!-- Overdue Count — computed via template tag -->
        <div class="bg-white rounded-xl shadow-sm p-4 sm:p-6 border border-gray-200">
            <div class="flex items-center justify-between">
                <div class="flex-1 min-w-0">
                    <p class="text-gray-500 text-xs sm:text-sm font-medium truncate">Overdue</p>
                    <p class="text-2xl sm:text-3xl font-bold text-gray-900 mt-1 sm:mt-2"
                       id="overdueCount">—</p>
                </div>
                <div class="w-10 h-10 sm:w-12 sm:h-12 bg-yellow-100 rounded-lg
                            flex items-center justify-center flex-shrink-0 ml-2"
                     aria-hidden="true">
                    <i class="fas fa-clock text-yellow-600 text-lg sm:text-xl"></i>
                </div>
            </div>
        </div>

        <!-- Already Paid -->
        <div class="bg-white rounded-xl shadow-sm p-4 sm:p-6 border border-gray-200">
            <div class="flex items-center justify-between">
                <div class="flex-1 min-w-0">
                    <p class="text-gray-500 text-xs sm:text-sm font-medium truncate">Already Paid</p>
                    <p class="text-2xl sm:text-3xl font-bold text-gray-900 mt-1 sm:mt-2">
                        {{ paid_payments|length }}
                    </p>
                </div>
                <div class="w-10 h-10 sm:w-12 sm:h-12 bg-green-100 rounded-lg
                            flex items-center justify-center flex-shrink-0 ml-2"
                     aria-hidden="true">
                    <i class="fas fa-check-circle text-green-600 text-lg sm:text-xl"></i>
                </div>
            </div>
        </div>

    </section>

    <!-- ================================================================ -->
    <!-- Outstanding Payments Table                                         -->
    <!-- ================================================================ -->
    {% if outstanding_payments %}
    <section class="bg-white rounded-xl shadow-sm border border-gray-200 mb-6"
             aria-labelledby="outstanding-heading">

        <!-- Section Header -->
        <div class="p-4 sm:p-6 border-b border-gray-200
                    flex flex-col sm:flex-row justify-between
                    items-start sm:items-center gap-3">
            <h2 id="outstanding-heading"
                class="text-lg sm:text-xl font-bold text-gray-900 flex items-center gap-2">
                <i class="fas fa-exclamation-triangle text-amber-500" aria-hidden="true"></i>
                Outstanding Payments
            </h2>
            <span class="inline-flex items-center px-3 py-1 rounded-full
                         text-xs font-semibold bg-red-100 text-red-700">
                {{ outstanding_payments|length }} unpaid
            </span>
        </div>

        <!-- Desktop Table -->
        <div class="hidden sm:block overflow-x-auto">
            <table class="w-full text-sm">
                <thead>
                    <tr class="border-b border-gray-100 bg-gray-50">
                        <th class="text-left text-xs font-semibold text-gray-500
                                   uppercase tracking-wider px-6 py-3.5 w-12">#</th>
                        <th class="text-left text-xs font-semibold text-gray-500
                                   uppercase tracking-wider px-6 py-3.5">Purpose</th>
                        <th class="text-left text-xs font-semibold text-gray-500
                                   uppercase tracking-wider px-6 py-3.5">Faculty</th>
                        <th class="text-left text-xs font-semibold text-gray-500
                                   uppercase tracking-wider px-6 py-3.5">Department</th>
                        <th class="text-left text-xs font-semibold text-gray-500
                                   uppercase tracking-wider px-6 py-3.5">Amount</th>
                        <th class="text-left text-xs font-semibold text-gray-500
                                   uppercase tracking-wider px-6 py-3.5">Due Date</th>
                        <th class="text-left text-xs font-semibold text-gray-500
                                   uppercase tracking-wider px-6 py-3.5">Status</th>
                        <th class="text-left text-xs font-semibold text-gray-500
                                   uppercase tracking-wider px-6 py-3.5">Action</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-100">
                    {% for item in outstanding_payments %}
                    <tr class="hover:bg-gray-50 transition-colors
                               {% if item.is_overdue %}overdue-row bg-red-50/40{% endif %}">

                        <!-- # -->
                        <td class="px-6 py-4 text-gray-400 font-mono text-xs">
                            {{ forloop.counter }}
                        </td>

                        <!-- Purpose -->
                        <td class="px-6 py-4">
                            <div class="flex items-start gap-3">
                                <div class="w-8 h-8 flex-shrink-0 bg-primary-100 rounded-lg
                                            flex items-center justify-center mt-0.5"
                                     aria-hidden="true">
                                    <i class="fas fa-receipt text-primary-600 text-xs"></i>
                                </div>
                                <div>
                                    <p class="font-semibold text-gray-900 leading-tight">
                                        {{ item.payment.purpose }}
                                    </p>
                                    {% if item.payment.academic_year %}
                                    <p class="text-xs text-gray-400 mt-0.5">
                                        {{ item.payment.get_semester_display }}
                                        &bull; {{ item.payment.academic_year }}
                                    </p>
                                    {% endif %}
                                </div>
                            </div>
                        </td>

                        <!-- Faculty -->
                        <td class="px-6 py-4">
                            <p class="font-medium text-gray-900">
                                {{ item.payment.faculty.code }}
                            </p>
                            <p class="text-xs text-gray-400 truncate max-w-[140px]">
                                {{ item.payment.faculty.name }}
                            </p>
                        </td>

                        <!-- Department -->
                        <td class="px-6 py-4">
                            <p class="font-medium text-gray-900">
                                {{ item.payment.department.code }}
                            </p>
                            <p class="text-xs text-gray-400 truncate max-w-[140px]">
                                {{ item.payment.department.name }}
                            </p>
                        </td>

                        <!-- Amount -->
                        <td class="px-6 py-4">
                            <p class="text-base font-bold text-gray-900">
                                &#8358;{{ item.payment.amount|floatformat:2|intcomma }}
                            </p>
                        </td>

                        <!-- Due Date -->
                        <td class="px-6 py-4">
                            <p class="font-medium
                               {% if item.is_overdue %}text-red-600{% else %}text-gray-700{% endif %}">
                                {{ item.payment.due_date|date:"M d, Y" }}
                            </p>
                            {% if item.is_overdue %}
                            <p class="text-xs text-red-500 font-medium mt-0.5">
                                <i class="fas fa-clock mr-1" aria-hidden="true"></i>Overdue
                            </p>
                            {% else %}
                            <p class="text-xs text-gray-400 mt-0.5">
                                {{ item.payment.due_date|timeuntil }} left
                            </p>
                            {% endif %}
                        </td>

                        <!-- Status -->
                        <td class="px-6 py-4">
                            {% if item.is_overdue %}
                            <span class="inline-flex items-center gap-1.5 px-2.5 py-1
                                         rounded-full text-xs font-semibold
                                         bg-red-100 text-red-700">
                                <span class="w-1.5 h-1.5 rounded-full bg-red-500"></span>
                                Overdue
                            </span>
                            {% else %}
                            <span class="inline-flex items-center gap-1.5 px-2.5 py-1
                                         rounded-full text-xs font-semibold
                                         bg-amber-100 text-amber-700">
                                <span class="w-1.5 h-1.5 rounded-full bg-amber-500"></span>
                                Outstanding
                            </span>
                            {% endif %}
                        </td>

                        <!-- Action -->
                        <td class="px-6 py-4">
                            <a href="{% url 'students:my_payments' %}?pay={{ item.payment.pk }}"
                               class="inline-flex items-center gap-1.5 px-4 py-2
                                      bg-primary-600 hover:bg-primary-700
                                      text-white text-xs font-semibold
                                      rounded-lg transition-colors shadow-sm
                                      focus:outline-none focus:ring-2
                                      focus:ring-primary-500 focus:ring-offset-2">
                                <i class="fas fa-credit-card" aria-hidden="true"></i>
                                Pay Now
                            </a>
                        </td>

                    </tr>
                    {% endfor %}
                </tbody>

                <!-- Table Footer: total -->
                <tfoot>
                    <tr class="border-t-2 border-gray-200 bg-gray-50">
                        <td colspan="4"
                            class="px-6 py-4 text-sm font-semibold text-gray-600">
                            Total Outstanding
                        </td>
                        <td colspan="4" class="px-6 py-4">
                            <span class="text-xl font-bold text-red-700">
                                &#8358;{{ total_outstanding|floatformat:2|intcomma }}
                            </span>
                        </td>
                    </tr>
                </tfoot>
            </table>
        </div>

        <!-- Mobile Cards -->
        <div class="block sm:hidden divide-y divide-gray-100">
            {% for item in outstanding_payments %}
            <article class="p-4 {% if item.is_overdue %}bg-red-50/40 overdue-row{% endif %}">
                <div class="flex items-start justify-between gap-3 mb-3">
                    <div class="flex items-start gap-2.5 flex-1 min-w-0">
                        <div class="w-9 h-9 flex-shrink-0 bg-primary-100 rounded-lg
                                    flex items-center justify-center"
                             aria-hidden="true">
                            <i class="fas fa-receipt text-primary-600 text-sm"></i>
                        </div>
                        <div class="min-w-0">
                            <p class="font-semibold text-gray-900 text-sm leading-tight">
                                {{ item.payment.purpose }}
                            </p>
                            <p class="text-xs text-gray-400 mt-0.5 truncate">
                                {{ item.payment.faculty.code }} /
                                {{ item.payment.department.code }}
                            </p>
                        </div>
                    </div>
                    {% if item.is_overdue %}
                    <span class="flex-shrink-0 text-xs bg-red-100 text-red-700
                                 font-semibold px-2 py-0.5 rounded-full">
                        Overdue
                    </span>
                    {% else %}
                    <span class="flex-shrink-0 text-xs bg-amber-100 text-amber-700
                                 font-semibold px-2 py-0.5 rounded-full">
                        Outstanding
                    </span>
                    {% endif %}
                </div>
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-xl font-bold text-gray-900">
                            &#8358;{{ item.payment.amount|floatformat:2|intcomma }}
                        </p>
                        <p class="text-xs mt-0.5
                           {% if item.is_overdue %}text-red-500{% else %}text-gray-400{% endif %}">
                            Due: {{ item.payment.due_date|date:"M d, Y" }}
                        </p>
                    </div>
                    <a href="{% url 'students:my_payments' %}?pay={{ item.payment.pk }}"
                       class="inline-flex items-center gap-1.5 px-4 py-2
                              bg-primary-600 hover:bg-primary-700
                              text-white text-xs font-semibold
                              rounded-lg transition-colors shadow-sm">
                        <i class="fas fa-credit-card" aria-hidden="true"></i>
                        Pay Now
                    </a>
                </div>
            </article>
            {% endfor %}

            <!-- Mobile Total -->
            <div class="px-4 py-4 bg-gray-50 border-t border-gray-200
                        flex items-center justify-between">
                <span class="text-sm font-semibold text-gray-700">Total Outstanding</span>
                <span class="text-lg font-bold text-red-700">
                    &#8358;{{ total_outstanding|floatformat:2|intcomma }}
                </span>
            </div>
        </div>

    </section>

    {% else %}
    <!-- ================================================================ -->
    <!-- Empty State                                                        -->
    <!-- ================================================================ -->
    <section class="bg-white rounded-xl shadow-sm border border-gray-200
                    px-8 py-16 text-center mb-6">
        <div class="w-20 h-20 bg-green-100 rounded-full flex items-center
                    justify-center mx-auto mb-5"
             aria-hidden="true">
            <i class="fas fa-check-double text-green-500 text-3xl"></i>
        </div>
        <h2 class="text-xl font-bold text-gray-900 mb-2">
            You're all settled up!
        </h2>
        <p class="text-gray-500 text-sm max-w-sm mx-auto mb-6">
            You have no outstanding fees for your faculty and department.
            Keep up the great work!
        </p>
        <a href="{% url 'students:dashboard' %}"
           class="inline-flex items-center gap-2 px-5 py-2.5
                  bg-primary-600 hover:bg-primary-700 text-white
                  text-sm font-semibold rounded-lg transition-colors
                  focus:outline-none focus:ring-2
                  focus:ring-primary-500 focus:ring-offset-2">
            <i class="fas fa-arrow-left" aria-hidden="true"></i>
            Back to Dashboard
        </a>
    </section>
    {% endif %}

    <!-- ================================================================ -->
    <!-- Already Paid — Collapsible                                         -->
    <!-- ================================================================ -->
    {% if paid_payments %}
    <section class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">

        <button onclick="togglePaid()"
                aria-expanded="false"
                aria-controls="paidSection"
                class="w-full px-4 sm:px-6 py-4
                       flex items-center justify-between text-left
                       hover:bg-gray-50 transition-colors
                       focus:outline-none focus:ring-2 focus:ring-inset
                       focus:ring-primary-500">
            <h3 class="text-lg font-bold text-gray-900 flex items-center gap-2">
                <i class="fas fa-check-circle text-green-500" aria-hidden="true"></i>
                Paid Fees
                <span class="text-xs bg-green-100 text-green-700 font-semibold
                             px-2.5 py-0.5 rounded-full">
                    {{ paid_payments|length }}
                </span>
            </h3>
            <i id="paidChevron"
               class="fas fa-chevron-down text-gray-400 text-sm
                      transition-transform duration-200"
               aria-hidden="true"></i>
        </button>

        <div id="paidSection" class="hidden border-t border-gray-100">
            {% for item in paid_payments %}
            <div class="px-4 sm:px-6 py-3.5
                        flex items-center justify-between gap-4
                        {% if not forloop.last %}border-b border-gray-50{% endif %}
                        hover:bg-gray-50/60 transition-colors">
                <div class="flex items-center gap-3 min-w-0">
                    <div class="w-7 h-7 flex-shrink-0 rounded-full bg-green-100
                                flex items-center justify-center"
                         aria-hidden="true">
                        <i class="fas fa-check text-green-600 text-[10px]"></i>
                    </div>
                    <div class="min-w-0">
                        <p class="text-sm font-medium text-gray-700 truncate">
                            {{ item.purpose }}
                        </p>
                        <p class="text-xs text-gray-400">
                            {{ item.faculty.code }} / {{ item.department.code }}
                            {% if item.academic_year %}&bull; {{ item.academic_year }}{% endif %}
                        </p>
                    </div>
                </div>
                <div class="text-right flex-shrink-0">
                    <p class="text-sm font-bold text-gray-700">
                        &#8358;{{ item.amount|floatformat:2|intcomma }}
                    </p>
                    <span class="text-xs text-green-600 font-semibold">Paid</span>
                </div>
            </div>
            {% endfor %}
        </div>
    </section>
    {% endif %}

</div><!-- /container -->

{% block extra_js %}
<script>
    // Count overdue rows and populate the stat card
    document.addEventListener('DOMContentLoaded', function () {
        const overdueRows = document.querySelectorAll('.overdue-row');
        const el = document.getElementById('overdueCount');
        if (el) el.textContent = overdueRows.length;
    });

    function togglePaid() {
        const section  = document.getElementById('paidSection');
        const chevron  = document.getElementById('paidChevron');
        const btn      = chevron.closest('button');
        const isHidden = section.classList.contains('hidden');

        section.classList.toggle('hidden', !isHidden);
        chevron.style.transform = isHidden ? 'rotate(180deg)' : '';
        btn.setAttribute('aria-expanded', isHidden ? 'true' : 'false');
    }
</script>
{% endblock %}
{% endblock %}