{% extends 'management/base.html' %}
{% load static %}

{% block title %}{{ discussion.title }} — Discussion{% endblock %}
{% block breadcrumb %}Discussion{% endblock %}

{% block content %}

<!-- Breadcrumb -->
<nav class="flex items-center space-x-2 text-sm text-gray-500 mb-8 flex-wrap">
    <a href="{% url 'instructor:course_list' %}" class="hover:text-primary-600 transition-colors">Courses</a>
    <i class="fas fa-chevron-right text-xs"></i>
    <a href="{% url 'instructor:course_edit' course.slug %}" class="hover:text-primary-600 transition-colors">{{ course.title }}</a>
    <i class="fas fa-chevron-right text-xs"></i>
    <a href="{% url 'instructor:discussions' course.slug %}" class="hover:text-primary-600 transition-colors">Discussions</a>
    <i class="fas fa-chevron-right text-xs"></i>
    <span class="text-gray-800 font-medium truncate max-w-xs">{{ discussion.title }}</span>
</nav>

<div class="max-w-3xl">

    <!-- ===================== ORIGINAL POST ===================== -->
    <div class="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden mb-6
        {% if discussion.is_pinned %}border-l-4 border-l-primary-500{% endif %}">

        <!-- Post header -->
        <div class="px-6 py-4 border-b border-gray-100 bg-gray-50 flex items-center justify-between flex-wrap gap-3">
            <div class="flex flex-wrap items-center gap-2">
                <h1 class="text-lg font-bold text-gray-900">{{ discussion.title }}</h1>
                {% if discussion.is_pinned %}
                <span class="px-2 py-0.5 rounded text-xs font-semibold bg-primary-100 text-primary-700">
                    <i class="fas fa-thumbtack mr-1"></i>Pinned
                </span>
                {% endif %}
                {% if discussion.is_locked %}
                <span class="px-2 py-0.5 rounded text-xs font-semibold bg-orange-100 text-orange-700">
                    <i class="fas fa-lock mr-1"></i>Locked
                </span>
                {% endif %}
            </div>

            <!-- Instructor controls -->
            <div class="flex items-center gap-2">
                <form method="post" action="{% url 'instructor:discussion_toggle_pin' course.slug discussion.slug %}">
                    {% csrf_token %}
                    <button class="px-3 py-1.5 text-xs font-medium rounded-lg transition-colors
                        {% if discussion.is_pinned %}bg-primary-100 text-primary-700 hover:bg-primary-200{% else %}bg-gray-100 text-gray-600 hover:bg-gray-200{% endif %}">
                        <i class="fas fa-thumbtack mr-1"></i>{% if discussion.is_pinned %}Unpin{% else %}Pin{% endif %}
                    </button>
                </form>
                <form method="post" action="{% url 'instructor:discussion_toggle_lock' course.slug discussion.slug %}">
                    {% csrf_token %}
                    <button class="px-3 py-1.5 text-xs font-medium rounded-lg transition-colors
                        {% if discussion.is_locked %}bg-orange-100 text-orange-700 hover:bg-orange-200{% else %}bg-gray-100 text-gray-600 hover:bg-gray-200{% endif %}">
                        <i class="fas fa-{% if discussion.is_locked %}unlock{% else %}lock{% endif %} mr-1"></i>{% if discussion.is_locked %}Unlock{% else %}Lock{% endif %}
                    </button>
                </form>
                <button onclick="confirmDeleteDiscussion()"
                        class="px-3 py-1.5 text-xs font-medium bg-red-50 text-red-600 rounded-lg hover:bg-red-100 transition-colors">
                    <i class="fas fa-trash mr-1"></i>Delete
                </button>
            </div>
        </div>

        <!-- Post body -->
        <div class="p-6">
            <div class="flex items-start gap-4">
                <div class="flex-shrink-0 w-11 h-11 rounded-full bg-primary-100 flex items-center justify-center">
                    <span class="text-primary-700 font-bold text-sm">
                        {{ discussion.author.first_name|slice:":1"|upper }}{{ discussion.author.last_name|slice:":1"|upper }}
                    </span>
                </div>
                <div class="flex-1">
                    <div class="flex flex-wrap items-center gap-3 mb-3">
                        <span class="font-semibold text-gray-900">{{ discussion.author.get_full_name }}</span>
                        <span class="text-xs text-gray-400">{{ discussion.created_at|date:"M d, Y · H:i" }}</span>
                        <span class="text-xs text-gray-400"><i class="fas fa-eye mr-1"></i>{{ discussion.views_count }} views</span>
                    </div>
                    <p class="text-gray-800 text-sm leading-relaxed whitespace-pre-wrap">{{ discussion.content }}</p>
                </div>
            </div>
        </div>
    </div>

    <!-- ===================== REPLIES ===================== -->
    <h2 class="font-bold text-gray-900 mb-4 text-sm uppercase tracking-wide">
        <i class="fas fa-comments mr-2 text-gray-400"></i>
        {{ replies|length }} Repl{{ replies|length|pluralize:"y,ies" }}
    </h2>

    {% if replies %}
    <div class="space-y-3 mb-6">
        {% for reply in replies %}
        <div class="bg-white rounded-xl border shadow-sm overflow-hidden
            {% if reply.is_solution %}border-green-300{% else %}border-gray-200{% endif %}">

            {% if reply.is_solution %}
            <div class="px-5 py-2 bg-green-50 border-b border-green-200">
                <span class="text-xs font-semibold text-green-700">
                    <i class="fas fa-check-circle mr-1"></i>Marked as Solution
                </span>
            </div>
            {% endif %}

            <div class="p-5">
                <div class="flex items-start gap-3">
                    <div class="flex-shrink-0 w-9 h-9 rounded-full bg-gray-100 flex items-center justify-center">
                        <span class="text-gray-600 font-semibold text-xs">
                            {{ reply.author.first_name|slice:":1"|upper }}{{ reply.author.last_name|slice:":1"|upper }}
                        </span>
                    </div>
                    <div class="flex-1">
                        <div class="flex items-center justify-between flex-wrap gap-2 mb-2">
                            <div class="flex items-center gap-2">
                                <span class="text-sm font-semibold text-gray-900">{{ reply.author.get_full_name }}</span>
                                <span class="text-xs text-gray-400">{{ reply.created_at|date:"M d, Y · H:i" }}</span>
                            </div>
                            <!-- Reply controls -->
                            <div class="flex items-center gap-1.5">
                                <form method="post" action="{% url 'instructor:reply_toggle_solution' course.slug discussion.slug reply.id %}">
                                    {% csrf_token %}
                                    <button class="px-2.5 py-1 text-xs font-medium rounded-lg transition-colors
                                        {% if reply.is_solution %}bg-green-100 text-green-700 hover:bg-green-200{% else %}bg-gray-100 text-gray-600 hover:bg-gray-200{% endif %}">
                                        <i class="fas fa-check mr-1"></i>{% if reply.is_solution %}Unmark{% else %}Solution{% endif %}
                                    </button>
                                </form>
                                <form method="post" action="{% url 'instructor:reply_delete' course.slug discussion.slug reply.id %}">
                                    {% csrf_token %}
                                    <button class="px-2.5 py-1 text-xs font-medium bg-red-50 text-red-600 rounded-lg hover:bg-red-100 transition-colors">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </form>
                            </div>
                        </div>
                        <p class="text-sm text-gray-800 leading-relaxed whitespace-pre-wrap">{{ reply.content }}</p>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="bg-white rounded-xl border border-gray-200 shadow-sm py-10 text-center mb-6">
        <i class="fas fa-comment-slash text-3xl text-gray-200 mb-3"></i>
        <p class="text-gray-400 text-sm">No replies yet.</p>
    </div>
    {% endif %}

    <!-- ===================== INSTRUCTOR REPLY BOX ===================== -->
    {% if not discussion.is_locked %}
    <div class="bg-white rounded-xl border border-gray-200 shadow-sm p-5">
        <h3 class="text-sm font-semibold text-gray-700 mb-3">
            <i class="fas fa-reply mr-1.5 text-primary-500"></i>Add Instructor Reply
        </h3>
        <form method="post" action="{% url 'instructor:discussion_reply' course.slug discussion.slug %}">
            {% csrf_token %}
            <textarea name="content" rows="4" required
                      placeholder="Share your thoughts, clarify a concept, or guide the discussion…"
                      class="w-full px-4 py-3 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-colors resize-none"></textarea>
            <div class="flex justify-end mt-3">
                <button type="submit"
                        class="px-5 py-2.5 bg-primary-600 text-white text-sm font-semibold rounded-lg hover:bg-primary-700 shadow-sm transition-all">
                    <i class="fas fa-paper-plane mr-2"></i>Post Reply
                </button>
            </div>
        </form>
    </div>
    {% else %}
    <div class="bg-orange-50 border border-orange-200 rounded-xl p-5 text-center">
        <i class="fas fa-lock text-orange-400 text-2xl mb-2"></i>
        <p class="text-orange-800 text-sm font-medium">This discussion is locked — no new replies can be added.</p>
        <form method="post" action="{% url 'instructor:discussion_toggle_lock' course.slug discussion.slug %}" class="mt-3">
            {% csrf_token %}
            <button class="px-4 py-2 text-xs font-semibold bg-orange-100 text-orange-700 rounded-lg hover:bg-orange-200 transition-colors">
                <i class="fas fa-unlock mr-1.5"></i>Unlock Discussion
            </button>
        </form>
    </div>
    {% endif %}

</div>

<!-- Delete confirmation form -->
<form id="deleteDiscussionForm" method="POST"
      action="{% url 'instructor:discussion_delete' course.slug discussion.slug %}"
      class="hidden">{% csrf_token %}</form>

{% endblock %}

{% block extra_js %}
<script>
function confirmDeleteDiscussion() {
    Swal.fire({
        title: 'Delete Discussion?',
        html: '<p class="text-gray-600 text-sm">This will permanently delete the discussion and <strong>all its replies</strong>.</p>',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#dc2626',
        cancelButtonColor: '#6b7280',
        confirmButtonText: 'Yes, delete',
        cancelButtonText: 'Cancel',
        customClass: { popup: 'rounded-xl' },
    }).then(result => {
        if (result.isConfirmed) {
            document.getElementById('deleteDiscussionForm').submit();
        }
    });
}
</script>
{% endblock %}