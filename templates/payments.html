{% extends 'base.html' %}
{% load static %}

{% block title %}Complete Your Application Payments - Modern International University{% endblock %}

{% block content %}
<div class="bg-gray-50 min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-6xl">
        <!-- Header -->
        <header class="mb-8">
            <h1 class="text-3xl font-bold text-gray-800">Complete Your Application</h1>
            <p class="text-gray-600">Final step: Secure payment processing</p>
        </header>

        <div class="flex flex-col lg:flex-row gap-8">
            <!-- Left Column: Payment Form -->
            <div class="lg:w-2/3">
                <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                    <div class="flex items-center mb-6">
                        <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center mr-4">
                            <i class="fas fa-lock text-blue-600"></i>
                        </div>
                        <div>
                            <h2 class="text-xl font-semibold text-gray-800">Secure Payment Details</h2>
                            <p class="text-gray-600 text-sm">All transactions are encrypted and secure</p>
                        </div>
                    </div>

                    <!-- Payment Form -->
                    <form id="payment-form" class="space-y-6">
                        {% csrf_token %}

                        <!-- Stripe Card Element (PCI compliant) -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Card Information
                            </label>
                            <div id="stripe-card-element"
                                 class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-white">
                                <!-- Stripe.js will inject the iframe here -->
                            </div>
                            <div id="card-errors" class="text-red-500 text-sm mt-2"></div>
                        </div>

                        <!-- Cardholder Name -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Cardholder Name
                            </label>
                            <input type="text"
                                   id="cardholder-name"
                                   name="cardholder-name"
                                   placeholder="John Doe"
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
                                   autocomplete="cc-name" />
                            <div id="cardholder-error" class="text-red-500 text-sm mt-1 hidden"></div>
                        </div>

                        <!-- Terms and Conditions -->
                        <div class="flex items-start">
                            <input type="checkbox"
                                   id="terms"
                                   name="terms"
                                   class="mt-1 mr-3 h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded" />
                            <label for="terms" class="text-sm text-gray-600">
                                I authorize this charge and agree to the
                                <a href="#" class="text-blue-600 hover:text-blue-800">Terms of Service</a>
                                and
                                <a href="#" class="text-blue-600 hover:text-blue-800">Privacy Policy</a>.
                                I understand this payment is non-refundable.
                            </label>
                        </div>
                        <div id="terms-error" class="text-red-500 text-sm hidden"></div>

                        <!-- Payment Button -->
                        <button type="submit"
                                id="submit-payment"
                                class="w-full bg-blue-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                                disabled>
                            <span id="button-text">Pay Now</span>
                            <span id="button-spinner" class="hidden">
                                <i class="fas fa-spinner fa-spin ml-2"></i> Processing...
                            </span>
                        </button>

                        <!-- Security Notice -->
                        <div class="text-center pt-4 border-t border-gray-200">
                            <div class="flex items-center justify-center text-sm text-gray-500">
                                <i class="fas fa-shield-alt text-green-500 mr-2"></i>
                                <span>Your payment is secured with 256-bit SSL encryption</span>
                            </div>
                        </div>
                    </form>
                </div>

                <!-- Payment Status Messages -->
                <div id="payment-success" class="hidden bg-green-50 border border-green-200 rounded-xl p-6 mb-6">
                    <div class="flex items-center">
                        <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center mr-4">
                            <i class="fas fa-check text-green-600 text-xl"></i>
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold text-green-800">Payment Successful!</h3>
                            <p class="text-green-600">Your payment has been made successfully.</p>
                        </div>
                    </div>
                    <div class="mt-4">
                        <a href="/application_status/" class="inline-block bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 transition-colors">
                            Continue to Application Status
                        </a>
                    </div>
                </div>

                <div id="payment-error" class="hidden bg-red-50 border border-red-200 rounded-xl p-6">
                    <div class="flex items-center">
                        <div class="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center mr-4">
                            <i class="fas fa-exclamation-triangle text-red-600 text-xl"></i>
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold text-red-800">Payment Failed</h3>
                            <p id="error-message" class="text-red-600"></p>
                        </div>
                    </div>
                    <button onclick="resetPaymentForm()" class="mt-4 text-blue-600 hover:text-blue-800 font-medium">
                        Try Again
                    </button>
                </div>
            </div>

            <!-- Right Column: Payment Summary (unchanged, but ensure IDs exist) -->
            <div class="lg:w-1/3">
                <div class="bg-white rounded-xl shadow-lg p-6 sticky top-8">
                    <h2 class="text-xl font-semibold text-gray-800 mb-6">Payment Summary</h2>

                    <!-- Loading State -->
                    <div id="summary-loading" class="text-center py-8">
                        <i class="fas fa-spinner fa-spin text-blue-600 text-2xl mb-4"></i>
                        <p class="text-gray-600">Loading payment details...</p>
                    </div>

                    <!-- Summary Content -->
                    <div id="summary-content" class="hidden">
                        <!-- Application Details -->
                        <div class="mb-6">
                            <h3 class="font-medium text-gray-700 mb-2">Application Details</h3>
                            <div class="space-y-2">
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Applicant</span>
                                    <span id="summary-name" class="font-medium"></span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Application ID</span>
                                    <span id="summary-id" class="font-mono text-sm"></span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Service</span>
                                    <span>Processing Fee</span>
                                </div>
                            </div>
                        </div>

                        <!-- Amount Breakdown -->
                        <div class="border-t border-b border-gray-200 py-6 my-6">
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-gray-600">Subtotal</span>
                                <span id="summary-amount" class="text-lg font-semibold"></span>
                            </div>
                            <div class="flex justify-between text-sm text-gray-600">
                                <span>Tax</span>
                                <span>$0.00</span>
                            </div>
                        </div>

                        <!-- Total -->
                        <div class="mb-6">
                            <div class="flex justify-between items-center">
                                <span class="text-lg font-semibold text-gray-800">Total</span>
                                <span id="summary-total" class="text-2xl font-bold text-blue-600"></span>
                            </div>
                            <p class="text-sm text-gray-500 mt-1">USD • Payment processed by Stripe</p>
                        </div>

                        <!-- Security Features (unchanged) -->
                        <div class="bg-gray-50 rounded-lg p-4">
                            <h4 class="font-medium text-gray-700 mb-3">Security Features</h4>
                            <ul class="space-y-3">
                                <li class="flex items-center text-sm">
                                    <i class="fas fa-check text-green-500 mr-3"></i>
                                    <span>PCI DSS compliant</span>
                                </li>
                                <li class="flex items-center text-sm">
                                    <i class="fas fa-check text-green-500 mr-3"></i>
                                    <span>256-bit SSL encryption</span>
                                </li>
                                <li class="flex items-center text-sm">
                                    <i class="fas fa-check text-green-500 mr-3"></i>
                                    <span>No card data stored on our servers</span>
                                </li>
                                <li class="flex items-center text-sm">
                                    <i class="fas fa-check text-green-500 mr-3"></i>
                                    <span>3D Secure authentication</span>
                                </li>
                            </ul>
                        </div>

                        <!-- Help Section -->
                        <div class="mt-6 pt-6 border-t border-gray-200">
                            <div class="flex items-center text-gray-600">
                                <i class="fas fa-question-circle mr-3"></i>
                                <div>
                                    <p class="text-sm font-medium">Need help?</p>
                                    <p class="text-xs">contact support@moderninternational.edu</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Stripe.js (loaded once) -->
<script src="https://js.stripe.com/v3/"></script>

<script>
    (function () {
        /* ============================
           CONFIG & STATE
        ============================ */
        const config = {
            applicationId: new URLSearchParams(window.location.search).get('application_id'),
            summaryUrl: '/api/payment/summary/',
            createIntentUrl: '/create-intent/',
            confirmUrl: '/application/confirmation',   // ✅ fixed: removed trailing slash
            stripePublishableKey: null
        };

        const state = {
            paymentIntentClientSecret: null,
            paymentId: null,
            isLoading: false,
            stripe: null,
            cardElement: null,
            currency: 'USD' // default, will be updated from summary
        };

        /* ============================
           INIT
        ============================ */
        document.addEventListener('DOMContentLoaded', initializePaymentPage);

        async function initializePaymentPage() {
            try {
                await loadPaymentSummary();
                if (!config.stripePublishableKey) {
                    throw new Error('Stripe publishable key is missing. Please contact support.');
                }
                initializeStripe();
                setupEventListeners();
            } catch (err) {
                console.error('Initialization error:', err);
                showFatalError(err.message);
            }
        }

        /* ============================
           PAYMENT SUMMARY
        ============================ */
        async function loadPaymentSummary() {
            if (!config.applicationId) {
                throw new Error('Application ID is missing from the URL.');
            }

            const response = await fetch(`${config.summaryUrl}${config.applicationId}/`, {
                headers: { 'Accept': 'application/json' }
            });
            const data = await response.json();

            if (!data.success) {
                throw new Error(data.error || 'Failed to load payment summary.');
            }

            displaySummary(data.data);
        }

        function displaySummary(summary) {
            document.getElementById('summary-loading').classList.add('hidden');
            document.getElementById('summary-content').classList.remove('hidden');

            document.getElementById('summary-name').textContent = summary.full_name;
            document.getElementById('summary-id').textContent = summary.application_id.slice(0, 8);

            // Store currency from summary
            state.currency = summary.currency || 'USD';

            document.getElementById('summary-amount').textContent = formatCurrency(summary.amount, state.currency);
            document.getElementById('summary-total').textContent = formatCurrency(summary.amount, state.currency);

            config.stripePublishableKey = summary.stripe_public_key;
        }

        /* ============================
           STRIPE
        ============================ */
        function initializeStripe() {
            state.stripe = Stripe(config.stripePublishableKey);
            const elements = state.stripe.elements();

            state.cardElement = elements.create('card', {
                hidePostalCode: true,
                style: {
                    base: {
                        fontSize: '16px',
                        color: '#424770',
                        '::placeholder': { color: '#aab7c4' }
                    }
                }
            });
            state.cardElement.mount('#stripe-card-element');

            state.cardElement.on('change', function (event) {
                const displayError = document.getElementById('card-errors');
                displayError.textContent = event.error ? event.error.message : '';
            });
        }

        /* ============================
           EVENT LISTENERS
        ============================ */
        function setupEventListeners() {
            const form = document.getElementById('payment-form');
            const termsCheckbox = document.getElementById('terms');
            const submitButton = document.getElementById('submit-payment');
            const cardholderName = document.getElementById('cardholder-name');

            termsCheckbox.addEventListener('change', () => {
                submitButton.disabled = !termsCheckbox.checked || state.isLoading;
            });

            cardholderName.addEventListener('input', validateCardholderName);

            form.addEventListener('submit', handleFormSubmit);
        }

        /* ============================
           SUBMIT PAYMENT
        ============================ */
        async function handleFormSubmit(e) {
            e.preventDefault();

            // Basic validations
            if (!validateCardholderName()) return;
            if (!document.getElementById('terms').checked) {
                showTemporaryError('terms-error', 'You must agree to the terms.');
                return;
            }

            setLoading(true);

            try {
                // 1. Create PaymentIntent on the server (amount derived server‑side)
                const { clientSecret } = await createPaymentIntent();
                state.paymentIntentClientSecret = clientSecret;

                // 2. Confirm the payment with Stripe
                const { error, paymentIntent } = await state.stripe.confirmCardPayment(clientSecret, {
                    payment_method: {
                        card: state.cardElement,
                        billing_details: {
                            name: document.getElementById('cardholder-name').value.trim()
                        }
                    }
                });

                if (error) throw new Error(error.message);

                // 3. Notify backend of successful payment (idempotent)
                await handleSuccessfulPayment(paymentIntent.id);

            } catch (err) {
                console.error('Payment error:', err);
                showPaymentError(err.message);
                setLoading(false);
            }
        }

        /* ============================
           BACKEND CALLS
        ============================ */

        async function createPaymentIntent() {
            const response = await fetch(config.createIntentUrl, {
                method: 'POST',
                credentials: 'same-origin',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCsrfToken(),
                    'Accept': 'application/json'
                },
                body: JSON.stringify({
                    application_id: config.applicationId
                })
            });

            if (!response.ok) {
                const text = await response.text();
                throw new Error(text || 'Server error while creating payment.');
            }

            const data = await response.json();

            if (!data.success) {
                throw new Error(data.error || 'Failed to create payment.');
            }

            return { clientSecret: data.clientSecret };
        }

        async function handleSuccessfulPayment(paymentIntentId) {
            const response = await fetch(config.confirmUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCsrfToken()
                },
                body: JSON.stringify({ payment_intent_id: paymentIntentId })
            });
            const data = await response.json();

            if (!response.ok || !data.success) {
                throw new Error(data.error || 'Payment confirmation failed.');
            }

            showPaymentSuccess(data.payment_id);
            setLoading(false);
        }

        /* ============================
           UI HELPERS
        ============================ */
        function setLoading(isLoading) {
            state.isLoading = isLoading;
            const submitButton = document.getElementById('submit-payment');
            submitButton.disabled = isLoading || !document.getElementById('terms').checked;

            document.getElementById('button-text').classList.toggle('hidden', isLoading);
            document.getElementById('button-spinner').classList.toggle('hidden', !isLoading);
        }

        function showPaymentSuccess(paymentId) {
            document.getElementById('payment-form').classList.add('hidden');
            document.getElementById('payment-success').classList.remove('hidden');
            document.getElementById('payment-error').classList.add('hidden');

            const successLink = document.querySelector('#payment-success a');
            if (successLink) {
                if (paymentId) {
                    successLink.href = `/application/confirmation/?payment_id=${paymentId}`;
                } else {
                    successLink.href = '/application/confirmation/';
                }
            }
        }

        function showPaymentError(message) {
            document.getElementById('error-message').textContent = message;
            document.getElementById('payment-error').classList.remove('hidden');
            document.getElementById('payment-success').classList.add('hidden');
        }

        window.resetPaymentForm = function () {
            document.getElementById('payment-form').classList.remove('hidden');
            document.getElementById('payment-success').classList.add('hidden');
            document.getElementById('payment-error').classList.add('hidden');
            document.getElementById('terms-error').classList.add('hidden');
            if (state.cardElement) {
                state.cardElement.clear();
            }
            setLoading(false);
        };

        function showFatalError(message) {
            const formContainer = document.getElementById('payment-form');
            formContainer.innerHTML = `
                <div class="bg-red-50 border border-red-200 rounded-xl p-6 text-center">
                    <i class="fas fa-exclamation-triangle text-red-600 text-4xl mb-4"></i>
                    <h3 class="text-lg font-semibold text-red-800">System Error</h3>
                    <p class="text-red-600">${message}</p>
                    <p class="text-sm text-gray-500 mt-4">Please refresh the page or contact support.</p>
                </div>
            `;
        }

        function showTemporaryError(elementId, message) {
            const el = document.getElementById(elementId);
            if (el) {
                el.textContent = message;
                el.classList.remove('hidden');
                setTimeout(() => el.classList.add('hidden'), 5000);
            }
        }

        /* ============================
           VALIDATIONS
        ============================ */
        function validateCardholderName() {
            const input = document.getElementById('cardholder-name');
            const error = document.getElementById('cardholder-error');
            const value = input.value.trim();

            if (value.length < 2) {
                error.textContent = 'Enter the full name as it appears on the card.';
                error.classList.remove('hidden');
                return false;
            }
            error.classList.add('hidden');
            return true;
        }

        /* ============================
           GENERAL HELPERS
        ============================ */
        function formatCurrency(amount, currency = 'USD') {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: currency
            }).format(amount);
        }

        function getCsrfToken() {
            const token = document.querySelector('[name=csrfmiddlewaretoken]');
            return token ? token.value : '';
        }
    })();
</script>
{% endblock %}